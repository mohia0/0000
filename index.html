<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Freelancer CRM — One File (Light/Dark)</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#ffffff;
    --text:#0b0b0b;
    --muted:#6b7280;
    --panel:#ffffff;
    --panel-2:#f6f7fb;
    --line:#e5e7eb;
    --chip:#f3f4f6;
    --brand:#111111;
    --accent:#3b82f6;
    --ok:#059669;
    --warn:#b45309;
    --danger:#b91c1c;
    --radius:16px;
    --shadow:0 8px 28px rgba(0,0,0,.06);
    --rail-w:64px;
    --rail-gap:20px;
  }
  [data-theme="dark"]{
    --bg:#0b0c10;
    --text:#eceff4;
    --muted:#98a1b3;
    --panel:#0f1117;
    --panel-2:#141824;
    --line:#23283a;
    --chip:#171c2a;
    --brand:#e5e7eb;
    --accent:#60a5fa;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:14px/1.55 ui-sans-serif,-apple-system,Segoe UI,Inter,Roboto,Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .app{display:grid; grid-template-columns:var(--side,200px) 1fr; min-height:100vh}
  /* Sidebar */
  .side{position:sticky; top:0; height:100vh; background:var(--panel); border-right:1px solid var(--line); padding:18px 14px; display:flex; flex-direction:column; gap:12px}
  .side .resizer{position:absolute; top:0; right:-4px; width:12px; height:100%; cursor:ew-resize; background:transparent; z-index:50}
  .side:hover .resizer{background:linear-gradient(to right, transparent, color-mix(in oklab, var(--line) 60%, transparent), transparent)}
  .side.collapsed{padding-left:10px; padding-right:10px}
  .side.collapsed .brand strong{display:none}
  .side.collapsed .nav button{justify-content:center; font-size:0; padding:10px; gap:0}
  .side.collapsed .nav button svg{margin:0; width:22px; height:22px}
  .side.collapsed .mini{display:none}
  .brand{display:flex; align-items:center; gap:10px; padding:10px; border-radius:12px; border:1px solid var(--line); background:var(--panel-2)}
  .brand svg{width:18px;height:18px}
  .brand strong{font-size:14px; letter-spacing:.3px}
  .side.collapsed .brand{justify-content:center; gap:0}
  .side.collapsed .brand svg{width:22px;height:22px}
  .nav{display:flex; flex-direction:column; gap:6px}
  .nav button{
    display:flex; align-items:center; gap:10px; width:100%;
    padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:transparent; cursor:pointer; color:var(--text);
    transition:.15s ease;
  }
  .nav button:hover{background:var(--panel-2)}
  .nav button.active{background:var(--chip)}
  .nav svg{width:18px;height:18px}
  .iconbtn i,[data-feather],[data-lucide]{width:18px;height:18px; vertical-align:middle}
  .rail button i{width:18px;height:18px}
  .nav button svg{flex:0 0 auto}
  .nav button span{white-space:nowrap}
  .side .grow{flex:1}
  .mini{color:var(--muted); font-size:12px}
  /* Modern checkboxes for bulk selection */
  input[type="checkbox"]{ width:16px; height:16px; border-radius:6px; accent-color:var(--accent); cursor:pointer }
  /* Right floating rail like backup */
  .rail{
    position:fixed; 
    right:var(--rail-gap); 
    top:16px; 
    bottom:16px; 
    z-index:1000;
    width:var(--rail-w); 
    background:var(--panel); 
    border:1px solid var(--line); 
    border-radius:14px;
    box-shadow:var(--shadow); 
    padding:16px; 
    display:flex; 
    flex-direction:column; 
    justify-content:space-between;
  }
  
  /* Modern scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: var(--bg);
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb {
    background: var(--line);
    border-radius: 4px;
    transition: background 0.2s ease;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: var(--muted);
  }
  
  ::-webkit-scrollbar-corner {
    background: var(--bg);
  }
  
  /* Firefox scrollbar */
  * {
    scrollbar-width: thin;
    scrollbar-color: var(--line) var(--bg);
  }
  .main{padding:16px; padding-right:calc(16px + var(--rail-w) + var(--rail-gap)); display:grid; gap:12px}
  .rail-top{display:flex; justify-content:center; align-items:center; padding-bottom:16px}
  .rail-bottom{display:flex; flex-direction:column; gap:8px; align-items:center}
  .rail button{width:40px; height:40px; border-radius:8px; border:none; background:transparent; color:var(--text); cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .2s ease}
  .rail button:hover{background:var(--chip)}
  /* Header */
  .head{
    position:sticky; 
    top:0; 
    z-index:5; 
    background:var(--panel); 
    display:flex; 
    align-items:center; 
    justify-content:space-between; 
    padding:16px 24px; 
    padding-right:calc(24px + var(--rail-w) + var(--rail-gap));
    min-height:auto;
  }
  
  /* Header chips styling - super simple */
  .chip{
    display:inline-flex; 
    align-items:center; 
    gap:8px; 
    padding:6px 12px; 
    border-radius:6px; 
    background:var(--bg); 
    color:var(--text);
    font-size:13px;
  }
  
  /* Header input styling - super solid and light background */
  .head .chip input {
    background: var(--chip);
    border: none;
    padding: 6px 12px;
    font-size: 13px;
    color: var(--text);
    outline: none;
    transition: all 0.3s ease;
    border-radius: 6px;
    width: fit-content;
    min-width: 80px;
  }
  
  /* Header container with smooth scrolling */
  .head .flex {
    display: flex;
    align-items: center;
    gap: 16px;
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
    scroll-behavior: smooth;
    padding: 8px 0;
    /* Ensure search elements can break out */
    position: relative;
  }
  
  /* Ensure no parent containers constrain search */
  .head, .main, .page-container, .page {
    overflow: visible !important;
    clip: auto !important;
    clip-path: none !important;
    mask: none !important;
    -webkit-mask: none !important;
  }
  
  .head .flex::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
  }
  
  /* Chip transitions */
  .head .chip {
    transition: all 0.3s ease;
    white-space: nowrap;
    flex-shrink: 0;
  }
  
  .head .chip input:hover {
    background: var(--chip);
    transform: translateY(-1px);
  }
  
  .head .chip input:focus {
    background: var(--chip);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  /* Modern Currency Dropdown */
  .currency-dropdown {
    position: relative;
    display: inline-block;
    transition: all 0.3s ease;
  }
  
  .currency-toggle {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background: var(--chip);
    border: none;
    padding: 6px 12px;
    font-size: 13px;
    color: var(--text);
    cursor: pointer;
    outline: none;
    transition: all 0.2s ease;
    border-radius: 6px;
    min-width: 80px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }
  
  .currency-toggle:hover {
    background: var(--panel-2);
    transform: translateY(-1px);
  }
  
  .currency-arrow {
    width: 14px;
    height: 14px;
    transition: transform 0.2s ease;
  }
  
  .currency-dropdown.open .currency-arrow {
    transform: rotate(180deg);
  }
  
  .currency-menu {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg);
    border: 1px solid var(--line);
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    overflow: hidden;
    margin-top: 4px;
    animation: slideDown 0.2s ease;
    min-width: 100%;
  }
  
  .currency-option {
    padding: 10px 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 1px solid var(--line);
    font-size: 13px;
    color: var(--text);
  }
  
  .currency-option:last-child {
    border-bottom: none;
  }
  
  .currency-option:hover {
    background: var(--panel-2);
    transform: translateX(4px);
  }
  
  .currency-option:active {
    background: var(--accent);
    color: white;
  }
  
  /* Header button styling */
  .head .btn {
    padding:6px 12px;
    border-radius:6px;
    font-size:13px;
    font-weight:500;
  }
  .chip input{border:0; background:transparent; outline:none; font:inherit; color:var(--text)}
  
  /* Search Container Styling */
  .search-container {
    transition: all 0.3s ease;
    margin-right: auto;
    transform: translateX(0);
  }
  
  /* Center search bar on all pages except homepage */
  .search-container.centered {
    margin-right: 0;
    margin-left: auto;
    transform: translateX(0);
  }
  
  /* Smooth scroll behavior for header */
  .head {
    scroll-behavior: smooth;
  }
  
  .search-container input {
    transition: all 0.3s ease;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
    backdrop-filter: none;
    filter: none;
  }
  
  .search-container input:focus {
    background: var(--panel-2) !important;
    transform: scale(1.02);
    color: var(--text) !important;
    font-weight: 500;
  }
  
  .search-container input::placeholder {
    color: var(--muted);
    opacity: 0.8;
    font-weight: normal;
  }
  
  /* Disable browser autocomplete suggestions */
  .search-container input::-webkit-autofill,
  .search-container input::-webkit-autofill:hover,
  .search-container input::-webkit-autofill:focus,
  .search-container input::-webkit-autofill:active {
    -webkit-box-shadow: 0 0 0 30px var(--bg) inset !important;
    -webkit-text-fill-color: var(--text) !important;
  }
  
  /* Remove any browser dropdown suggestions */
  .search-container input::-webkit-calendar-picker-indicator {
    display: none !important;
  }
  
  /* Global Search Dropdown */
  .global-search-wrapper {
    position: relative;
    backdrop-filter: none;
    filter: none;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  .search-input-container {
    display: flex;
    align-items: center;
    position: relative;
  }
  
  .search-button {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    padding: 6px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    margin-left: 4px;
  }
  
  .search-button:hover {
    background: var(--panel-2);
    color: var(--text);
  }
  
  .search-button i {
    width: 16px;
    height: 16px;
  }

  /* History Panel Styles */
  .history-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--line);
    border-radius: 8px;
    margin-top: 16px;
  }

  .history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--line);
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .history-item:hover {
    background-color: var(--panel-2);
  }

  .history-item:last-child {
    border-bottom: none;
  }

  .history-info {
    flex: 1;
  }

  .history-time {
    font-weight: 500;
    color: var(--text);
    font-size: 14px;
  }

  .history-size {
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
  }

  .history-actions {
    display: flex;
    gap: 8px;
  }

  .history-controls {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 16px;
  }

  .autosave-toggle {
    display: flex;
    align-items: center;
    padding: 12px;
    background: var(--panel-2);
    border: 1px solid var(--line);
    border-radius: 8px;
  }

  .toggle-label {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    width: 100%;
  }

  .toggle-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--primary);
  }

  .toggle-text {
    font-size: 14px;
    color: var(--text);
    font-weight: 500;
  }

  .history-buttons {
    display: flex;
    gap: 8px;
  }

  .preview-content {
    background: var(--panel-2);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    max-height: 300px;
    overflow-y: auto;
  }

  .preview-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .version-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }

  .summary-item {
    background: var(--bg);
    border: 1px solid var(--line);
    border-radius: 6px;
    padding: 12px;
  }

  .summary-label {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 4px;
  }

  .summary-value {
    font-weight: 500;
    color: var(--text);
  }

  .loading {
    text-align: center;
    padding: 20px;
    color: var(--muted);
  }

  /* Modal Styles */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .modal-content {
    background: var(--bg);
    border: 1px solid var(--line);
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    max-width: 90vw;
    max-height: 90vh;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--line);
    background: var(--panel-2);
  }

  .modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }

  .close-btn {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-btn:hover {
    background: var(--panel-2);
    color: var(--text);
  }

  .close-btn i {
    width: 16px;
    height: 16px;
  }

  .modal-body {
    padding: 20px;
    overflow-y: auto;
  }
  
  .search-backdrop {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    background: rgba(0,0,0,0.1) !important;
    z-index: 999998 !important;
    backdrop-filter: blur(1px) !important;
    /* Force override any parent constraints */
    overflow: visible !important;
    clip: auto !important;
    clip-path: none !important;
    mask: none !important;
    -webkit-mask: none !important;
  }
  
  .global-search-results {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    width: 90vw !important;
    max-width: 600px !important;
    background: var(--bg) !important;
    border: 1px solid var(--line) !important;
    border-radius: 12px !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12) !important;
    z-index: 999999 !important;
    max-height: 400px !important;
    overflow: hidden !important;
    animation: slideDownSearch 0.3s ease !important;
    /* Force override any parent constraints */
    overflow: visible !important;
    clip: auto !important;
    clip-path: none !important;
    mask: none !important;
    -webkit-mask: none !important;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .global-search-results {
      width: 95vw;
      max-width: none;
      top: 70px;
      left: 2.5vw;
      transform: none;
    }
  }
  @keyframes slideDownSearch {
    from {
      opacity: 0;
      transform: translateY(-10px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  .search-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--line);
    background: var(--panel);
    font-weight: 600;
    font-size: 14px;
  }
  
  .close-search {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
  }
  
  .close-search:hover {
    background: var(--panel-2);
    color: var(--text);
  }
  
  .search-results-content {
    max-height: 320px;
    overflow-y: auto;
  }
  
  .search-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    color: var(--muted);
    text-align: center;
  }
  
  .search-placeholder i {
    font-size: 24px;
    margin-bottom: 8px;
    opacity: 0.5;
  }
  
  .search-result-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 1px solid var(--line);
  }
  
  .search-result-item:last-child {
    border-bottom: none;
  }
  
  .search-result-item:hover {
    background: var(--panel-2);
  }
  
  .search-result-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 14px;
  }
  
  .search-result-icon.contact {
    background: var(--accent);
    color: white;
  }
  
  .search-result-icon.proposal {
    background: #10b981;
    color: white;
  }
  
  .search-result-icon.invoice {
    background: #f59e0b;
    color: white;
  }
  
  .search-result-content {
    flex: 1;
  }
  
  .search-result-title {
    font-weight: 600;
    font-size: 14px;
    color: var(--text);
    margin-bottom: 2px;
  }
  
  .search-result-subtitle {
    font-size: 12px;
    color: var(--muted);
  }
  
  .search-result-meta {
    font-size: 11px;
    color: var(--muted);
    margin-top: 4px;
  }
  
  .search-section-header {
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: var(--panel);
    border-bottom: 1px solid var(--line);
  }
  
  .no-results {
    padding: 40px 20px;
    text-align: center;
    color: var(--muted);
  }
  
  .no-results i {
    font-size: 24px;
    margin-bottom: 8px;
    opacity: 0.5;
  }
  .btn{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; border:1px solid var(--line); background:var(--text); color:var(--bg); cursor:pointer}
  .btn.secondary{background:transparent; color:var(--text)}
  .btn.small{padding:6px 10px; border-radius:10px; font-size:12px}
  .btn.danger{background:#fff; color:#e11d48; border-color:#e11d48}
  /* Main */
  .main{padding:16px; padding-right:calc(16px + var(--rail-w) + var(--rail-gap)); display:grid; gap:12px}
  .grid{display:grid; gap:12px; grid-template-columns:repeat(12,1fr)}
  .card{background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); overflow:visible}
  .card h3{margin:0 0 8px 0; font-size:14px}
  .row{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
  .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
  .flex{display:flex; align-items:center; gap:8px}.justify-between{justify-content:space-between}
  /* Modern inputs */
  input[type="text"],input[type="email"],input[type="tel"],input[type="number"],input[type="date"],textarea,select{
    width:100%; background:var(--panel-2); color:var(--text); border:1px solid color-mix(in oklab, var(--line) 70%, transparent); border-radius:12px; padding:12px 14px; outline:none; box-shadow:none
  }
  input:hover, textarea:hover, select:hover{border-color:color-mix(in oklab, var(--line) 90%, transparent)}
  input::placeholder,textarea::placeholder{color:var(--muted)}
  input:focus,textarea:focus,select:focus{border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 20%, transparent)}
  textarea{min-height:110px; resize:vertical}
  /* Make global search wider */
  #globalSearch{
    min-width:260px; 
    width:clamp(260px,42vw,560px);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
    backdrop-filter: none !important;
    filter: none !important;
  }
  table{width:100%; border-collapse:collapse}
  th,td{text-align:left; padding:10px 8px; border-bottom:1px solid var(--line); vertical-align:top}
  th{font-weight:600}
  .list{border:1px solid var(--line); border-radius:12px; overflow:hidden; max-height:none}
  .list .rowi{display:grid; grid-template-columns:.2fr 1.1fr 1fr 1fr .8fr .6fr .3fr; gap:10px; padding:10px; border-bottom:1px solid var(--line)}
  .list.bulk-off .rowi{grid-template-columns:1.1fr 1fr 1fr .8fr .6fr .3fr}
  .list.bulk-off .rowi .bulk-col,.list.bulk-off .bulk-actions{display:none}
  
  /* Contacts specific grid layout */
  #contactsList .rowi{grid-template-columns:.2fr 1.1fr 1fr 1fr .8fr .6fr .3fr}
  #contactsList.bulk-off .rowi{grid-template-columns:1.1fr 1fr 1fr .8fr .6fr .3fr}
  
  /* Bulk column styling */
  .bulk-col{display:flex; align-items:center; justify-content:center}
  .bulk-actions{display:flex; gap:4px; align-items:center}
  
  /* Contact row hover effect */
  .rowi[onclick*="openContactModal"]:hover {
    background: var(--panel-2);
    transform: translateY(-1px);
    transition: all 0.2s ease;
  }
  
  /* Financial Dashboard Styling */
  .financial-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-top: 16px;
  }
  
  .financial-item {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
    transition: all 0.2s ease;
  }
  
  .financial-item:hover {
    background: var(--panel-2);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .financial-label {
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }
  
  .financial-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 4px;
  }
  
  .financial-amount {
    font-size: 14px;
    color: var(--accent);
    font-weight: 600;
  }
  .list .rowi:hover{background:var(--panel-2)}
  .list .rowi:last-child{border-bottom:none}
  .status{border-radius:999px; padding:4px 8px; font-size:12px; border:1px solid var(--line)}
  .status.draft{color:#6b7280}.status.sent{color:#1e40af}.status.accepted{color:#059669}.status.declined{color:#b91c1c}.status.paid{color:#059669}.status.overdue{color:#b91c1c}
  .tools{display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px}
  .tbtn{padding:6px 10px; border:1px solid var(--line); background:var(--chip); border-radius:10px; cursor:pointer}
  /* Document header (Proposal/Invoice) */
  .doc-header{display:grid; grid-template-columns:1fr 1fr 1fr; gap:24px; align-items:flex-start; margin:12px 0 16px}
  .doc-cell h4{margin:0 0 6px 0; font-size:14px}
  .doc-meta{justify-self:end; text-align:right}
  .doc-meta .big{font-size:22px; font-weight:700; letter-spacing:.5px}
  .doc-list{font-size:13px; line-height:1.6}
  .doc-list .muted{color:var(--muted)}
  
  /* editor styles removed */
  /* Number input: custom spinner */
  input[type=number]{ -moz-appearance:textfield }
  input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0 }
  .numwrap{ position:relative }
  .numwrap input[type=number]{ padding-right:28px }
  .numwrap .spin{ position:absolute; right:6px; top:50%; transform:translateY(-50%); display:flex; flex-direction:column }
  .numwrap .spin button{ width:18px; height:12px; border:1px solid var(--line); background:var(--panel); color:var(--muted); border-radius:4px; line-height:10px; padding:0; cursor:pointer }
  .numwrap .spin button+button{ margin-top:2px }
  /* Modal overlay clean style */
  #viewModal{position:fixed; inset:0; background:rgba(0,0,0,.2); display:flex; align-items:flex-start; justify-content:center; padding:40px}
  #viewModal[hidden]{display:none}

  /* Contact modal */
  #contactModal{position:fixed; inset:0; background:rgba(0,0,0,.25); display:flex; align-items:center; justify-content:center; padding:40px; z-index:9999}
  #contactModal[hidden]{display:none}
  .spark{width:100%; height:54px}
  
  /* Enhanced tab structure and spacing */
  .page{opacity:0; transform:perspective(1000px) rotateY(-4deg) translateX(-6px); transition:transform .3s ease, opacity .25s ease; display:none; width:100%}
  .page.active{opacity:1; transform:none; display:block}
  .page-container{position:relative; min-height:auto}
  
  /* Ensure pages take full width when active */
  .page.active{width:100%; min-height:auto}
  
  /* Better tab content organization */
  .tab-section{display:block; width:100%}
  
  /* Fix grid layout for all pages */
  .page .row{display:grid; grid-template-columns:repeat(12,1fr); gap:12px; margin-bottom:0}
  .page .col-5{grid-column:span 5}
  .page .col-6{grid-column:span 6}
  .page .col-7{grid-column:span 7}
  .page .col-8{grid-column:span 8}
  .page .col-12{grid-column:span 12}
  
  /* Better card spacing and structure */
  .card{margin-bottom:0}
  .card:last-child{margin-bottom:0}
  
  /* Fix spacing in forms and lists */
  .page .card{padding:16px}
  .page .row{margin-bottom:0}
  .page .row > div{margin-bottom:12px}
  .page .row > div:last-child{margin-bottom:0}
  
  /* Ensure proper table spacing */
  .page table{margin-top:16px}
  .page .list{margin-top:16px}
  
  /* Fix editor spacing */
  .page .editor{margin-top:16px}
  .page .tools{margin-bottom:16px}

  /* Proposal breakdown styles */
  #p_breakdown_wrap{margin-top:10px}
  #p_breakdown_table{width:100%; border-collapse:collapse}
  #p_breakdown_table th,#p_breakdown_table td{border:1px solid var(--line); padding:8px; font-size:13px}
  #p_breakdown_table input[type="text"], #p_breakdown_table input[type="number"]{width:100%}
  #p_breakdown_hint{margin-top:6px}

  /* Pricing prototype row */
  .prototype-row{border:2px dashed var(--line); border-radius:8px; padding:10px; text-align:center; color:var(--muted); cursor:pointer; margin-top:10px}
  .prototype-row:hover{background:var(--panel)}
  .qty-eye{margin-left:6px; background:transparent; border:none; cursor:pointer; color:var(--muted); padding:0}
  .qty-eye svg{width:16px; height:16px}
  .iconbtn.tiny{margin-right:5px}
  .iconbtn.tiny svg{width:14px; height:14px}
  .line-editor{min-height:80px; margin-top:8px; border:1px solid var(--line); background:var(--panel-2); border-radius:8px; padding:8px}
  /* Smaller toolbar icons in card headers */
  .card .flex .iconbtn svg{width:16px; height:16px}
  /* Inputs */
  .input-with-icon{position:relative}
  .input-with-icon{position:relative; display:inline-block}
  .input-with-icon i{position:absolute; right:12px; top:50%; transform:translateY(-50%); color:var(--muted); pointer-events:none; z-index:2}
  .input-with-icon input, .input-with-icon select{padding-right:32px; width:100%; box-sizing:border-box}
  .input-with-icon input[type="date"]{padding-right:12px; cursor:pointer}
  .input-with-icon input[type="date"]::-webkit-calendar-picker-indicator{width:20px; height:20px; cursor:pointer}

  /* Compact Title input - match header height */
  #p_title{height:42px; font-size:14px}
  select, input[type="date"], input[type="text"], input[type="number"]{height:40px; border-radius:8px; transition:all 0.2s ease}
  select:focus, input:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 2px rgba(var(--primary-rgb), 0.1)}
  input[type="date"]::-webkit-calendar-picker-indicator{cursor:pointer; opacity:0.7; transition:opacity 0.2s ease}
  input[type="date"]::-webkit-calendar-picker-indicator:hover{opacity:1}
  
  /* Modern proposal header */
  .proposal-header{display:grid; grid-template-columns:2fr 1fr; gap:20px; margin-bottom:24px; align-items:end}
  .proposal-header .field{display:flex; flex-direction:column; gap:6px}
  .proposal-header .field:first-child{grid-column:1 / -1}
  .proposal-header label{font-size:11px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:0.8px}
  .proposal-header input, .proposal-header select{width:100%; height:42px; font-size:14px}
  @media (max-width: 900px){
    .proposal-header{grid-template-columns:1fr}
  }
  
  /* Improved tab navigation */
  .nav button{position:relative; overflow:hidden}
  .nav button::after{content:''; position:absolute; bottom:0; left:0; width:0; height:2px; background:var(--brand); transition:width .3s ease}
  .nav button.active::after{width:100%}
  
  /* Enhanced visual separation - reduced spacing */
  .tab-section{margin-bottom:16px}
  .tab-section:last-child{margin-bottom:0}
  /* Better responsive grid */
  .responsive-grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr))}
  
  /* Enhanced tab content spacing */
  .page > .tab-section:first-child{margin-top:0}
  .page > .tab-section:last-child{margin-bottom:0}
  
  /* Improved card shadows and borders */
  .card{transition:box-shadow 0.2s ease, transform 0.1s ease}
  .card:hover{box-shadow:0 12px 32px rgba(0,0,0,0.1); transform:translateY(-1px)}
  
  /* Better form spacing */
  .row > div{margin-bottom:12px}
  .row > div:last-child{margin-bottom:0}
  
  /* Enhanced navigation active state */
  .nav button.active{background:var(--chip); border-color:var(--brand)}
  
  /* Improved page transitions */
  .page{will-change:opacity, transform}
  
  /* Fix for nested cards in home page */
  .page .card .card{padding:16px; margin:0}
  
  /* Ensure consistent spacing across all tabs - reduced padding */
  .page{min-height:auto; padding-bottom:16px}
  
  /* Better mobile responsiveness */
  @media (max-width:768px){
    .tab-section{margin-bottom:12px}
    .card{padding:12px}
    .row{gap:8px}
  }
  /* Print */
  @media print{
    .side,.rail,.head,.noprint{display:none !important}
    .card{box-shadow:none; border:0; padding:0}
    body{background:#fff; color:#000}
  }
  @media (max-width:980px){
    .app{grid-template-columns:1fr}
    .side{height:auto; position:relative}
    .rail{display:none}
    .head, .main { padding-right:0 }
    .row{grid-template-columns:1fr}
    .grid{grid-template-columns:1fr}
  }
  /* Better responsive behavior */
  @media (max-width:768px){
    .page .row{grid-template-columns:1fr; gap:12px}
    .page .col-5, .page .col-6, .page .col-7, .page .col-8{grid-column:span 12}
  }
  /* Settings page minimal look */
  .settings-page .card{background:transparent; box-shadow:none; border-style:dashed; padding:12px}
  .settings-page .card h3{font-size:13px; margin:0 0 8px 0}
  .settings-page .row > div{margin-bottom:8px}
  #fxManual input{padding:8px 10px; font-size:13px}
  #fxRates, #fxMeta{line-height:1.4}
  .settings-page .mini{opacity:.8}
  /* Standardize all icons to match navbar size */
  .iconbtn i,[data-feather],[data-lucide],.rail button i,.btn i{width:18px;height:18px; vertical-align:middle}
  
  /* Modern form elements */
  select, input[type="date"], input[type="number"] {
    appearance: none;
    background: var(--bg);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 14px;
    color: var(--text);
    transition: all 0.2s ease;
  }
  
  select:hover, input[type="date"]:hover, input[type="number"]:hover {
    border-color: var(--accent);
  }
  
  select:focus, input[type="date"]:focus, input[type="number"]:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  /* Modern dropdown arrow */
  select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 8px center;
    background-repeat: no-repeat;
    background-size: 16px;
    padding-right: 32px;
    width: fit-content;
    min-width: 80px;
  }
  
  /* Modern date input */
  input[type="date"]::-webkit-calendar-picker-indicator {
    background: transparent;
    color: transparent;
    cursor: pointer;
    height: 20px;
    width: 20px;
    margin-left: -20px;
  }
  
  input[type="date"]::-webkit-datetime-edit {
    color: var(--text);
  }
  

  
  /* Modern year navigator */
  .year-navigator {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--chip);
    border-radius: 6px;
    padding: 4px;
    transition: all 0.3s ease;
  }
  
  .year-nav-btn {
    background: transparent;
    border: none;
    color: var(--text);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .year-nav-btn:hover {
    background: var(--panel);
    transform: scale(1.1);
  }
  
  .year-nav-btn:active {
    transform: scale(0.95);
  }
  
  .year-navigator span {
    background: var(--bg);
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 13px;
    color: var(--text);
    min-width: 60px;
    text-align: center;
    font-weight: 500;
  }
  
  /* Apply awesome scrollbar to all scrollable elements */
  .list, .chart-container, .year-dropdown {
    scrollbar-width: thin;
    scrollbar-color: var(--line) var(--bg);
  }
  
  .list::-webkit-scrollbar, 
  .chart-container::-webkit-scrollbar, 
  .year-dropdown::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  .list::-webkit-scrollbar-track, 
  .chart-container::-webkit-scrollbar-track, 
  .year-dropdown::-webkit-scrollbar-track {
    background: var(--bg);
    border-radius: 4px;
  }
  .list::-webkit-scrollbar-thumb, 
  .chart-container::-webkit-scrollbar-thumb, 
  .year-dropdown::-webkit-scrollbar-thumb {
    background: var(--line);
    border-radius: 4px;
    transition: background 0.2s ease;
  }
  
  .list::-webkit-scrollbar-thumb:hover, 
  .chart-container::-webkit-scrollbar-thumb:hover, 
  .year-dropdown::-webkit-scrollbar-thumb:hover {
    background: var(--muted);
  }
  
  .list::-webkit-scrollbar-corner, 
  .chart-container::-webkit-scrollbar-corner, 
  .year-dropdown::-webkit-scrollbar-corner {
    background: var(--bg);
  }
  
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .year-option {
    padding: 10px 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 1px solid var(--line);
    font-size: 13px;
  }
  
  .year-option:last-child {
    border-bottom: none;
  }
  
  .year-option:hover {
    background-color: var(--panel);
    transform: translateX(4px);
  }
  
  .year-option:active {
    background-color: var(--accent);
    color: white;
  }
  
  /* Ensure modals are above sidebar */
  #viewModal, #historyModal, #contactModal {
    z-index: 9999;
  }
  

  
  /* Chart Containers */
  .chart-container {
    margin-top: 16px;
    padding: 16px;
    background: var(--bg);
    border-radius: 8px;
    border: 1px solid var(--line);
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .chart-container canvas {
    max-width: 100%;
    height: auto;
  }
  
  /* Theme Toggle Styling */
  .theme-toggle-container {
    margin-top: 12px;
    display: flex;
    justify-content: center;
  }
  
  .theme-toggle {
    width: 36px;
    height: 60px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    position: relative;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .toggle-track {
    width: 36px;
    height: 60px;
    background: var(--line);
    border-radius: 18px;
    position: relative;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
  }
  
  .toggle-track::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .toggle-thumb {
    width: 28px;
    height: 28px;
    background: var(--bg);
    border-radius: 50%;
    position: absolute;
    top: 3px;
    left: 4px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  .sun-icon, .moon-icon {
    width: 16px;
    height: 16px;
    color: var(--text);
    transition: all 0.3s ease;
    position: absolute;
  }
  
  .sun-icon {
    opacity: 1;
    transform: scale(1);
  }
  
  .moon-icon {
    opacity: 0;
    transform: scale(0.5);
  }
  
  /* Dark theme state */
  [data-theme="dark"] .toggle-track::before {
    opacity: 1;
  }
  
  [data-theme="dark"] .toggle-thumb {
    top: 29px;
    background: var(--text);
  }
  
  [data-theme="dark"] .sun-icon {
    opacity: 0;
    transform: scale(0.5);
  }
  
  [data-theme="dark"] .moon-icon {
    opacity: 1;
    transform: scale(1);
    color: var(--bg);
  }
  
  /* Hover effects */
  .theme-toggle:hover .toggle-track {
    transform: scale(1.05);
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  }
  
  .theme-toggle:hover .toggle-thumb {
    transform: scale(1.1);
  }
  
  /* Active state */
  .theme-toggle:active .toggle-thumb {
    transform: scale(0.95);
  }
  
  /* Focus state */
  .theme-toggle:focus {
    outline: none;
  }
  
  .theme-toggle:focus .toggle-track {
    box-shadow: 0 0 0 3px var(--accent);
  }

  /* ===== Docs Editor Styles ===== */
  .blocknote-editor {
    min-height: 400px;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    background: white;
    position: relative;
  }

  .blocknote-editor .ProseMirror {
    outline: none;
    min-height: 400px;
  }

  .blocknote-editor .ProseMirror p {
    margin: 8px 0;
    line-height: 1.6;
  }

  .blocknote-editor .ProseMirror h1,
  .blocknote-editor .ProseMirror h2,
  .blocknote-editor .ProseMirror h3 {
    margin: 16px 0 8px 0;
    font-weight: 600;
  }

  .blocknote-editor .ProseMirror h1 { font-size: 24px; }
  .blocknote-editor .ProseMirror h2 { font-size: 20px; }
  .blocknote-editor .ProseMirror h3 { font-size: 18px; }

  .blocknote-editor .ProseMirror ul,
  .blocknote-editor .ProseMirror ol {
    margin: 8px 0;
    padding-left: 24px;
  }

  .blocknote-editor .ProseMirror blockquote {
    border-left: 4px solid var(--accent);
    margin: 16px 0;
    padding: 8px 16px;
    background: var(--bg-secondary);
    font-style: italic;
  }

  .blocknote-editor .ProseMirror pre {
    background: var(--bg-secondary);
    padding: 12px;
    border-radius: 4px;
    overflow-x: auto;
    font-family: monospace;
  }

  .blocknote-editor .ProseMirror hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 16px 0;
  }

  .editor-toolbar {
    display: flex;
    gap: 4px;
    padding: 8px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-secondary);
    border-radius: 8px 8px 0 0;
  }

  .tbtn {
    padding: 6px 12px;
    border: 1px solid var(--border);
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
  }
  
  .tbtn:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  
  .tbtn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  
  /* BlockNote floating menus */
.bn-float-menu {
    background: white;
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 1000;
  display: block !important;
}
  
  /* Modern Editor Styling */
  .page .editor {
    border: 2px solid var(--line);
    border-radius: 12px;
    background: white;
    overflow: hidden;
    transition: all 0.2s ease;
  }
  
  .page .editor:hover {
    border-color: var(--accent);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .page .editor:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  /* Editor content area styling */
  .page .editor .blocknote-editor,
  .page .editor .codex-editor {
    border: none;
    border-radius: 0;
    background: transparent;
  }
  
  /* Ensure editor content has proper padding */
  .page .editor .ProseMirror,
  .page .editor .codex-editor__redactor {
    padding: 20px;
    min-height: 200px;
  }
  
  /* Docs title input styling */
  #docsTitle {
    width: 100%;
    height: 44px;
    font-size: 16px;
    font-weight: 600;
    border: none;
    border-bottom: 2px solid var(--line);
    background: transparent;
    padding: 8px 0;
    outline: none;
    transition: all 0.2s ease;
  }
  
  #docsTitle:focus {
    border-bottom-color: var(--accent);
  }
  
  #docsTitle::placeholder {
    color: var(--muted);
    font-weight: normal;
  }

.bn-suggest {
  background: white;
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 1000;
  display: block !important;
}

/* Ensure BlockNote editor is visible */
.ProseMirror {
  min-height: 400px !important;
  outline: none !important;
  padding: 16px !important;
  background: white !important;
  color: var(--text-primary) !important;
}

/* BlockNote container visibility */
.bn-container {
  display: block !important;
  visibility: visible !important;
}

/* Force BlockNote elements to be visible */
.bn-float-menu,
.bn-suggest,
.bn-side-menu,
.bn-formatting-toolbar {
  opacity: 1 !important;
  visibility: visible !important;
  display: block !important;
  background: white !important;
  color: black !important;
  border: 1px solid #ddd !important;
  border-radius: 8px !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
  z-index: 10000 !important;
}

/* BlockNote Editor Styling */
.bn-container {
  font-family: inherit !important;
}

.bn-container .ProseMirror {
  outline: none !important;
  min-height: 400px !important;
  padding: 16px !important;
  line-height: 1.6 !important;
}

.bn-container .ProseMirror p {
  margin: 8px 0 !important;
}

.bn-container .ProseMirror h1,
.bn-container .ProseMirror h2,
.bn-container .ProseMirror h3 {
  margin: 16px 0 8px 0 !important;
  font-weight: 600 !important;
}

.bn-container .ProseMirror h1 { font-size: 24px !important; }
.bn-container .ProseMirror h2 { font-size: 20px !important; }
.bn-container .ProseMirror h3 { font-size: 18px !important; }

.bn-container .ProseMirror ul,
.bn-container .ProseMirror ol {
  margin: 8px 0 !important;
  padding-left: 24px !important;
}

.bn-container .ProseMirror blockquote {
  border-left: 4px solid var(--accent) !important;
  margin: 16px 0 !important;
  padding: 8px 16px !important;
  background: var(--bg-secondary) !important;
  font-style: italic !important;
}

.bn-container .ProseMirror pre {
  background: var(--bg-secondary) !important;
  padding: 12px !important;
  border-radius: 4px !important;
  overflow-x: auto !important;
  font-family: monospace !important;
}

.bn-container .ProseMirror hr {
  border: none !important;
  border-top: 1px solid var(--border) !important;
  margin: 16px 0 !important;
}

/* Fallback Editor Button Visibility */
.fallback-toolbar button {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
  border: 1px solid var(--border) !important;
  background: white !important;
  color: var(--text-primary) !important;
  padding: 6px 12px !important;
  border-radius: 4px !important;
  cursor: pointer !important;
  font-size: 12px !important;
  font-weight: 500 !important;
  min-width: 40px !important;
  height: 32px !important;
  align-items: center !important;
  justify-content: center !important;
  transition: all 0.2s !important;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
}

.fallback-toolbar button:hover {
  background: var(--accent) !important;
  color: white !important;
  border-color: var(--accent) !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15) !important;
}

.fallback-toolbar button:active {
  transform: translateY(0) !important;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
}

  /* Docs list styling */
  #docsList .history-item {
    cursor: pointer;
    padding: 12px;
    border-bottom: 1px solid var(--border);
    transition: background 0.2s;
  }

  #docsList .history-item:hover {
    background: var(--bg-secondary);
  }

  #docsList .history-item:last-child {
    border-bottom: none;
  }

  /* Full page editor layout */
  #route-doc .card {
    min-height: 80vh;
  }

  #route-doc .editor {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  #docs_editor {
    flex: 1;
    min-height: 500px;
  }

  /* Input styling */
  #docsTitle {
    font-size: 18px;
    font-weight: 600;
    border: none;
    background: transparent;
    width: 100%;
    padding: 8px 0;
    border-bottom: 2px solid transparent;
    transition: border-color 0.2s;
  }

  #docsTitle:focus {
    outline: none;
    border-bottom-color: var(--accent);
  }

  #docsTitle::placeholder {
    color: var(--text-secondary);
  }

  /* Status hint */
  #docsHint {
    margin-top: 8px;
    padding: 4px 8px;
    background: var(--bg-secondary);
    border-radius: 4px;
    font-size: 12px;
    color: var(--text-secondary);
  }

  /* Responsive */
  @media (max-width: 768px) {
    #route-doc .card {
      min-height: 70vh;
    }
    
    #docs_editor {
      min-height: 400px;
    }
  }

  /* Dark theme support */
  [data-theme="dark"] .blocknote-editor {
    background: var(--bg-primary);
    border-color: var(--border);
  }

  [data-theme="dark"] .blocknote-editor .ProseMirror {
    color: var(--text-primary);
  }

  [data-theme="dark"] .tbtn {
    background: var(--bg-primary);
    color: var(--text-primary);
    border-color: var(--border);
  }

  [data-theme="dark"] .tbtn:hover {
    background: var(--accent);
    color: white;
  }

  [data-theme="dark"] #docsTitle {
    color: var(--text-primary);
  }

  [data-theme="dark"] #docsTitle::placeholder {
    color: var(--text-secondary);
  }

  /* ===== Docs Editor Styles ===== */
</style>
<script src="https://unpkg.com/feather-icons"></script>
<script src="https://unpkg.com/lucide@latest"></script>
  <!-- Editor.js core and tools -->
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.29.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.8.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/list@1.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/checklist@1.6.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@2.6.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/code@2.9.3"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@1.4.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/marker@1.3.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@1.4.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/table@2.3.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/image@2.8.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/link@2.6.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/underline@1.3.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/attaches@1.3.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.6"></script>
  <!-- Alignment tune tool -->
  <script src="https://cdn.jsdelivr.net/npm/editorjs-text-alignment-blocktune@latest"></script>
  <!-- Text align plugin -->
  <script src="https://cdn.jsdelivr.net/npm/@canburaks/text-align-editorjs@1.1.0/dist/text-align.umd.min.js"></script>
  <!-- Drag and Drop plugin -->
  <script src="https://cdn.jsdelivr.net/npm/editorjs-drag-drop"></script>
</head>
<body>
<!-- BlockNote Editor - Modern Block-Based Editing -->
<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Freelancer CRM — One File (Light/Dark)</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#ffffff;
    --text:#0b0b0b;
    --muted:#6b7280;
    --panel:#ffffff;
    --panel-2:#f6f7fb;
    --line:#e5e7eb;
    --chip:#f3f4f6;
    --brand:#111111;
    --accent:#3b82f6;
    --ok:#059669;
    --warn:#b45309;
    --danger:#b91c1c;
    --radius:16px;
    --shadow:0 8px 28px rgba(0,0,0,.06);
    --rail-w:64px;
    --rail-gap:20px;
  }
  [data-theme="dark"]{
    --bg:#0b0c10;
    --text:#eceff4;
    --muted:#98a1b3;
    --panel:#0f1117;
    --panel-2:#141824;
    --line:#23283a;
    --chip:#171c2a;
    --brand:#e5e7eb;
    --accent:#60a5fa;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:14px/1.55 ui-sans-serif,-apple-system,Segoe UI,Inter,Roboto,Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .app{display:grid; grid-template-columns:var(--side,200px) 1fr; min-height:100vh}
  /* Sidebar */
  .side{position:sticky; top:0; height:100vh; background:var(--panel); border-right:1px solid var(--line); padding:18px 14px; display:flex; flex-direction:column; gap:12px}
  .side .resizer{position:absolute; top:0; right:-4px; width:12px; height:100%; cursor:ew-resize; background:transparent; z-index:50}
  .side:hover .resizer{background:linear-gradient(to right, transparent, color-mix(in oklab, var(--line) 60%, transparent), transparent)}
  .side.collapsed{padding-left:10px; padding-right:10px}
  .side.collapsed .brand strong{display:none}
  .side.collapsed .nav button{justify-content:center; font-size:0; padding:10px; gap:0}
  .side.collapsed .nav button svg{margin:0; width:22px; height:22px}
  .side.collapsed .mini{display:none}
  .brand{display:flex; align-items:center; gap:10px; padding:10px; border-radius:12px; border:1px solid var(--line); background:var(--panel-2)}
  .brand svg{width:18px;height:18px}
  .brand strong{font-size:14px; letter-spacing:.3px}
  .side.collapsed .brand{justify-content:center; gap:0}
  .side.collapsed .brand svg{width:22px;height:22px}
  .nav{display:flex; flex-direction:column; gap:6px}
  .nav button{
    display:flex; align-items:center; gap:10px; width:100%;
    padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:transparent; cursor:pointer; color:var(--text);
    transition:.15s ease;
  }
  .nav button:hover{background:var(--panel-2)}
  .nav button.active{background:var(--chip)}
  .nav svg{width:18px;height:18px}
  .iconbtn i,[data-feather],[data-lucide]{width:18px;height:18px; vertical-align:middle}
  .rail button i{width:18px;height:18px}
  .nav button svg{flex:0 0 auto}
  .nav button span{white-space:nowrap}
  .side .grow{flex:1}
  .mini{color:var(--muted); font-size:12px}
  /* Modern checkboxes for bulk selection */
  input[type="checkbox"]{ width:16px; height:16px; border-radius:6px; accent-color:var(--accent); cursor:pointer }
  /* Right floating rail like backup */
  .rail{
    position:fixed; 
    right:var(--rail-gap); 
    top:16px; 
    bottom:16px; 
    z-index:1000;
    width:var(--rail-w); 
    background:var(--panel); 
    border:1px solid var(--line); 
    border-radius:14px;
    box-shadow:var(--shadow); 
    padding:16px; 
    display:flex; 
    flex-direction:column; 
    justify-content:space-between;
  }
  
  /* Modern scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: var(--bg);
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb {
    background: var(--line);
    border-radius: 4px;
    transition: background 0.2s ease;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: var(--muted);
  }
  
  ::-webkit-scrollbar-corner {
    background: var(--bg);
  }
  
  /* Firefox scrollbar */
  * {
    scrollbar-width: thin;
    scrollbar-color: var(--line) var(--bg);
  }
  .main{padding:16px; padding-right:calc(16px + var(--rail-w) + var(--rail-gap)); display:grid; gap:12px}
  .rail-top{display:flex; justify-content:center; align-items:center; padding-bottom:16px}
  .rail-bottom{display:flex; flex-direction:column; gap:8px; align-items:center}
  .rail button{width:40px; height:40px; border-radius:8px; border:none; background:transparent; color:var(--text); cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .2s ease}
  .rail button:hover{background:var(--chip)}
  /* Header */
  .head{
    position:sticky; 
    top:0; 
    z-index:5; 
    background:var(--panel); 
    display:flex; 
    align-items:center; 
    justify-content:space-between; 
    padding:16px 24px; 
    padding-right:calc(24px + var(--rail-w) + var(--rail-gap));
    min-height:auto;
  }
  
  /* Header chips styling - super simple */
  .chip{
    display:inline-flex; 
    align-items:center; 
    gap:8px; 
    padding:6px 12px; 
    border-radius:6px; 
    background:var(--bg); 
    color:var(--text);
    font-size:13px;
  }
  
  /* Header input styling - super solid and light background */
  .head .chip input {
    background: var(--chip);
    border: none;
    padding: 6px 12px;
    font-size: 13px;
    color: var(--text);
    outline: none;
    transition: all 0.3s ease;
    border-radius: 6px;
    width: fit-content;
    min-width: 80px;
  }
  
  /* Header container with smooth scrolling */
  .head .flex {
    display: flex;
    align-items: center;
    gap: 16px;
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
    scroll-behavior: smooth;
    padding: 8px 0;
    /* Ensure search elements can break out */
    position: relative;
  }
  
  /* Ensure no parent containers constrain search */
  .head, .main, .page-container, .page {
    overflow: visible !important;
    clip: auto !important;
    clip-path: none !important;
    mask: none !important;
    -webkit-mask: none !important;
  }
  
  .head .flex::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
  }
  
  /* Chip transitions */
  .head .chip {
    transition: all 0.3s ease;
    white-space: nowrap;
    flex-shrink: 0;
  }
  
  .head .chip input:hover {
    background: var(--chip);
    transform: translateY(-1px);
  }
  
  .head .chip input:focus {
    background: var(--chip);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  /* Modern Currency Dropdown */
  .currency-dropdown {
    position: relative;
    display: inline-block;
    transition: all 0.3s ease;
  }
  
  .currency-toggle {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background: var(--chip);
    border: none;
    padding: 6px 12px;
    font-size: 13px;
    color: var(--text);
    cursor: pointer;
    outline: none;
    transition: all 0.2s ease;
    border-radius: 6px;
    min-width: 80px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }
  
  .currency-toggle:hover {
    background: var(--panel-2);
    transform: translateY(-1px);
  }
  
  .currency-arrow {
    width: 14px;
    height: 14px;
    transition: transform 0.2s ease;
  }
  
  .currency-dropdown.open .currency-arrow {
    transform: rotate(180deg);
  }
  
  .currency-menu {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg);
    border: 1px solid var(--line);
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    overflow: hidden;
    margin-top: 4px;
    animation: slideDown 0.2s ease;
    min-width: 100%;
  }
  
  .currency-option {
    padding: 10px 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 1px solid var(--line);
    font-size: 13px;
    color: var(--text);
  }
  
  .currency-option:last-child {
    border-bottom: none;
  }
  
  .currency-option:hover {
    background: var(--panel-2);
    transform: translateX(4px);
  }
  
  .currency-option:active {
    background: var(--accent);
    color: white;
  }
  
  /* Header button styling */
  .head .btn {
    padding:6px 12px;
    border-radius:6px;
    font-size:13px;
    font-weight:500;
  }
  .chip input{border:0; background:transparent; outline:none; font:inherit; color:var(--text)}
  
  /* Search Container Styling */
  .search-container {
    transition: all 0.3s ease;
    margin-right: auto;
    transform: translateX(0);
  }
  
  /* Center search bar on all pages except homepage */
  .search-container.centered {
    margin-right: 0;
    margin-left: auto;
    transform: translateX(0);
  }
  
  /* Smooth scroll behavior for header */
  .head {
    scroll-behavior: smooth;
  }
  
  .search-container input {
    transition: all 0.3s ease;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
    backdrop-filter: none;
    filter: none;
  }
  
  .search-container input:focus {
    background: var(--panel-2) !important;
    transform: scale(1.02);
    color: var(--text) !important;
    font-weight: 500;
  }
  
  .search-container input::placeholder {
    color: var(--muted);
    opacity: 0.8;
    font-weight: normal;
  }
  
  /* Disable browser autocomplete suggestions */
  .search-container input::-webkit-autofill,
  .search-container input::-webkit-autofill:hover,
  .search-container input::-webkit-autofill:focus,
  .search-container input::-webkit-autofill:active {
    -webkit-box-shadow: 0 0 0 30px var(--bg) inset !important;
    -webkit-text-fill-color: var(--text) !important;
  }
  
  /* Remove any browser dropdown suggestions */
  .search-container input::-webkit-calendar-picker-indicator {
    display: none !important;
  }
  
  /* Global Search Dropdown */
  .global-search-wrapper {
    position: relative;
    backdrop-filter: none;
    filter: none;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  .search-input-container {
    display: flex;
    align-items: center;
    position: relative;
  }
  
  .search-button {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    padding: 6px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    margin-left: 4px;
  }
  
  .search-button:hover {
    background: var(--panel-2);
    color: var(--text);
  }
  
  .search-button i {
    width: 16px;
    height: 16px;
  }

  /* History Panel Styles */
  .history-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--line);
    border-radius: 8px;
    margin-top: 16px;
  }

  .history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--line);
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .history-item:hover {
    background-color: var(--panel-2);
  }

  .history-item:last-child {
    border-bottom: none;
  }

  .history-info {
    flex: 1;
  }

  .history-time {
    font-weight: 500;
    color: var(--text);
    font-size: 14px;
  }

  .history-size {
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
  }

  .history-actions {
    display: flex;
    gap: 8px;
  }

  .history-controls {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 16px;
  }

  .autosave-toggle {
    display: flex;
    align-items: center;
    padding: 12px;
    background: var(--panel-2);
    border: 1px solid var(--line);
    border-radius: 8px;
  }

  .toggle-label {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    width: 100%;
  }

  .toggle-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--primary);
  }

  .toggle-text {
    font-size: 14px;
    color: var(--text);
    font-weight: 500;
  }

  .history-buttons {
    display: flex;
    gap: 8px;
  }

  .preview-content {
    background: var(--panel-2);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    max-height: 300px;
    overflow-y: auto;
  }

  .preview-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .version-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }

  .summary-item {
    background: var(--bg);
    border: 1px solid var(--line);
    border-radius: 6px;
    padding: 12px;
  }

  .summary-label {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 4px;
  }

  .summary-value {
    font-weight: 500;
    color: var(--text);
  }

  .loading {
    text-align: center;
    padding: 20px;
    color: var(--muted);
  }

  /* Modal Styles */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .modal-content {
    background: var(--bg);
    border: 1px solid var(--line);
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    max-width: 90vw;
    max-height: 90vh;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--line);
    background: var(--panel-2);
  }

  .modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }

  .close-btn {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-btn:hover {
    background: var(--panel-2);
    color: var(--text);
  }

  .close-btn i {
    width: 16px;
    height: 16px;
  }

  .modal-body {
    padding: 20px;
    overflow-y: auto;
  }
  
  .search-backdrop {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    background: rgba(0,0,0,0.1) !important;
    z-index: 999998 !important;
    backdrop-filter: blur(1px) !important;
    /* Force override any parent constraints */
    overflow: visible !important;
    clip: auto !important;
    clip-path: none !important;
    mask: none !important;
    -webkit-mask: none !important;
  }
  
  .global-search-results {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    width: 90vw !important;
    max-width: 600px !important;
    background: var(--bg) !important;
    border: 1px solid var(--line) !important;
    border-radius: 12px !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12) !important;
    z-index: 999999 !important;
    max-height: 400px !important;
    overflow: hidden !important;
    animation: slideDownSearch 0.3s ease !important;
    /* Force override any parent constraints */
    overflow: visible !important;
    clip: auto !important;
    clip-path: none !important;
    mask: none !important;
    -webkit-mask: none !important;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .global-search-results {
      width: 95vw;
      max-width: none;
      top: 70px;
      left: 2.5vw;
      transform: none;
    }
  }
  @keyframes slideDownSearch {
    from {
      opacity: 0;
      transform: translateY(-10px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  .search-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--line);
    background: var(--panel);
    font-weight: 600;
    font-size: 14px;
  }
  
  .close-search {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
  }
  
  .close-search:hover {
    background: var(--panel-2);
    color: var(--text);
  }
  
  .search-results-content {
    max-height: 320px;
    overflow-y: auto;
  }
  
  .search-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    color: var(--muted);
    text-align: center;
  }
  
  .search-placeholder i {
    font-size: 24px;
    margin-bottom: 8px;
    opacity: 0.5;
  }
  
  .search-result-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 1px solid var(--line);
  }
  
  .search-result-item:last-child {
    border-bottom: none;
  }
  
  .search-result-item:hover {
    background: var(--panel-2);
  }
  
  .search-result-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 14px;
  }
  
  .search-result-icon.contact {
    background: var(--accent);
    color: white;
  }
  
  .search-result-icon.proposal {
    background: #10b981;
    color: white;
  }
  
  .search-result-icon.invoice {
    background: #f59e0b;
    color: white;
  }
  
  .search-result-content {
    flex: 1;
  }
  
  .search-result-title {
    font-weight: 600;
    font-size: 14px;
    color: var(--text);
    margin-bottom: 2px;
  }
  
  .search-result-subtitle {
    font-size: 12px;
    color: var(--muted);
  }
  
  .search-result-meta {
    font-size: 11px;
    color: var(--muted);
    margin-top: 4px;
  }
  
  .search-section-header {
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: var(--panel);
    border-bottom: 1px solid var(--line);
  }
  
  .no-results {
    padding: 40px 20px;
    text-align: center;
    color: var(--muted);
  }
  
  .no-results i {
    font-size: 24px;
    margin-bottom: 8px;
    opacity: 0.5;
  }
  .btn{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; border:1px solid var(--line); background:var(--text); color:var(--bg); cursor:pointer}
  .btn.secondary{background:transparent; color:var(--text)}
  .btn.small{padding:6px 10px; border-radius:10px; font-size:12px}
  .btn.danger{background:#fff; color:#e11d48; border-color:#e11d48}
  /* Main */
  .main{padding:16px; padding-right:calc(16px + var(--rail-w) + var(--rail-gap)); display:grid; gap:12px}
  .grid{display:grid; gap:12px; grid-template-columns:repeat(12,1fr)}
  .card{background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); overflow:visible}
  .card h3{margin:0 0 8px 0; font-size:14px}
  .row{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
  .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
  .flex{display:flex; align-items:center; gap:8px}.justify-between{justify-content:space-between}
  /* Modern inputs */
  input[type="text"],input[type="email"],input[type="tel"],input[type="number"],input[type="date"],textarea,select{
    width:100%; background:var(--panel-2); color:var(--text); border:1px solid color-mix(in oklab, var(--line) 70%, transparent); border-radius:12px; padding:12px 14px; outline:none; box-shadow:none
  }
  input:hover, textarea:hover, select:hover{border-color:color-mix(in oklab, var(--line) 90%, transparent)}
  input::placeholder,textarea::placeholder{color:var(--muted)}
  input:focus,textarea:focus,select:focus{border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 20%, transparent)}
  textarea{min-height:110px; resize:vertical}
  /* Make global search wider */
  #globalSearch{
    min-width:260px; 
    width:clamp(260px,42vw,560px);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
    backdrop-filter: none !important;
    filter: none !important;
  }
  table{width:100%; border-collapse:collapse}
  th,td{text-align:left; padding:10px 8px; border-bottom:1px solid var(--line); vertical-align:top}
  th{font-weight:600}
  .list{border:1px solid var(--line); border-radius:12px; overflow:hidden; max-height:none}
  .list .rowi{display:grid; grid-template-columns:.2fr 1.1fr 1fr 1fr .8fr .6fr .3fr; gap:10px; padding:10px; border-bottom:1px solid var(--line)}
  .list.bulk-off .rowi{grid-template-columns:1.1fr 1fr 1fr .8fr .6fr .3fr}
  .list.bulk-off .rowi .bulk-col,.list.bulk-off .bulk-actions{display:none}
  
  /* Contacts specific grid layout */
  #contactsList .rowi{grid-template-columns:.2fr 1.1fr 1fr 1fr .8fr .6fr .3fr}
  #contactsList.bulk-off .rowi{grid-template-columns:1.1fr 1fr 1fr .8fr .6fr .3fr}
  
  /* Bulk column styling */
  .bulk-col{display:flex; align-items:center; justify-content:center}
  .bulk-actions{display:flex; gap:4px; align-items:center}
  
  /* Contact row hover effect */
  .rowi[onclick*="openContactModal"]:hover {
    background: var(--panel-2);
    transform: translateY(-1px);
    transition: all 0.2s ease;
  }
  
  /* Financial Dashboard Styling */
  .financial-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-top: 16px;
  }
  
  .financial-item {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
    transition: all 0.2s ease;
  }
  
  .financial-item:hover {
    background: var(--panel-2);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .financial-label {
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }
  
  .financial-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 4px;
  }
  
  .financial-amount {
    font-size: 14px;
    color: var(--accent);
    font-weight: 600;
  }
  .list .rowi:hover{background:var(--panel-2)}
  .list .rowi:last-child{border-bottom:none}
  .status{border-radius:999px; padding:4px 8px; font-size:12px; border:1px solid var(--line)}
  .status.draft{color:#6b7280}.status.sent{color:#1e40af}.status.accepted{color:#059669}.status.declined{color:#b91c1c}.status.paid{color:#059669}.status.overdue{color:#b91c1c}
  .tools{display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px}
  .tbtn{padding:6px 10px; border:1px solid var(--line); background:var(--chip); border-radius:10px; cursor:pointer}
  /* Document header (Proposal/Invoice) */
  .doc-header{display:grid; grid-template-columns:1fr 1fr 1fr; gap:24px; align-items:flex-start; margin:12px 0 16px}
  .doc-cell h4{margin:0 0 6px 0; font-size:14px}
  .doc-meta{justify-self:end; text-align:right}
  .doc-meta .big{font-size:22px; font-weight:700; letter-spacing:.5px}
  .doc-list{font-size:13px; line-height:1.6}
  .doc-list .muted{color:var(--muted)}
  
  /* editor styles removed */
  /* Number input: custom spinner */
  input[type=number]{ -moz-appearance:textfield }
  input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0 }
  .numwrap{ position:relative }
  .numwrap input[type=number]{ padding-right:28px }
  .numwrap .spin{ position:absolute; right:6px; top:50%; transform:translateY(-50%); display:flex; flex-direction:column }
  .numwrap .spin button{ width:18px; height:12px; border:1px solid var(--line); background:var(--panel); color:var(--muted); border-radius:4px; line-height:10px; padding:0; cursor:pointer }
  .numwrap .spin button+button{ margin-top:2px }
  /* Modal overlay clean style */
  #viewModal{position:fixed; inset:0; background:rgba(0,0,0,.2); display:flex; align-items:flex-start; justify-content:center; padding:40px}
  #viewModal[hidden]{display:none}

  /* Contact modal */
  #contactModal{position:fixed; inset:0; background:rgba(0,0,0,.25); display:flex; align-items:center; justify-content:center; padding:40px; z-index:9999}
  #contactModal[hidden]{display:none}
  .spark{width:100%; height:54px}
  
  /* Enhanced tab structure and spacing */
  .page{opacity:0; transform:perspective(1000px) rotateY(-4deg) translateX(-6px); transition:transform .3s ease, opacity .25s ease; display:none; width:100%}
  .page.active{opacity:1; transform:none; display:block}
  .page-container{position:relative; min-height:auto}
  
  /* Ensure pages take full width when active */
  .page.active{width:100%; min-height:auto}
  
  /* Better tab content organization */
  .tab-section{display:block; width:100%}
  
  /* Fix grid layout for all pages */
  .page .row{display:grid; grid-template-columns:repeat(12,1fr); gap:12px; margin-bottom:0}
  .page .col-5{grid-column:span 5}
  .page .col-6{grid-column:span 6}
  .page .col-7{grid-column:span 7}
  .page .col-8{grid-column:span 8}
  .page .col-12{grid-column:span 12}
  
  /* Better card spacing and structure */
  .card{margin-bottom:0}
  .card:last-child{margin-bottom:0}
  
  /* Fix spacing in forms and lists */
  .page .card{padding:16px}
  .page .row{margin-bottom:0}
  .page .row > div{margin-bottom:12px}
  .page .row > div:last-child{margin-bottom:0}
  
  /* Ensure proper table spacing */
  .page table{margin-top:16px}
  .page .list{margin-top:16px}
  
  /* Fix editor spacing */
  .page .editor{margin-top:16px}
  .page .tools{margin-bottom:16px}

  /* Proposal breakdown styles */
  #p_breakdown_wrap{margin-top:10px}
  #p_breakdown_table{width:100%; border-collapse:collapse}
  #p_breakdown_table th,#p_breakdown_table td{border:1px solid var(--line); padding:8px; font-size:13px}
  #p_breakdown_table input[type="text"], #p_breakdown_table input[type="number"]{width:100%}
  #p_breakdown_hint{margin-top:6px}

  /* Pricing prototype row */
  .prototype-row{border:2px dashed var(--line); border-radius:8px; padding:10px; text-align:center; color:var(--muted); cursor:pointer; margin-top:10px}
  .prototype-row:hover{background:var(--panel)}
  .qty-eye{margin-left:6px; background:transparent; border:none; cursor:pointer; color:var(--muted); padding:0}
  .qty-eye svg{width:16px; height:16px}
  .iconbtn.tiny{margin-right:5px}
  .iconbtn.tiny svg{width:14px; height:14px}
  .line-editor{min-height:80px; margin-top:8px; border:1px solid var(--line); background:var(--panel-2); border-radius:8px; padding:8px}
  /* Smaller toolbar icons in card headers */
  .card .flex .iconbtn svg{width:16px; height:16px}
  /* Inputs */
  .input-with-icon{position:relative}
  .input-with-icon{position:relative; display:inline-block}
  .input-with-icon i{position:absolute; right:12px; top:50%; transform:translateY(-50%); color:var(--muted); pointer-events:none; z-index:2}
  .input-with-icon input, .input-with-icon select{padding-right:32px; width:100%; box-sizing:border-box}
  .input-with-icon input[type="date"]{padding-right:12px; cursor:pointer}
  .input-with-icon input[type="date"]::-webkit-calendar-picker-indicator{width:20px; height:20px; cursor:pointer}

  /* Compact Title input - match header height */
  #p_title{height:42px; font-size:14px}
  select, input[type="date"], input[type="text"], input[type="number"]{height:40px; border-radius:8px; transition:all 0.2s ease}
  select:focus, input:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 2px rgba(var(--primary-rgb), 0.1)}
  input[type="date"]::-webkit-calendar-picker-indicator{cursor:pointer; opacity:0.7; transition:opacity 0.2s ease}
  input[type="date"]::-webkit-calendar-picker-indicator:hover{opacity:1}
  
  /* Modern proposal header */
  .proposal-header{display:grid; grid-template-columns:2fr 1fr; gap:20px; margin-bottom:24px; align-items:end}
  .proposal-header .field{display:flex; flex-direction:column; gap:6px}
  .proposal-header .field:first-child{grid-column:1 / -1}
  .proposal-header label{font-size:11px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:0.8px}
  .proposal-header input, .proposal-header select{width:100%; height:42px; font-size:14px}
  @media (max-width: 900px){
    .proposal-header{grid-template-columns:1fr}
  }
  
  /* Improved tab navigation */
  .nav button{position:relative; overflow:hidden}
  .nav button::after{content:''; position:absolute; bottom:0; left:0; width:0; height:2px; background:var(--brand); transition:width .3s ease}
  .nav button.active::after{width:100%}
  
  /* Enhanced visual separation - reduced spacing */
  .tab-section{margin-bottom:16px}
  .tab-section:last-child{margin-bottom:0}
  /* Better responsive grid */
  .responsive-grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr))}
  
  /* Enhanced tab content spacing */
  .page > .tab-section:first-child{margin-top:0}
  .page > .tab-section:last-child{margin-bottom:0}
  
  /* Improved card shadows and borders */
  .card{transition:box-shadow 0.2s ease, transform 0.1s ease}
  .card:hover{box-shadow:0 12px 32px rgba(0,0,0,0.1); transform:translateY(-1px)}
  
  /* Better form spacing */
  .row > div{margin-bottom:12px}
  .row > div:last-child{margin-bottom:0}
  
  /* Enhanced navigation active state */
  .nav button.active{background:var(--chip); border-color:var(--brand)}
  
  /* Improved page transitions */
  .page{will-change:opacity, transform}
  
  /* Fix for nested cards in home page */
  .page .card .card{padding:16px; margin:0}
  
  /* Ensure consistent spacing across all tabs - reduced padding */
  .page{min-height:auto; padding-bottom:16px}
  
  /* Better mobile responsiveness */
  @media (max-width:768px){
    .tab-section{margin-bottom:12px}
    .card{padding:12px}
    .row{gap:8px}
  }
  /* Print */
  @media print{
    .side,.rail,.head,.noprint{display:none !important}
    .card{box-shadow:none; border:0; padding:0}
    body{background:#fff; color:#000}
  }
  @media (max-width:980px){
    .app{grid-template-columns:1fr}
    .side{height:auto; position:relative}
    .rail{display:none}
    .head, .main { padding-right:0 }
    .row{grid-template-columns:1fr}
    .grid{grid-template-columns:1fr}
  }
  /* Better responsive behavior */
  @media (max-width:768px){
    .page .row{grid-template-columns:1fr; gap:12px}
    .page .col-5, .page .col-6, .page .col-7, .page .col-8{grid-column:span 12}
  }
  /* Settings page minimal look */
  .settings-page .card{background:transparent; box-shadow:none; border-style:dashed; padding:12px}
  .settings-page .card h3{font-size:13px; margin:0 0 8px 0}
  .settings-page .row > div{margin-bottom:8px}
  #fxManual input{padding:8px 10px; font-size:13px}
  #fxRates, #fxMeta{line-height:1.4}
  .settings-page .mini{opacity:.8}
  /* Standardize all icons to match navbar size */
  .iconbtn i,[data-feather],[data-lucide],.rail button i,.btn i{width:18px;height:18px; vertical-align:middle}
  
  /* Modern form elements */
  select, input[type="date"], input[type="number"] {
    appearance: none;
    background: var(--bg);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 14px;
    color: var(--text);
    transition: all 0.2s ease;
  }
  
  select:hover, input[type="date"]:hover, input[type="number"]:hover {
    border-color: var(--accent);
  }
  
  select:focus, input[type="date"]:focus, input[type="number"]:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  /* Modern dropdown arrow */
  select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 8px center;
    background-repeat: no-repeat;
    background-size: 16px;
    padding-right: 32px;
    width: fit-content;
    min-width: 80px;
  }
  
  /* Modern date input */
  input[type="date"]::-webkit-calendar-picker-indicator {
    background: transparent;
    color: transparent;
    cursor: pointer;
    height: 20px;
    width: 20px;
    margin-left: -20px;
  }
  
  input[type="date"]::-webkit-datetime-edit {
    color: var(--text);
  }
  

  
  /* Modern year navigator */
  .year-navigator {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--chip);
    border-radius: 6px;
    padding: 4px;
    transition: all 0.3s ease;
  }
  
  .year-nav-btn {
    background: transparent;
    border: none;
    color: var(--text);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .year-nav-btn:hover {
    background: var(--panel);
    transform: scale(1.1);
  }
  
  .year-nav-btn:active {
    transform: scale(0.95);
  }
  
  .year-navigator span {
    background: var(--bg);
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 13px;
    color: var(--text);
    min-width: 60px;
    text-align: center;
    font-weight: 500;
  }
  
  /* Apply awesome scrollbar to all scrollable elements */
  .list, .chart-container, .year-dropdown {
    scrollbar-width: thin;
    scrollbar-color: var(--line) var(--bg);
  }
  
  .list::-webkit-scrollbar, 
  .chart-container::-webkit-scrollbar, 
  .year-dropdown::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  .list::-webkit-scrollbar-track, 
  .chart-container::-webkit-scrollbar-track, 
  .year-dropdown::-webkit-scrollbar-track {
    background: var(--bg);
    border-radius: 4px;
  }
  .list::-webkit-scrollbar-thumb, 
  .chart-container::-webkit-scrollbar-thumb, 
  .year-dropdown::-webkit-scrollbar-thumb {
    background: var(--line);
    border-radius: 4px;
    transition: background 0.2s ease;
  }
  
  .list::-webkit-scrollbar-thumb:hover, 
  .chart-container::-webkit-scrollbar-thumb:hover, 
  .year-dropdown::-webkit-scrollbar-thumb:hover {
    background: var(--muted);
  }
  
  .list::-webkit-scrollbar-corner, 
  .chart-container::-webkit-scrollbar-corner, 
  .year-dropdown::-webkit-scrollbar-corner {
    background: var(--bg);
  }
  
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .year-option {
    padding: 10px 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 1px solid var(--line);
    font-size: 13px;
  }
  
  .year-option:last-child {
    border-bottom: none;
  }
  
  .year-option:hover {
    background-color: var(--panel);
    transform: translateX(4px);
  }
  
  .year-option:active {
    background-color: var(--accent);
    color: white;
  }
  
  /* Ensure modals are above sidebar */
  #viewModal, #historyModal, #contactModal {
    z-index: 9999;
  }
  

  
  /* Chart Containers */
  .chart-container {
    margin-top: 16px;
    padding: 16px;
    background: var(--bg);
    border-radius: 8px;
    border: 1px solid var(--line);
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .chart-container canvas {
    max-width: 100%;
    height: auto;
  }
  
  /* Theme Toggle Styling */
  .theme-toggle-container {
    margin-top: 12px;
    display: flex;
    justify-content: center;
  }
  
  .theme-toggle {
    width: 36px;
    height: 60px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    position: relative;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .toggle-track {
    width: 36px;
    height: 60px;
    background: var(--line);
    border-radius: 18px;
    position: relative;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
  }
  
  .toggle-track::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .toggle-thumb {
    width: 28px;
    height: 28px;
    background: var(--bg);
    border-radius: 50%;
    position: absolute;
    top: 3px;
    left: 4px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  .sun-icon, .moon-icon {
    width: 16px;
    height: 16px;
    color: var(--text);
    transition: all 0.3s ease;
    position: absolute;
  }
  
  .sun-icon {
    opacity: 1;
    transform: scale(1);
  }
  
  .moon-icon {
    opacity: 0;
    transform: scale(0.5);
  }
  
  /* Dark theme state */
  [data-theme="dark"] .toggle-track::before {
    opacity: 1;
  }
  
  [data-theme="dark"] .toggle-thumb {
    top: 29px;
    background: var(--text);
  }
  
  [data-theme="dark"] .sun-icon {
    opacity: 0;
    transform: scale(0.5);
  }
  
  [data-theme="dark"] .moon-icon {
    opacity: 1;
    transform: scale(1);
    color: var(--bg);
  }
  
  /* Hover effects */
  .theme-toggle:hover .toggle-track {
    transform: scale(1.05);
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  }
  
  .theme-toggle:hover .toggle-thumb {
    transform: scale(1.1);
  }
  
  /* Active state */
  .theme-toggle:active .toggle-thumb {
    transform: scale(0.95);
  }
  
  /* Focus state */
  .theme-toggle:focus {
    outline: none;
  }
  
  .theme-toggle:focus .toggle-track {
    box-shadow: 0 0 0 3px var(--accent);
  }

  /* ===== Docs Editor Styles ===== */
  .blocknote-editor {
    min-height: 400px;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    background: white;
    position: relative;
  }

  .blocknote-editor .ProseMirror {
    outline: none;
    min-height: 400px;
  }

  .blocknote-editor .ProseMirror p {
    margin: 8px 0;
    line-height: 1.6;
  }

  .blocknote-editor .ProseMirror h1,
  .blocknote-editor .ProseMirror h2,
  .blocknote-editor .ProseMirror h3 {
    margin: 16px 0 8px 0;
    font-weight: 600;
  }

  .blocknote-editor .ProseMirror h1 { font-size: 24px; }
  .blocknote-editor .ProseMirror h2 { font-size: 20px; }
  .blocknote-editor .ProseMirror h3 { font-size: 18px; }

  .blocknote-editor .ProseMirror ul,
  .blocknote-editor .ProseMirror ol {
    margin: 8px 0;
    padding-left: 24px;
  }

  .blocknote-editor .ProseMirror blockquote {
    border-left: 4px solid var(--accent);
    margin: 16px 0;
    padding: 8px 16px;
    background: var(--bg-secondary);
    font-style: italic;
  }

  .blocknote-editor .ProseMirror pre {
    background: var(--bg-secondary);
    padding: 12px;
    border-radius: 4px;
    overflow-x: auto;
    font-family: monospace;
  }

  .blocknote-editor .ProseMirror hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 16px 0;
  }

  .editor-toolbar {
    display: flex;
    gap: 4px;
    padding: 8px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-secondary);
    border-radius: 8px 8px 0 0;
  }

  .tbtn {
    padding: 6px 12px;
    border: 1px solid var(--border);
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
  }

  .tbtn:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .tbtn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  /* BlockNote floating menus */
.bn-float-menu {
  background: white;
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 1000;
  display: block !important;
}

.bn-suggest {
  background: white;
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 1000;
  display: block !important;
}

/* Ensure BlockNote editor is visible */
.ProseMirror {
  min-height: 400px !important;
  outline: none !important;
  padding: 16px !important;
  background: white !important;
  color: var(--text-primary) !important;
}

/* BlockNote container visibility */
.bn-container {
  display: block !important;
  visibility: visible !important;
}

/* Force BlockNote elements to be visible */
.bn-float-menu,
.bn-suggest,
.bn-side-menu,
.bn-formatting-toolbar {
  opacity: 1 !important;
  visibility: visible !important;
  display: block !important;
  background: white !important;
  color: black !important;
  border: 1px solid #ddd !important;
  border-radius: 8px !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
  z-index: 10000 !important;
}

/* BlockNote Editor Styling */
.bn-container {
  font-family: inherit !important;
}

.bn-container .ProseMirror {
  outline: none !important;
  min-height: 400px !important;
  padding: 16px !important;
  line-height: 1.6 !important;
}

.bn-container .ProseMirror p {
  margin: 8px 0 !important;
}

.bn-container .ProseMirror h1,
.bn-container .ProseMirror h2,
.bn-container .ProseMirror h3 {
  margin: 16px 0 8px 0 !important;
  font-weight: 600 !important;
}

.bn-container .ProseMirror h1 { font-size: 24px !important; }
.bn-container .ProseMirror h2 { font-size: 20px !important; }
.bn-container .ProseMirror h3 { font-size: 18px !important; }

.bn-container .ProseMirror ul,
.bn-container .ProseMirror ol {
  margin: 8px 0 !important;
  padding-left: 24px !important;
}

.bn-container .ProseMirror blockquote {
  border-left: 4px solid var(--accent) !important;
  margin: 16px 0 !important;
  padding: 8px 16px !important;
  background: var(--bg-secondary) !important;
  font-style: italic !important;
}

.bn-container .ProseMirror pre {
  background: var(--bg-secondary) !important;
  padding: 12px !important;
  border-radius: 4px !important;
  overflow-x: auto !important;
  font-family: monospace !important;
}

.bn-container .ProseMirror hr {
  border: none !important;
  border-top: 1px solid var(--border) !important;
  margin: 16px 0 !important;
}

/* Fallback Editor Button Visibility */
.fallback-toolbar button {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
  border: 1px solid var(--border) !important;
  background: white !important;
  color: var(--text-primary) !important;
  padding: 6px 12px !important;
  border-radius: 4px !important;
  cursor: pointer !important;
  font-size: 12px !important;
  font-weight: 500 !important;
  min-width: 40px !important;
  height: 32px !important;
  align-items: center !important;
  justify-content: center !important;
  transition: all 0.2s !important;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
}

.fallback-toolbar button:hover {
  background: var(--accent) !important;
  color: white !important;
  border-color: var(--accent) !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15) !important;
}

.fallback-toolbar button:active {
  transform: translateY(0) !important;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
}

  /* Docs list styling */
  #docsList .history-item {
    cursor: pointer;
    padding: 12px;
    border-bottom: 1px solid var(--border);
    transition: background 0.2s;
  }

  #docsList .history-item:hover {
    background: var(--bg-secondary);
  }

  #docsList .history-item:last-child {
    border-bottom: none;
  }

  /* Full page editor layout */
  #route-doc .card {
    min-height: 80vh;
  }

  #route-doc .editor {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  #docs_editor {
    flex: 1;
    min-height: 500px;
  }

  /* Input styling */
  #docsTitle {
    font-size: 18px;
    font-weight: 600;
    border: none;
    background: transparent;
    width: 100%;
    padding: 8px 0;
    border-bottom: 2px solid transparent;
    transition: border-color 0.2s;
  }

  #docsTitle:focus {
    outline: none;
    border-bottom-color: var(--accent);
  }

  #docsTitle::placeholder {
    color: var(--text-secondary);
  }

  /* Status hint */
  #docsHint {
    margin-top: 8px;
    padding: 4px 8px;
    background: var(--bg-secondary);
    border-radius: 4px;
    font-size: 12px;
    color: var(--text-secondary);
  }

  /* Responsive */
  @media (max-width: 768px) {
    #route-doc .card {
      min-height: 70vh;
    }
    
    #docs_editor {
      min-height: 400px;
    }
  }

  /* Dark theme support */
  [data-theme="dark"] .blocknote-editor {
    background: var(--bg-primary);
    border-color: var(--border);
  }

  [data-theme="dark"] .blocknote-editor .ProseMirror {
    color: var(--text-primary);
  }

  [data-theme="dark"] .tbtn {
    background: var(--bg-primary);
    color: var(--text-primary);
    border-color: var(--border);
  }

  [data-theme="dark"] .tbtn:hover {
    background: var(--accent);
    color: white;
  }

  [data-theme="dark"] #docsTitle {
    color: var(--text-primary);
  }

  [data-theme="dark"] #docsTitle::placeholder {
    color: var(--text-secondary);
  }

  /* ===== Docs Editor Styles ===== */
</style>
<script src="https://unpkg.com/feather-icons"></script>
<script src="https://unpkg.com/lucide@latest"></script>
  <!-- BlockNote core for Docs - Working ESM implementation -->
  <link rel="stylesheet" href="https://esm.sh/@blocknote/core@0.35.0/dist/index.css">
<script type="module">
    // Import BlockNote core directly via ESM
    try {
      const module = await import('https://esm.sh/@blocknote/core@0.35.0');
      window.BlockNoteEditor = module.BlockNoteEditor;
      window.BlockNoteAvailable = true;
      console.log('✅ BlockNote loaded successfully via ESM');
      
      // Apply BlockNote theme CSS variables based on documentation
      applyBlockNoteTheme();
    } catch (err) {
      console.warn('⚠️ BlockNote ESM failed, using local editor:', err);
      window.BlockNoteAvailable = false;
    }
    
    // Apply BlockNote theme based on the documentation
    function applyBlockNoteTheme() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const colorScheme = isDark ? 'dark' : 'light';
      
      // Create theme container
      let themeContainer = document.querySelector('.bn-container');
      if (!themeContainer) {
        themeContainer = document.createElement('div');
        themeContainer.className = 'bn-container';
        themeContainer.setAttribute('data-color-scheme', colorScheme);
        document.body.appendChild(themeContainer);
      }
      
      // Apply CSS variables based on BlockNote documentation
      const themeVars = {
        '--bn-colors-editor-text': isDark ? '#ffffff' : '#3f3f3f',
        '--bn-colors-editor-background': isDark ? '#1a1a1a' : '#ffffff',
        '--bn-colors-menu-text': isDark ? '#ffffff' : '#3f3f3f',
        '--bn-colors-menu-background': isDark ? '#2a2a2a' : '#ffffff',
        '--bn-colors-tooltip-text': isDark ? '#ffffff' : '#3f3f3f',
        '--bn-colors-tooltip-background': isDark ? '#2a2a2a' : '#efefef',
        '--bn-colors-hovered-text': isDark ? '#ffffff' : '#3f3f3f',
        '--bn-colors-hovered-background': isDark ? '#3a3a3a' : '#efefef',
        '--bn-colors-selected-text': isDark ? '#ffffff' : '#ffffff',
        '--bn-colors-selected-background': isDark ? '#0066cc' : '#3f3f3f',
        '--bn-colors-disabled-text': isDark ? '#666666' : '#afafaf',
        '--bn-colors-disabled-background': isDark ? '#2a2a2a' : '#efefef',
        '--bn-colors-shadow': isDark ? '#000000' : '#cfcfcf',
        '--bn-colors-border': isDark ? '#3a3a3a' : '#efefef',
        '--bn-colors-side-menu': isDark ? '#666666' : '#cfcfcf',
        '--bn-colors-formatting-toolbar': isDark ? '#2a2a2a' : '#ffffff',
        '--bn-border-radius': '8px',
        '--bn-font-family': 'inherit'
      };
      
      Object.entries(themeVars).forEach(([key, value]) => {
        themeContainer.style.setProperty(key, value);
      });
      
      // Force apply styles to existing elements after a delay
      setTimeout(() => {
        const elements = document.querySelectorAll('.bn-float-menu, .bn-suggest, .bn-side-menu, .bn-formatting-toolbar');
        elements.forEach(el => {
          if (el) {
            el.style.background = isDark ? '#2a2a2a' : '#ffffff';
            el.style.color = isDark ? '#ffffff' : '#000000';
            el.style.border = `1px solid ${isDark ? '#444' : '#ddd'}`;
            el.style.borderRadius = '8px';
            el.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
          }
        });
      }, 200);
      
      console.log('✅ BlockNote theme applied with forced styling');
    }
</script>
</head>
<body>
<!-- BlockNote Editor - Modern Block-Based Editing -->
<div class="app" id="app">
  <!-- Sidebar -->
  <aside class="side">
    <div class="resizer" id="sideResizer" title="Drag to resize"></div>
    <div class="brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="18" height="18" rx="5" stroke-width="1.4"/><path d="M7 15l4-4 3 3 3-3" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <strong>Freelancer CRM</strong>
    </div>
    <div class="nav">
      <button class="active" data-route="home">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 10.5 12 4l9 6.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1z" stroke-width="1.3"/></svg>
        Home
      </button>
      <button data-route="contacts">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm-8 9a8 8 0 0 1 16 0" stroke-width="1.3"/></svg>
        Contacts
      </button>
      <button data-route="proposals">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M5 4h9l5 5v11a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1Z" stroke-width="1.3"/><path d="M14 4v5h5" stroke-width="1.3"/></svg>
        Proposals
      </button>
      <button data-route="invoices">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 3h12a1 1 0 0 1 1 1v16l-3-2-3 2-3-2-3 2-3-2V4a1 1 0 0 1 1-1Z" stroke-width="1.3"/></svg>
        Invoices
      </button>
      <button data-route="docs">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M5 4h9l5 5v11a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1Z" stroke-width="1.3"/><path d="M14 4v5h5" stroke-width="1.3"/></svg>
        Docs
      </button>
    </div>
    <div class="grow"></div>
    <div class="mini">Local, private. Save to PDF via Print.</div>
  </aside>
  <!-- Content -->
  <section style="overflow:hidden">
    <!-- Header -->
    <div class="head noprint">
      <div class="flex">
        <span class="chip search-container">
          <div class="global-search-wrapper">
            <div class="search-input-container">
              <input id="globalSearch" type="text" placeholder="Search all.." style="min-width:180px" onkeydown="handleSearchKeydown(event)" autocomplete="off" />
              <button class="search-button" onclick="performSearch()">
                <i data-lucide="search"></i>
              </button>
            </div>
          </div>
        </span>
        <span class="chip">
          <span>Currency</span><span> | </span>
          <div class="currency-dropdown">
            <button class="currency-toggle" onclick="toggleCurrencyDropdown()" id="currencyToggle">
              <span id="currencyDisplay">USD</span>
              <i data-lucide="chevron-down" class="currency-arrow"></i>
            </button>
            <div class="currency-menu" id="currencyMenu" style="display:none">
              <div class="currency-option" onclick="selectCurrency('USD')">USD</div>
              <div class="currency-option" onclick="selectCurrency('EUR')">EUR</div>
              <div class="currency-option" onclick="selectCurrency('EGP')">EGP</div>
              <div class="currency-option" onclick="selectCurrency('SAR')">SAR</div>
              <div class="currency-option" onclick="selectCurrency('AED')">AED</div>
            </div>
          </div>
        </span>
        <span class="chip">
          YEAR <span> | </span> 
          <div class="year-navigator">
            <button class="year-nav-btn" onclick="changeYear(-1)" title="Previous Year">
              <i data-lucide="chevron-left"></i>
            </button>
            <span id="fyInput" style="min-width:60px; text-align:center; font-weight:500">2024</span>
            <button class="year-nav-btn" onclick="changeYear(1)" title="Next Year">
              <i data-lucide="chevron-right"></i>
            </button>
          </div>
        </span>
      </div>
      <div class="flex">
      </div>
    </div>

    <!-- Global Search Dropdown (Outside all containers) -->
    <div class="search-backdrop" id="searchBackdrop" style="display:none" onclick="hideGlobalSearchResults()"></div>
    <div class="global-search-results" id="globalSearchResults" style="display:none">
      <div class="search-results-header">
        <span>Search Results</span>
        <button class="close-search" onclick="hideGlobalSearchResults()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="search-results-content" id="searchResultsContent">
        <div class="search-placeholder">
          <i data-lucide="search"></i>
          <span>Start typing to search...</span>
        </div>
      </div>
    </div>
    <!-- Main pages container -->
    <div class="main">
      <div class="page-container">
      <!-- HOME -->
        <div id="route-home" class="page active" data-route>
          <div class="tab-section">
            <div class="card">
          <div class="flex justify-between">
            <h3>Overview</h3><span class="mini">Snapshot</span>
          </div>
          <div class="row">
            <div class="col-4"><div class="card">
              <div class="flex justify-between"><div><div class="mini">Revenue (Year)</div><div id="ytdRevenue" style="font-weight:700;font-size:22px">—</div></div><div class="mini" id="ytdCount">0 invoices</div></div>
              <svg class="spark" id="ySpark"></svg>
            </div></div>
            <div class="col-4"><div class="card">
              <div class="mini">Revenue (This Month)</div>
              <div id="mtdRevenue" style="font-weight:700;font-size:22px">—</div>
              <svg class="spark" id="mSpark"></svg>
            </div></div>
            <div class="col-4"><div class="card">
              <div class="mini">Counts</div>
              <div class="flex" style="gap:16px; margin-top:8px">
                <div><div style="font-weight:700" id="countContacts">0</div><div class="mini">Contacts</div></div>
                <div><div style="font-weight:700" id="countProposals">0</div><div class="mini">Proposals</div></div>
                <div><div style="font-weight:700" id="countInvoices">0</div><div class="mini">Invoices</div></div>
              </div>
            </div></div>
              </div>
          </div>
        </div>

          <!-- Earnings Pace Section -->
          <div class="tab-section">
            <div class="card">
              <div class="flex justify-between">
                <h3>Earnings Pace</h3><span class="mini">Real-time calculation</span>
              </div>
              <div class="row">
                <div class="col-3">
                  <div class="card">
                    <div class="mini">This Year</div>
                    <div id="yearEarnings" style="font-weight:700;font-size:22px">$0</div>
                    <div class="mini" id="yearRate">$0/day</div>
                  </div>
                </div>
                <div class="col-3">
                  <div class="card">
                    <div class="mini">This Month</div>
                    <div id="monthEarnings" style="font-weight:700;font-size:22px">$0</div>
                    <div class="mini" id="monthRate">$0/day</div>
                  </div>
                </div>
                <div class="col-3">
                  <div class="card">
                    <div class="mini">This Week</div>
                    <div id="weekEarnings" style="font-weight:700;font-size:22px">$0</div>
                    <div class="mini" id="weekRate">$0/day</div>
                  </div>
                </div>
                <div class="col-3">
                  <div class="card">
                    <div class="mini">Today</div>
                    <div id="dayEarnings" style="font-weight:700;font-size:22px">$0</div>
                    <div class="mini" id="dayRate">$0/hour</div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-4">
                  <div class="card">
                    <div class="mini">This Hour</div>
                    <div id="hourEarnings" style="font-weight:700;font-size:22px">$0</div>
                    <div class="mini" id="hourRate">$0/min</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="card">
                    <div class="mini">This Minute</div>
                    <div id="minEarnings" style="font-weight:700;font-size:22px">$0</div>
                    <div class="mini" id="minRate">$0/sec</div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="card">
                    <div class="mini">Per Second</div>
                    <div id="secEarnings" style="font-weight:700;font-size:22px">$0</div>
                    <div class="mini" id="secRate">$0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Enhanced Financial Dashboard -->
          <div class="tab-section">
            <div class="row">
              <div class="col-6">
                <div class="card">
                  <h3>Invoice Status Breakdown</h3>
                  <div class="financial-grid">
                    <div class="financial-item">
                      <div class="financial-label">Paid</div>
                      <div class="financial-value" id="paidCount">0</div>
                      <div class="financial-amount" id="paidAmount">$0</div>
                    </div>
                    <div class="financial-item">
                      <div class="financial-label">Pending</div>
                      <div class="financial-value" id="pendingCount">0</div>
                      <div class="financial-amount" id="pendingAmount">$0</div>
                    </div>
                    <div class="financial-item">
                      <div class="financial-label">Overdue</div>
                      <div class="financial-value" id="overdueCount">0</div>
                      <div class="financial-amount" id="overdueAmount">$0</div>
                    </div>
                    <div class="financial-item">
                      <div class="financial-label">Draft</div>
                      <div class="financial-value" id="draftCount">0</div>
                      <div class="financial-amount" id="draftAmount">$0</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="card">
                  <h3>Proposal Status Breakdown</h3>
                  <div class="financial-grid">
                    <div class="financial-item">
                      <div class="financial-label">Accepted</div>
                      <div class="financial-value" id="acceptedCount">0</div>
                      <div class="financial-amount" id="acceptedValue">$0</div>
                    </div>
                    <div class="financial-item">
                      <div class="financial-label">Pending</div>
                      <div class="financial-value" id="pendingProposalCount">0</div>
                      <div class="financial-amount" id="pendingProposalValue">$0</div>
                    </div>
                    <div class="financial-item">
                      <div class="financial-label">Draft</div>
                      <div class="financial-value" id="draftProposalCount">0</div>
                      <div class="financial-amount" id="draftProposalValue">$0</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Analytics Charts Section -->
          <div class="tab-section">
            <div class="row">
              <div class="col-6">
                <div class="card">
                  <div class="flex justify-between">
                    <h3>Revenue Trends</h3><span class="mini">Monthly breakdown</span>
                  </div>
                  <div class="chart-container">
                    <canvas id="revenueChart" width="400" height="200"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="card">
                  <div class="flex justify-between">
                    <h3>Proposal Success Rate</h3><span class="mini">Conversion analysis</span>
                  </div>
                  <div class="chart-container">
                    <canvas id="successChart" width="400" height="200"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-6">
                <div class="card">
                  <div class="flex justify-between">
                    <h3>Client Performance</h3><span class="mini">Top revenue sources</span>
                  </div>
                  <div class="chart-container">
                    <canvas id="clientChart" width="400" height="200"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="card">
                  <div class="flex justify-between">
                    <h3>Invoice Status Distribution</h3><span class="mini">Payment overview</span>
                  </div>
                  <div class="chart-container">
                    <canvas id="statusChart" width="400" height="200"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>


      </div>

      <!-- CONTACTS -->
        <div id="route-contacts" class="page" data-route hidden>
          <div class="tab-section">
          <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="flex justify-between"><h3>All Contacts</h3>
                    <div class="flex" style="gap:8px">
                      <button id="c_bulk_toggle" class="btn small secondary" onclick="toggleBulk('c')">Bulk</button>
                      <button id="c_bulk_delete" class="btn small danger" style="display:none" onclick="bulkDelete('c')">Delete</button>
                      <input id="contactSearch" class="mini" type="text" placeholder="Search.." oninput="renderContacts()" />
                      <button class="btn" onclick="openContactModal()">New</button>
          </div>
          </div>
                  <div id="contactsList" class="list" style="margin-top:10px"></div>
        </div>
          </div>
            </div>
        </div>
      </div>

      <!-- DOCS (List) -->
      <div id="route-docs" class="page" data-route hidden>
        <div class="tab-section">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="flex justify-between">
                  <h3>Docs</h3>
                  <div class="flex" style="gap:8px">
                    <button class="btn small" onclick="docsNewPage()">New Page</button>
                    <button class="btn small secondary" onclick="docsExport()">Export</button>
                    <button class="btn small secondary" onclick="debugBlockNote()">Debug</button>
                  </div>
                </div>
                <div id="docsList" class="list" style="margin-top:10px"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- DOCS EDITOR (Full Page) -->
      <div id="route-doc" class="page" data-route hidden>
        <div class="tab-section">
          <div class="card">
            <div class="flex justify-between">
              <h3>Document</h3>
              <div class="flex" style="gap:8px">
                <button class="btn small secondary" onclick="goto('docs')">Back</button>
              </div>
            </div>
            <div class="row" style="margin-top:12px">
              <div class="col-12">
                <div style="margin-bottom:16px"><input id="docsTitle" type="text" placeholder="Untitled" oninput="docsTouch()" /></div>
              </div>
              <div class="col-12">
                              <div class="editor">
                <div id="docs_editor" class="blocknote-editor" data-placeholder="Start writing..."></div>
              </div>
                <div class="mini" id="docsHint"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
        <!-- PROPOSALS (List only) -->
        <div id="route-proposals" class="page" data-route hidden>
          <div class="tab-section">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="flex justify-between"><h3>All Proposals</h3>
                    <div class="flex" style="gap:8px">
                      <input id="proposalSearch" class="mini" type="text" placeholder="Search.." oninput="renderProposals()" />
                      <select id="proposalFilter" onchange="renderProposals()"><option value="">All</option><option>Draft</option><option>Sent</option><option>Accepted</option><option>Declined</option></select>
                      <button class="btn" onclick="startNewProposal()">New</button>
                    </div>
                  </div>
                  <div id="proposalsList" class="list" style="margin-top:10px"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PROPOSAL (Full page editor) -->
        <div id="route-proposal" class="page" data-route hidden>
          <div class="tab-section">
            <div class="card">
              <div class="flex justify-between"><h3>Proposal</h3><div class="flex" style="gap:8px"><button class="btn small secondary" onclick="goto('proposals')">Back</button><button class="btn small" id="saveProposal">Save</button><button class="iconbtn" title="Undo" onclick="historyStep('p','undo')"><i data-feather="rotate-ccw"></i></button><button class="iconbtn" title="Redo" onclick="historyStep('p','redo')"><i data-feather="rotate-cw"></i></button><button class="iconbtn" title="History" onclick="openHistory()"><i data-feather="clock"></i></button><button class="btn small secondary" onclick="toggleViewMode('p')" id="viewModeBtn_p"><i data-lucide="eye"></i> View</button><button class="btn small secondary" onclick="printSection('proposalPrint')">Export PDF</button></div></div>
          <div class="proposal-header">
            <div class="field">
              <label>TITLE</label>
              <input id="p_title" type="text" placeholder="Enter proposal title" />
            </div>
            <div class="field">
              <label>CLIENT</label>
              <div class="input-with-icon">
                <select id="p_client"><option value="">Select client</option></select>
                <i data-lucide="chevron-down"></i>
              </div>
            </div>
            <div class="field">
              <label>DATE</label>
              <div class="input-with-icon">
                <input id="p_date" type="date" />
                <i data-lucide="calendar"></i>
              </div>
            </div>
          </div>
                                  <div class="col-12">
                    <div id="p_doc_header" class="doc-header" style="margin-bottom:16px"></div>
                  </div>
                  
                  <!-- Proposal description editor above pricing -->
                  <div class="col-12">
                    <div class="editor">
                      <div id="proposal_description_editor" class="blocknote-editor" data-placeholder="Describe your proposal here..."></div>
                    </div>
                  </div>
                  
              <div class="col-12">
                <div class="flex justify-between"><strong>Pricing</strong></div>
              <table id="p_table" style="margin-top:10px">
                    <thead><tr><th style="width:50px">On</th><th>Item</th><th style="width:100px">Qty</th><th style="width:120px">Amount</th><th style="width:100px">Total</th><th style="width:40px"></th></tr></thead>
                <tbody></tbody>
                <tfoot>
                      <tr><td colspan="3" class="mini"><button class="iconbtn tiny" onclick="editLabel('p_discount_label')" title="Rename"><i data-lucide="edit-2"></i></button> <span id="p_discount_label">Discount %</span></td><td><span class="numwrap"><input class="small" type="number" id="p_discount" min="0" max="100" value="0" oninput="calc('p')"><span class="spin"><button onclick="stepInput(this,-1,1); calc('p')">▾</button><button onclick="stepInput(this,1,1); calc('p')">▴</button></span></span></td><td></td></tr>
                      <tr><td colspan="3" class="mini"><button class="iconbtn tiny" onclick="editLabel('p_tax_label')" title="Rename"><i data-lucide="edit-2"></i></button> <span id="p_tax_label">Tax %</span></td><td><span class="numwrap"><input class="small" type="number" id="p_tax" min="0" max="100" value="0" oninput="calc('p')"><span class="spin"><button onclick="stepInput(this,-1,1); calc('p')">▾</button><button onclick="stepInput(this,1,1); calc('p')">▴</button></span></span></td><td></td></tr>
                  <tr><td colspan="3" class="mini">Total</td><td id="p_total">—</td><td></td></tr>
                </tfoot>
              </table>
              <div id="p_prototype" class="prototype-row" onclick="addRow('p')">+ Add a line item</div>
            </div>
            <div class="col-12"></div>
            
            <!-- Proposal terms and additional content editor below pricing -->
            <div class="col-12">
              <div class="editor">
                <div id="proposal_terms_editor" class="blocknote-editor" data-placeholder="Add terms, conditions, and additional information here..."></div>
              </div>
            </div>
            
            <div class="col-12">
                  <span class="mini" id="proposalFormHint"></span>
              </div>
              </div>
            </div>
        </div>
        </div>

        <!-- INVOICES (List only) -->
        <div id="route-invoices" class="page" data-route hidden>
          <div class="tab-section">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="flex justify-between"><h3>All Invoices</h3>
            <div class="flex" style="gap:8px">
                      <button id="i_bulk_toggle" class="btn small secondary" onclick="toggleBulk('i')">Bulk</button>
                      <button id="i_bulk_delete" class="btn small danger" style="display:none" onclick="bulkDelete('i')">Delete</button>
                      <input id="invoiceSearch" class="mini" type="text" placeholder="Search.." oninput="renderInvoices()" />
                      <select id="invoiceFilter" onchange="renderInvoices()"><option value="">All</option><option>Paid</option><option>Unpaid</option><option>Overdue</option></select>
                      <button class="btn" onclick="startNewInvoice()">New</button>
            </div>
          </div>
                  <div id="invoicesList" class="list" style="margin-top:10px"></div>
                </div>
              </div>
            </div>
        </div>
      </div>

        <!-- INVOICE (Full page editor) -->
        <div id="route-invoice" class="page" data-route hidden>
          <div class="tab-section">
            <div class="card">
              <div class="flex justify-between">
                <h3>Invoice</h3>
                <div class="flex" style="gap:8px">
                  <button class="btn small secondary" onclick="goto('invoices')">Back</button>
                  <button class="btn small" id="saveInvoice">Save</button>
                  <button class="iconbtn" title="Undo" onclick="historyStep('i','undo')"><i data-feather="rotate-ccw"></i></button>
                  <button class="iconbtn" title="Redo" onclick="historyStep('i','redo')"><i data-feather="rotate-cw"></i></button>
                  <button class="iconbtn" title="History" onclick="openHistory()"><i data-feather="clock"></i></button>
                  <button class="btn small secondary" onclick="printSection('invoicePrint')">Export PDF</button>
                </div>
              </div>
              
              <div class="row">
            <div class="col-6"><label>Invoice #<input id="i_number" type="text" placeholder="INV-2025-001" /></label></div>
            <div class="col-6"><label>Status<select id="i_status"><option>Draft</option><option>Sent</option><option>Paid</option><option>Overdue</option></select></label></div>
            <div class="col-8"><label>Client<select id="i_client"></select></label></div>
            <div class="col-4"><label>Date<input id="i_date" type="date" /></label></div>
                <div class="col-12">
                  <div class="editor">
                    
                  </div>
                </div>
            <div class="col-12">
              <div class="flex justify-between"><strong>Line Items</strong><button class="btn small secondary" onclick="addRow('i')">+ Line</button></div>
              <table id="i_table" style="margin-top:10px">
                    <thead><tr><th>On</th><th>Description</th><th style="width:110px">Qty</th><th>Rate</th><th>Amount</th><th></th></tr></thead>
                <tbody></tbody>
                <tfoot>
                      <tr><td colspan="3" class="mini"><button class="iconbtn" onclick="editLabel('i_discount_label')" title="Rename"><i data-feather="edit-2"></i></button> <span id="i_discount_label">Discount %</span></td><td><span class="numwrap"><input type="number" id="i_discount" min="0" max="100" value="0" oninput="calc('i')"><span class="spin"><button onclick="stepInput(this,-1,1); calc('i')">▾</button><button onclick="stepInput(this,1,1); calc('i')">▴</button></span></span></td><td></td></tr>
                      <tr><td colspan="3" class="mini"><button class="iconbtn" onclick="editLabel('i_tax_label')" title="Rename"><i data-feather="edit-2"></i></button> <span id="i_tax_label">Tax %</span></td><td><span class="numwrap"><input type="number" id="i_tax" min="0" max="100" value="0" oninput="calc('i')"><span class="spin"><button onclick="stepInput(this,-1,1); calc('i')">▾</button><button onclick="stepInput(this,1,1); calc('i')">▴</button></span></span></td><td></td></tr>
                  <tr><td colspan="3" class="mini">Total</td><td id="i_total">—</td><td></td></tr>
                </tfoot>
              </table>
            </div>
                <div class="col-12">
                  <div class="editor">
                    
                  </div>
                </div>
                <div class="col-12"><span class="mini" id="invoiceFormHint"></span></div>
          </div>
          </div>
        </div>
      </div>

      <!-- SETTINGS -->
        <div id="route-settings" class="page settings-page" data-route hidden>
          <div class="tab-section">
            <div class="row">
              <div class="col-6">
                <div class="card">
          <h3>Branding</h3>
          <div class="row">
            <div class="col-6"><label>Business Name<input id="set_biz" type="text" /></label></div>
            <div class="col-6"><label>Email<input id="set_email" type="email" /></label></div>
            <div class="col-12"><label>Address<textarea id="set_addr"></textarea></label></div>
          </div>
          <div class="flex" style="margin-top:10px"><button class="btn small" id="saveSettings">Save</button></div>
        </div>
              </div>
              <div class="col-6">
                <div class="card">
                  <h3>Preferences</h3>
                  <div class="row">
                    <div class="col-6"><label>Language<select id="set_lang"><option value="en">English</option><option value="ar">Arabic (RTL)</option></select></label></div>
                  </div>
                </div>

                <div class="card">
                  <h3>Currency & Rates</h3>
                  <div class="row">
                    <div class="col-8"><label>Currency<select id="set_currency"><option>USD</option><option>EUR</option><option>EGP</option><option>SAR</option><option>AED</option><option>GBP</option></select></label></div>
                    <div class="col-4"><label>&nbsp;<button class="btn small secondary" id="refreshRates" style="width:100%">Refresh</button></label></div>
                  </div>
                  <div id="fxRates" class="mini" style="margin-top:10px"></div>
                  <div id="fxMeta" class="mini" style="margin-top:6px"></div>
                  <div id="fxManual" style="margin-top:10px"></div>
                  <div class="flex" style="gap:8px; margin-top:8px">
                    <button class="btn small" id="saveManualRates">Save Rates</button>
                  </div>
                </div>

                <div class="card">
          <h3>Data</h3>
          <div class="flex" style="gap:8px">
            <button class="btn small secondary" onclick="seed()">Load Sample</button>
            <button class="btn small danger" onclick="wipe()">Delete All</button>
            <button class="btn small secondary" id="downloadBtn">Download this page</button>
          </div>
          <div class="mini" style="margin-top:10px">LocalStorage only. Private on your device.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PRINT TEMPLATES -->
      <div id="proposalPrint" hidden></div>
      <div id="invoicePrint" hidden></div>

      <!-- View Modal -->
      <div id="viewModal" hidden>
        <div class="card" style="max-width:820px; margin:40px auto">
          <div class="flex justify-between">
            <h3 id="viewTitle">View</h3>
            <button class="btn small secondary" id="closeView">Close</button>
          </div>
          <div id="viewBody" style="margin-top:10px"></div>
        </div>
      </div>



      <!-- Contact Modal -->
      <div id="contactModal" hidden>
        <div class="card" style="max-width:600px; width:100%">
          <div class="flex justify-between"><h3 id="contactModalTitle"></h3><button class="btn small secondary" onclick="closeContactModal()">Close</button></div>
          <div class="row" style="margin-top:16px">
            <div class="col-6"><label>Name<input id="c_name" type="text" /></label></div>
            <div class="col-6"><label>Company<input id="c_company" type="text" /></label></div>
            <div class="col-6"><label>Email<input id="c_email" type="email" /></label></div>
            <div class="col-6"><label>Phone<input id="c_phone" type="tel" /></label></div>
            <div class="col-12"><label>Tags<input id="c_tags" type="text" placeholder="SaaS, Retainer" /></label></div>
            <div class="col-12"><label>Notes<textarea id="c_notes"></textarea></label></div>
          </div>
          <div class="flex" style="margin-top:16px; gap:8px">
            <button class="btn small" id="saveContact">Save</button>
            <button class="btn small secondary" id="clearContact">Clear</button>
            <span class="mini" id="contactFormHint"></span>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
<!-- Right sidebar -->
<aside class="rail">
  <div class="rail-top" style="flex-direction:column; gap:10px; align-items:center">
    <button class="iconbtn" title="Settings" onclick="goto('settings')">
      <i data-lucide="settings"></i>
    </button>
    <div class="theme-toggle-container">
      <button class="theme-toggle" id="themeToggle" title="Toggle theme">
        <div class="toggle-track">
          <div class="toggle-thumb">
            <i data-lucide="sun" class="sun-icon"></i>
            <i data-lucide="moon" class="moon-icon"></i>
          </div>
        </div>
      </button>
    </div>
  </div>
  <div class="rail-bottom">
    <button class="iconbtn" title="Version History" onclick="console.log('Clock clicked'); openHistoryPanel();">
      <i data-lucide="clock"></i>
    </button>
  </div>
</aside>

<!-- History Panel Modal -->
<div id="historyModal" class="modal" style="display: none;">
  <div class="modal-content" style="max-width: 600px; max-height: 80vh;">
    <div class="modal-header">
      <h3>Version History</h3>
      <button class="close-btn" onclick="closeHistoryPanel()">
        <i data-lucide="x"></i>
    </button>
    </div>
    <div class="modal-body">
      <div class="history-controls">
        <div class="autosave-toggle">
          <label class="toggle-label">
            <input type="checkbox" id="autosaveToggle" checked onchange="toggleAutosave(this.checked)">
            <span class="toggle-text">Auto-save every 17 seconds</span>
          </label>
        </div>
        <div class="history-buttons">
          <button class="btn small secondary" onclick="createCheckpoint()">
            <i data-lucide="save"></i> Create Checkpoint
          </button>
          <button class="btn small danger" onclick="clearAllHistory()">
            <i data-lucide="trash-2"></i> Clear All
          </button>
          <button class="btn small" onclick="testStorage()">
            <i data-lucide="bug"></i> Test Storage
    </button>
        </div>
      </div>
      <div id="historyList" class="history-list">
        <div class="loading">Loading history...</div>
      </div>
    </div>
  </div>
</div>

<!-- Version Preview Modal -->
<div id="previewModal" class="modal" style="display: none;">
  <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
    <div class="modal-header">
      <h3>Version Preview</h3>
      <button class="close-btn" onclick="closePreviewModal()">
        <i data-lucide="x"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="previewContent" class="preview-content">
        <div class="loading">Loading preview...</div>
      </div>
      <div class="preview-actions">
        <button class="btn" onclick="restoreVersion()">
          <i data-lucide="rotate-ccw"></i> Restore This Version
        </button>
        <button class="btn small secondary" onclick="closePreviewModal()">
          Cancel
        </button>
      </div>
    </div>
  </div>
  </div>
</aside>

<script>
feather.replace();
lucide.createIcons();

// Test BlockNote functionality
function testBlockNote() {
  console.log('Testing BlockNote...');
  
  if (window.BlockNoteEditor) {
    console.log('✅ BlockNote core is loaded');
    
    // Test creating a simple editor
    try {
      const testContainer = document.createElement('div');
      testContainer.id = 'test-editor';
      testContainer.style.cssText = 'width: 300px; height: 200px; border: 1px solid #ccc; margin: 20px;';
      document.body.appendChild(testContainer);
      
      const editor = window.BlockNoteEditor.create();
      editor.mount(testContainer);
      
      console.log('✅ BlockNote editor created successfully');
      
      // Remove test editor after 3 seconds
      setTimeout(() => {
        if (testContainer.parentNode) {
          testContainer.parentNode.removeChild(testContainer);
        }
      }, 3000);
      
    } catch (error) {
      console.error('❌ Failed to create BlockNote editor:', error);
    }
  } else {
    console.error('❌ BlockNote core not available');
  }
}

// Docs feature
const docs = { pages: [], currentId: null };

function docsLoad(){ 
  try{ 
    const raw=localStorage.getItem('crm_docs'); 
    if(raw){ 
      const j=JSON.parse(raw); 
      docs.pages=j.pages||[]; 
      docs.currentId=j.currentId||null;
    } 
  }catch(_){ } 
}

function docsPersist(){ 
  localStorage.setItem('crm_docs', JSON.stringify({pages:docs.pages,currentId:docs.currentId})); 
}

function renderDocsList(){ 
  const list=document.getElementById('docsList'); 
  if(!list) return; 
  if(!docs.pages.length){ 
    list.innerHTML='<div class="mini" style="padding:12px">No pages yet</div>'; 
    return;
  } 
  list.innerHTML=docs.pages.map(p=>`<div class="history-item" onclick="docsOpen('${p.id}')"><div class="history-info"><div class="history-time">${esc(p.title||'Untitled')}</div><div class="history-size mini">${(p.edData?.blocks?.length||0)} blocks</div></div></div>`).join(''); 
}

function docsNewPage(){ 
  const id=uid(); 
  const page={id,title:'Untitled',edData:{blocks:[]}}; 
  docs.pages.push(page); 
  docs.currentId=id; 
  docsPersist(); 
  renderDocsList(); 
  docsOpen(id); 
}

function docsExport(){ 
  const p=docs.pages.find(p=>p.id===docs.currentId); 
  if(!p) return; 
  const blob=new Blob([JSON.stringify(p,null,2)],{type:'application/json'}); 
  const a=document.createElement('a'); 
  a.href=URL.createObjectURL(blob); 
  a.download=(p.title||'doc')+'.json'; 
  a.click(); 
  setTimeout(()=>URL.revokeObjectURL(a.href),1500); 
}

function docsTouch(){ 
  const t=document.getElementById('docsTitle'); 
  const p=docs.pages.find(p=>p.id===docs.currentId); 
  if(!p||!t) return; 
  p.title=t.value; 
  docsPersist(); 
  renderDocsList(); 
}

function docsSaveNow(){ 
  docsPersist(); 
  const h=document.getElementById('docsHint'); 
  if(h) h.textContent='Saved'; 
}

function docsOpen(id){ 
  const p=docs.pages.find(p=>p.id===id); 
  if(!p) return; 
  docs.currentId=id; 
  docsPersist(); 
  goto('doc'); 
  
  // Wait for DOM to be ready
  setTimeout(() => {
    const t=document.getElementById('docsTitle'); 
    if(t) t.value=p.title||''; 
    try{ 
      mountDocsEditor('docs_editor', p.edData);
    }catch(e){ 
      console.error('Docs editor mount failed', e);
    } 
    const hint=document.getElementById('docsHint'); 
    if(hint) hint.textContent='Loaded'; 
  }, 100);
}

let __docsAutosaveTimer=null; 
function docsScheduleAutosave(){
  clearTimeout(__docsAutosaveTimer);
  __docsAutosaveTimer = setTimeout(async ()=>{
    try{
      const id = docs.currentId;
      if(!id) return;
      const p = docs.pages.find(x=>x.id===id);
      if(!p) return;

      if (window.__editorjs_instance) {
        // Save Editor.js data
        const data = await window.__editorjs_instance.save();
        p.edData = data;
      } else {
        // Legacy BlockNote path
        const ed = window.__bn_instances?.docs_editor?.document;
        if (ed) p.edData = ed;
      }

      docsPersist();
      const h = document.getElementById('docsHint');
      if (h) h.textContent = 'Saved';
    } catch(_){}
  }, 800);
}

// Debug function to check BlockNote status
function debugBlockNote() {
  console.log('=== BlockNote Debug ===');
  console.log('BlockNote global:', window.BlockNote);
  console.log('BlockNoteEditor:', window.BlockNoteEditor);
  console.log('BlockNote core loaded:', !!window.BlockNoteEditor);
  console.log('Current docs state:', docs);
  console.log('Current route:', window.currentRoute);
  console.log('Docs editor element:', document.getElementById('docs_editor'));
  console.log('Docs toolbar element:', document.getElementById('docs_toolbar'));
}
function mountDocsEditor(holderId, initialJSON){
  const el = document.getElementById(holderId);
  if(!el) return;
  
  // Clear container
  el.innerHTML = '';
  // NEW: Replace BlockNote with Editor.js
  try {
    const data = initialJSON && initialJSON.blocks ? initialJSON : { blocks: [] };
    if (!window.EditorJS) throw new Error('EditorJS not loaded');

    const tools = {};
    const alignmentTuneKey = 'alignmentTune';
    const hasAlignment = !!window.AlignmentTuneTool;

    if (window.Header) tools.header = { class: window.Header, inlineToolbar: ['bold','italic','link'], ...(hasAlignment ? { tunes: [alignmentTuneKey] } : {}) };
    // Paragraph is the default tool in Editor.js; include only if plugin is available
    if (window.Paragraph) tools.paragraph = { class: window.Paragraph, inlineToolbar: true, ...(hasAlignment ? { tunes: [alignmentTuneKey] } : {}) };
    if (window.List) tools.list = { class: window.List, inlineToolbar: true, ...(hasAlignment ? { tunes: [alignmentTuneKey] } : {}) };
    if (window.Checklist) tools.checklist = { class: window.Checklist, inlineToolbar: true, ...(hasAlignment ? { tunes: [alignmentTuneKey] } : {}) };
    if (window.Quote) tools.quote = { class: window.Quote, inlineToolbar: true, ...(hasAlignment ? { tunes: [alignmentTuneKey] } : {}) };
    if (window.CodeTool) tools.code = window.CodeTool;
    if (window.InlineCode) tools.inlineCode = window.InlineCode;
    if (window.Marker) tools.marker = window.Marker;
    if (window.Underline) tools.underline = window.Underline;
    if (window.Delimiter) tools.delimiter = window.Delimiter;
    if (window.Table) tools.table = window.Table;
    if (window.LinkTool) tools.linkTool = window.LinkTool;
    if (window.AttachesTool) tools.attaches = window.AttachesTool;
    if (window.ImageTool) tools.image = { class: window.ImageTool, config: { uploader: { uploadByFile(file){ return new Promise((resolve)=>{ const r=new FileReader(); r.onload=()=>resolve({success:1,file:{url:r.result}}); r.readAsDataURL(file); }); }, uploadByUrl(url){ return Promise.resolve({success:1,file:{url}}); } } } };
    if (hasAlignment) tools[alignmentTuneKey] = { class: window.AlignmentTuneTool, config: { default: 'left' } };
    if (window.TextAlign) tools.textAlign = window.TextAlign;

    const missing = ['Header','Paragraph','List','Checklist','Quote','CodeTool','InlineCode','Marker','Underline','Delimiter','Table','LinkTool','AttachesTool','ImageTool','AlignmentTuneTool','TextAlign']
      .filter(name => !window[name]);
    if (missing.length) console.warn('Editor.js tools missing (continuing without them):', missing);

    window.__editorjs_instance = new window.EditorJS({
      holder: holderId,
      autofocus: true,
      minHeight: 400,
      data,
      tools,
      onChange(){ docsScheduleAutosave(); },
      onReady: () => {
        // Initialize drag and drop functionality
        if (window.DragDrop) {
          new window.DragDrop(window.__editorjs_instance);
          console.log('✅ Drag and Drop plugin initialized');
        }
      }
    });
    console.log('Editor.js mounted');
    return;
  } catch (e) {
    console.error('Failed to init Editor.js, fallback to simple editor', e);
  }
  
  // Check if BlockNote is available
  if(!window.BlockNoteEditor || !window.BlockNoteAvailable){
    console.log('BlockNote not available, using enhanced local editor');
    mountFallbackEditor(holderId, initialJSON);
    return;
  }
  
  try {
    console.log('Creating BlockNote editor...');
    
    // Create editor with proper options
    const editor = window.BlockNoteEditor.create({
      initialContent: initialJSON?.blocks?.length ? initialJSON.blocks : undefined
    });
    
    // Use the current API for content change events
    editor.onChange(() => docsScheduleAutosave());
    
    console.log('Editor created, mounting...');
    
    // Mount to container
    editor.mount(el);
    
    console.log('Editor mounted successfully');
    
    // Ensure theme is applied and editor is visible
    setTimeout(() => {
      // Apply theme if available
      if (typeof applyBlockNoteTheme === 'function') {
        applyBlockNoteTheme();
      }
      
      // Force editor to be visible
      const proseMirror = el.querySelector('.ProseMirror');
      if (proseMirror) {
        proseMirror.style.minHeight = '400px';
        proseMirror.style.outline = 'none';
        proseMirror.style.padding = '16px';
        console.log('✅ ProseMirror editor styled and visible');
      }
      
      // Ensure toolbar is visible
      const toolbar = el.querySelector('.bn-float-menu');
      if (toolbar) {
        toolbar.style.display = 'block';
        toolbar.style.zIndex = '1000';
        console.log('✅ BlockNote toolbar visible');
      }
    }, 100);
    
    // === Proper BlockNote Vanilla UI Implementation ===
    
    // 1. Formatting Toolbar (floating when text is selected)
    (function initFormattingToolbar(){
      let toolbarEl = null;
      
      function createToolbar(){
        if(toolbarEl) return toolbarEl;
        
        toolbarEl = document.createElement('div');
        toolbarEl.className = 'bn-formatting-toolbar';
        toolbarEl.style.cssText = `
          position: absolute;
          display: none;
          background: white;
          border: 1px solid #ddd;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          padding: 6px;
          gap: 4px;
          z-index: 10000;
          align-items: center;
          justify-content: center;
          backdrop-filter: blur(8px);
          white-space: nowrap;
        `;
        
        const buttons = [
          { label: 'B', action: () => editor.addStyles({ bold: true }), title: 'Bold' },
          { label: 'I', action: () => editor.addStyles({ italic: true }), title: 'Italic' },
          { label: 'U', action: () => editor.addStyles({ underline: true }), title: 'Underline' },
          { label: 'H1', action: () => { const {block}=editor.getTextCursorPosition(); editor.updateBlock(block,{type:'heading', props:{level:1}}); }, title: 'Heading 1' },
          { label: 'H2', action: () => { const {block}=editor.getTextCursorPosition(); editor.updateBlock(block,{type:'heading', props:{level:2}}); }, title: 'Heading 2' },
          { label: 'H3', action: () => { const {block}=editor.getTextCursorPosition(); editor.updateBlock(block,{type:'heading', props:{level:3}}); }, title: 'Heading 3' },
          { label: '•', action: () => { const {block}=editor.getTextCursorPosition(); editor.updateBlock(block,{type:'bulletListItem'}); }, title: 'Bullet List' },
          { label: '1.', action: () => { const {block}=editor.getTextCursorPosition(); editor.updateBlock(block,{type:'numberedListItem'}); }, title: 'Numbered List' }
        ];
        
        buttons.forEach(btn => {
          const button = document.createElement('button');
          button.textContent = btn.label;
          button.title = btn.title;
          button.style.cssText = `
            padding: 6px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 32px;
          `;
          button.addEventListener('mouseenter', () => {
            button.style.background = '#f0f0f0';
            button.style.borderColor = '#999';
          });
          button.addEventListener('mouseleave', () => {
            button.style.background = 'white';
            button.style.borderColor = '#ddd';
          });
          button.addEventListener('mousedown', (e) => e.preventDefault());
          button.addEventListener('click', (e) => {
            e.preventDefault();
            btn.action();
          });
          toolbarEl.appendChild(button);
        });
        
        document.body.appendChild(toolbarEl);
        return toolbarEl;
      }
      
      // Use BlockNote's built-in formatting toolbar state
      editor.formattingToolbar.onUpdate((state) => {
        const toolbar = createToolbar();
        
        if (state.show) {
          toolbar.style.display = 'flex';
          // Position above the selected text
          const top = state.referencePos.top - toolbar.offsetHeight - 8 + window.scrollY;
          const left = state.referencePos.x + window.scrollX;
          
          toolbar.style.top = `${top}px`;
          toolbar.style.left = `${left}px`;
        } else {
          toolbar.style.display = 'none';
        }
      });
    })();
    
    // 2. Suggestion Menu (Slash Commands) - Proper BlockNote implementation
    (function initSuggestionMenu(){
      let suggestionEl = null;
      
      function createSuggestionMenu(){
        if(suggestionEl) return suggestionEl;
        
        suggestionEl = document.createElement('div');
        suggestionEl.className = 'bn-suggestion-menu';
        suggestionEl.style.cssText = `
          position: absolute;
          display: none;
          background: white;
          border: 1px solid #ddd;
          border-radius: 8px;
          box-shadow: 0 8px 24px rgba(0,0,0,0.15);
          padding: 8px;
          z-index: 10001;
          min-width: 240px;
          max-height: 320px;
          overflow-y: auto;
          backdrop-filter: blur(8px);
        `;
        
        const items = [
          { icon: 'H1', label: 'Heading 1', description: 'Large section heading', action: () => { const {block}=editor.getTextCursorPosition(); editor.updateBlock(block,{type:'heading', props:{level:1}}); } },
          { icon: 'H2', label: 'Heading 2', description: 'Medium section heading', action: () => { const {block}=editor.getTextCursorPosition(); editor.updateBlock(block,{type:'heading', props:{level:2}}); } },
          { icon: 'H3', label: 'Heading 3', description: 'Small section heading', action: () => { const {block}=editor.getTextCursorPosition(); editor.updateBlock(block,{type:'heading', props:{level:3}}); } },
          { icon: '•', label: 'Bullet List', description: 'Create a bulleted list', action: () => { const {block}=editor.getTextCursorPosition(); editor.updateBlock(block,{type:'bulletListItem'}); } },
          { icon: '1.', label: 'Numbered List', description: 'Create a numbered list', action: () => { const {block}=editor.getTextCursorPosition(); editor.updateBlock(block,{type:'numberedListItem'}); } },
          { icon: '"', label: 'Quote', description: 'Capture a quote', action: () => { const {block}=editor.getTextCursorPosition(); editor.updateBlock(block,{type:'quote'}); } },
          { icon: '</>', label: 'Code Block', description: 'Capture a code snippet', action: () => { const {block}=editor.getTextCursorPosition(); editor.updateBlock(block,{type:'codeBlock'}); } },
          { icon: '—', label: 'Divider', description: 'Add a horizontal line', action: () => { const {block}=editor.getTextCursorPosition(); editor.insertBlocks([{type:'horizontalRule'}], block, 'after'); } }
        ];
        
        items.forEach((item, index) => {
          const itemEl = document.createElement('div');
          itemEl.className = 'suggestion-item';
          itemEl.style.cssText = `
            padding: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 6px;
            transition: background 0.2s;
            border: 2px solid transparent;
          `;
          
          itemEl.innerHTML = `
            <div style="
              width: 32px;
              height: 32px;
              background: #f0f0f0;
              border-radius: 6px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: bold;
              font-size: 14px;
              color: #666;
            ">${item.icon}</div>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 14px; color: #333; margin-bottom: 2px;">${item.label}</div>
              <div style="font-size: 12px; color: #666;">${item.description}</div>
            </div>
          `;
          
          itemEl.addEventListener('mouseenter', () => {
            itemEl.style.background = '#f8f9fa';
            itemEl.style.borderColor = '#007bff';
          });
          
          itemEl.addEventListener('mouseleave', () => {
            itemEl.style.background = 'transparent';
            itemEl.style.borderColor = 'transparent';
          });
          
          itemEl.addEventListener('click', () => {
            item.action();
            suggestionEl.style.display = 'none';
          });
          
          // Keyboard navigation
          itemEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              item.action();
              suggestionEl.style.display = 'none';
            }
          });
          
          itemEl.setAttribute('tabindex', '0');
          itemEl.setAttribute('role', 'option');
          itemEl.setAttribute('aria-selected', 'false');
          
          suggestionEl.appendChild(itemEl);
        });
        
        document.body.appendChild(suggestionEl);
        return suggestionEl;
      }
      
      // Use BlockNote's built-in suggestion menu state
      editor.suggestionMenus.onUpdate('/', (state) => {
        const menu = createSuggestionMenu();
        
        if (state.show) {
          menu.style.display = 'block';
          // Position below the cursor
          const top = state.referencePos.top + 20 + window.scrollY;
          const left = state.referencePos.x + window.scrollX;
          
          menu.style.top = `${top}px`;
          menu.style.left = `${left}px`;
          
          // Focus first item
          const firstItem = menu.querySelector('.suggestion-item');
          if (firstItem) {
            firstItem.focus();
            firstItem.setAttribute('aria-selected', 'true');
          }
        } else {
          menu.style.display = 'none';
        }
      });
      
      // Hide when clicking outside
      document.addEventListener('click', (e) => {
        if (suggestionEl && !suggestionEl.contains(e.target)) {
          suggestionEl.style.display = 'none';
        }
      });
    })();
    
    // 3. Side Menu (+ button and drag handle) - Proper BlockNote implementation
    (function initSideMenu(){
      let sideMenuEl = null;
      
      function createSideMenu(){
        if(sideMenuEl) return sideMenuEl;
        
        sideMenuEl = document.createElement('div');
        sideMenuEl.className = 'bn-side-menu';
        sideMenuEl.style.cssText = `
          position: absolute;
          display: none;
          background: white;
          border: 1px solid #ddd;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          padding: 4px;
          z-index: 10002;
          flex-direction: column;
          gap: 4px;
          backdrop-filter: blur(8px);
        `;
        
        // Add button (+)
        const addBtn = document.createElement('button');
        addBtn.innerHTML = '+';
        addBtn.title = 'Add block';
        addBtn.style.cssText = `
          width: 28px;
          height: 28px;
          border: none;
          background: #007bff;
          color: white;
          border-radius: 6px;
          cursor: pointer;
          font-size: 18px;
          font-weight: bold;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s;
        `;
        addBtn.addEventListener('mouseenter', () => {
          addBtn.style.background = '#0056b3';
        });
        addBtn.addEventListener('mouseleave', () => {
          addBtn.style.background = '#007bff';
        });
        addBtn.addEventListener('click', () => {
          // Open suggestion menu at current block
          editor.openSuggestionMenu('/');
        });
        
        // Drag handle
        const dragBtn = document.createElement('button');
        dragBtn.innerHTML = '⋮⋮';
        dragBtn.title = 'Drag to reorder';
        dragBtn.style.cssText = `
          width: 28px;
          height: 28px;
          border: none;
          background: #6c757d;
          color: white;
          border-radius: 6px;
          cursor: grab;
          font-size: 12px;
          font-weight: bold;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s;
        `;
        dragBtn.addEventListener('mouseenter', () => {
          dragBtn.style.background = '#5a6268';
        });
        dragBtn.addEventListener('mouseleave', () => {
          dragBtn.style.background = '#6c757d';
        });
        dragBtn.addEventListener('dragstart', (evt) => {
          editor.sideMenu.blockDragStart(evt, sideMenuState.block);
        });
        dragBtn.addEventListener('dragend', () => {
          editor.sideMenu.blockDragEnd();
        });
        dragBtn.draggable = true;
        
        sideMenuEl.appendChild(addBtn);
        sideMenuEl.appendChild(dragBtn);
        document.body.appendChild(sideMenuEl);
        return sideMenuEl;
      }
      
      // Use BlockNote's built-in side menu state
      editor.sideMenu.onUpdate((sideMenuState) => {
        const menu = createSideMenu();
        
        if (sideMenuState.show) {
          menu.style.display = 'flex';
          // Position to the left of the block
          const top = sideMenuState.referencePos.top + window.scrollY;
          const left = sideMenuState.referencePos.x - menu.offsetWidth - 8 + window.scrollX;
          
          menu.style.top = `${top}px`;
          menu.style.left = `${left}px`;
        } else {
          menu.style.display = 'none';
        }
      });
    })();

    // === Vanilla UI: Side "+" menu and drag handle ===
    (function initSideMenu(){
      let menuEl = null;
      editor.sideMenu.onUpdate((state)=>{
        if(!menuEl){
          menuEl = document.createElement('div');
          menuEl.style.cssText = 'position:absolute;display:none;padding:6px;background:white;border:1px solid var(--border);border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.12);z-index:10000;';
          const addBtn = document.createElement('button');
          addBtn.textContent = '+';
          addBtn.style.cssText = 'padding:4px 8px;border:1px solid var(--border);background:white;border-radius:6px;cursor:pointer;';
          addBtn.addEventListener('click', (e)=>{
            e.preventDefault();
            const blockContent = state.block.content;
            const isEmpty = blockContent !== undefined && Array.isArray(blockContent) && blockContent.length === 0;
            if (isEmpty){
              editor.setTextCursorPosition(state.block);
              editor.openSuggestionMenu('/');
            } else {
              const inserted = editor.insertBlocks([{ type:'paragraph' }], state.block, 'after')[0];
              editor.setTextCursorPosition(inserted);
              editor.openSuggestionMenu('/');
            }
          });
          const dragBtn = document.createElement('button');
          dragBtn.textContent = '::';
          dragBtn.style.cssText = 'padding:4px 8px;margin-left:6px;border:1px solid var(--border);background:white;border-radius:6px;cursor:grab;';
          dragBtn.draggable = true;
          dragBtn.addEventListener('dragstart', (evt)=> editor.sideMenu.blockDragStart(evt, state.block));
          dragBtn.addEventListener('dragend', editor.sideMenu.blockDragEnd);
          menuEl.appendChild(addBtn);
          menuEl.appendChild(dragBtn);
          el.appendChild(menuEl);
        }
        if(state.show){
          menuEl.style.display = 'block';
          menuEl.style.top = state.referencePos.top + 'px';
          menuEl.style.left = (state.referencePos.x - (menuEl.offsetWidth || 60) - 8) + 'px';
        } else {
          menuEl.style.display = 'none';
        }
      });
    })();

    // Setup toolbar
    const tb = document.getElementById('docs_toolbar');
    if(tb){
      const mk = (lbl, cmd) => `<button class="tbtn" data-cmd="${cmd}">${lbl}</button>`;
      tb.innerHTML = [
        mk('<b>B</b>', 'bold'),
        mk('<i>I</i>', 'italic'), 
        mk('<u>U</u>', 'underline'),
        mk('H1', 'h1'),
        mk('H2', 'h2'),
        mk('H3', 'h3'),
        mk('• List', 'bulletList'),
        mk('1. List', 'numberedList'),
        mk('Quote', 'blockquote'),
        mk('Code', 'codeBlock'),
        mk('—', 'horizontalRule')
      ].join('');
      
      // Handle toolbar clicks
      tb.onclick = (e) => {
        const b = e.target.closest('button[data-cmd]');
        if(!b) return;
        
        const cmd = b.getAttribute('data-cmd');
        try {
          switch(cmd){
            case 'bold': editor.addStyles({bold: true}); break;
            case 'italic': editor.addStyles({italic: true}); break;
            case 'underline': editor.addStyles({underline: true}); break;
            case 'h1': editor.updateBlock(editor.getTextCursorPosition().block, {type: 'heading', props: {level: 1}}); break;
            case 'h2': editor.updateBlock(editor.getTextCursorPosition().block, {type: 'heading', props: {level: 2}}); break;
            case 'h3': editor.updateBlock(editor.getTextCursorPosition().block, {type: 'heading', props: {level: 3}}); break;
            case 'bulletList': editor.updateBlock(editor.getTextCursorPosition().block, {type: 'bulletListItem'}); break;
            case 'numberedList': editor.updateBlock(editor.getTextCursorPosition().block, {type: 'numberedListItem'}); break;
            case 'blockquote': editor.updateBlock(editor.getTextCursorPosition().block, {type: 'quote'}); break;
            case 'codeBlock': editor.updateBlock(editor.getTextCursorPosition().block, {type: 'codeBlock'}); break;
            case 'horizontalRule': editor.insertBlocks([{type: 'horizontalRule'}], editor.getTextCursorPosition().block, 'after'); break;
          }
        } catch(err) {
          console.error('Toolbar command failed:', cmd, err);
        }
      };
    }
    
    // Store reference for autosave
    window.__bn_instances = window.__bn_instances || {};
    window.__bn_instances.docs_editor = {
      editor,
      document: {
        get blocks() { return editor.topLevelBlocks; }
      }
    };
    
    console.log('BlockNote editor setup complete');
    
  } catch(err) {
    console.error('Failed to mount BlockNote editor:', err);
    el.innerHTML = `
      <div style="padding:20px;text-align:center;color:red">
        <div style="margin-bottom:12px">Editor failed to load</div>
        <div style="font-size:12px;margin-bottom:12px">${err.message}</div>
        <button onclick="retryBlockNoteLoad()" class="btn small">Retry</button>
      </div>
    `;
  }
}

// Function to retry loading BlockNote
function retryBlockNoteLoad() {
  console.log('Retrying BlockNote load...');
  
  // Reload the page to retry ESM import
  location.reload();
}

// Enhanced fallback editor with rich text features
function mountFallbackEditor(holderId, initialJSON) {
  const el = document.getElementById(holderId);
  if(!el) return;
  
  // Create a rich text editor using contenteditable
  el.innerHTML = `
    <div class="fallback-editor-container" style="border:1px solid var(--border);border-radius:8px;min-height:400px;background:white;overflow:hidden;">
      <div class="fallback-toolbar" style="padding:8px;border-bottom:1px solid var(--border);background:var(--bg-secondary);display:flex;gap:4px;flex-wrap:wrap;min-height:44px;align-items:center;">
        <button class="tbtn" data-command="bold" title="Bold" style="padding:6px 12px;border:1px solid var(--border);background:white;border-radius:4px;cursor:pointer;font-size:12px;transition:all 0.2s;color:var(--text-primary);font-weight:500;min-width:40px;height:32px;display:flex;align-items:center;justify-content:center;"><b>B</b></button>
        <button class="tbtn" data-command="italic" title="Italic" style="padding:6px 12px;border:1px solid var(--border);background:white;border-radius:4px;cursor:pointer;font-size:12px;transition:all 0.2s;color:var(--text-primary);font-weight:500;min-width:40px;height:32px;display:flex;align-items:center;justify-content:center;"><i>I</i></button>
        <button class="tbtn" data-command="underline" title="Underline" style="padding:6px 12px;border:1px solid var(--border);background:white;border-radius:4px;cursor:pointer;font-size:12px;transition:all 0.2s;color:var(--text-primary);font-weight:500;min-width:40px;height:32px;display:flex;align-items:center;justify-content:center;"><u>U</u></button>
        <button class="tbtn" data-command="insertUnorderedList" title="Bullet List" style="padding:6px 12px;border:1px solid var(--border);background:white;border-radius:4px;cursor:pointer;font-size:12px;transition:all 0.2s;color:var(--text-primary);font-weight:500;min-width:60px;height:32px;display:flex;align-items:center;justify-content:center;">• List</button>
        <button class="tbtn" data-command="insertOrderedList" title="Numbered List" style="padding:6px 12px;border:1px solid var(--border);background:white;border-radius:4px;cursor:pointer;font-size:12px;transition:all 0.2s;color:var(--text-primary);font-weight:500;min-width:60px;height:32px;display:flex;align-items:center;justify-content:center;">1. List</button>
        <button class="tbtn" data-command="formatBlock" data-value="h1" title="Heading 1" style="padding:6px 12px;border:1px solid var(--border);background:white;border-radius:4px;cursor:pointer;font-size:12px;transition:all 0.2s;color:var(--text-primary);font-weight:500;min-width:40px;height:32px;display:flex;align-items:center;justify-content:center;">H1</button>
        <button class="tbtn" data-command="formatBlock" data-value="h2" title="Heading 2" style="padding:6px 12px;border:1px solid var(--border);background:white;border-radius:4px;cursor:pointer;font-size:12px;transition:all 0.2s;color:var(--text-primary);font-weight:500;min-width:40px;height:32px;display:flex;align-items:center;justify-content:center;">H2</button>
        <button class="tbtn" data-command="formatBlock" data-value="h3" title="Heading 3" style="padding:6px 12px;border:1px solid var(--border);background:white;border-radius:4px;cursor:pointer;font-size:12px;transition:all 0.2s;color:var(--text-primary);font-weight:500;min-width:40px;height:32px;display:flex;flex-direction:column;align-items:center;justify-content:center;">H3</button>
        <button class="tbtn" data-command="formatBlock" data-value="blockquote" title="Quote" style="padding:6px 12px;border:1px solid var(--border);background:white;border-radius:4px;cursor:pointer;font-size:12px;transition:all 0.2s;color:var(--text-primary);font-weight:500;min-width:50px;height:32px;display:flex;align-items:center;justify-content:center;">Quote</button>
        <button class="tbtn" data-command="insertHorizontalRule" title="Horizontal Line" style="padding:6px 12px;border:1px solid var(--border);background:white;border-radius:4px;cursor:pointer;font-size:12px;transition:all 0.2s;color:var(--text-primary);font-weight:500;min-width:40px;height:32px;display:flex;align-items:center;justify-content:center;">—</button>
      </div>
      <div 
        id="fallback_content" 
        class="fallback-content" 
        contenteditable="true"
        style="padding:16px;min-height:350px;outline:none;font-family:inherit;font-size:14px;line-height:1.6;"
        data-placeholder="Start writing your document here..."
      >${initialJSON?.html || initialJSON?.text || ''}</div>
      
      <!-- Plus button for adding new content -->
      <div class="add-content-button" style="position:absolute;right:16px;bottom:16px;width:40px;height:40px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.15);transition:all 0.2s;" onclick="addNewContent()" title="Add new content">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </div>
    </div>
    </div>
  `;
  
  const content = document.getElementById('fallback_content');
  const toolbar = el.querySelector('.fallback-toolbar');
  
  // Handle toolbar clicks
  toolbar.addEventListener('click', (e) => {
    const button = e.target.closest('button');
    if (!button) return;
    
    const command = button.dataset.command;
    const value = button.dataset.value;
    
    try {
      if (command === 'formatBlock') {
        document.execCommand(command, false, value);
      } else {
        document.execCommand(command, false, null);
      }
      content.focus();
    } catch (err) {
      console.error('Command failed:', command, err);
    }
  });
  
  // Handle content changes
  content.addEventListener('input', () => {
    if (docs.currentId) {
      const p = docs.pages.find(p => p.id === docs.currentId);
      if (p) {
        p.edData = { 
          html: content.innerHTML,
          text: content.textContent || content.innerText
        };
        docsPersist();
        const hint = document.getElementById('docsHint');
        if (hint) hint.textContent = 'Saved (local editor)';
      }
    }
    
    // Check for slash commands
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
      const range = selection.getRangeAt(0);
      const text = range.toString();
      if (text.startsWith('/')) {
        handleSlashCommand(text, range);
      }
    }
  });
  
  // Add placeholder behavior
  content.addEventListener('focus', () => {
    if (content.textContent === '') {
      content.innerHTML = '';
    }
  });
  
  content.addEventListener('blur', () => {
    if (content.textContent === '') {
      content.innerHTML = '<div data-placeholder="Start writing your document here..."></div>';
    }
  });
  
  // Focus the editor
  setTimeout(() => content.focus(), 100);
  
  // Add hover effects for the plus button
  const addButton = el.querySelector('.add-content-button');
  if (addButton) {
    addButton.addEventListener('mouseenter', () => {
      addButton.style.transform = 'scale(1.1)';
      addButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.25)';
    });
    
    addButton.addEventListener('mouseleave', () => {
      addButton.style.transform = 'scale(1)';
      addButton.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
    });
  }
  
  console.log('Enhanced fallback editor mounted');
}

// Function to add new content
function addNewContent() {
  const content = document.getElementById('fallback_content');
  if (!content) return;
  
  // Add a new paragraph
  const newParagraph = document.createElement('p');
  newParagraph.innerHTML = '<br>';
  content.appendChild(newParagraph);
  
  // Focus on the new paragraph
  newParagraph.focus();
  
  // Trigger input event to save
  content.dispatchEvent(new Event('input'));
}

// Handle slash commands like Notion
function handleSlashCommand(command, range) {
  const cmd = command.toLowerCase();
  
  // Remove the slash command text
  range.deleteContents();
  
  // Apply the command
  switch(cmd) {
    case '/h1':
    case '/heading1':
      document.execCommand('formatBlock', false, 'h1');
      break;
    case '/h2':
    case '/heading2':
      document.execCommand('formatBlock', false, 'h2');
      break;
    case '/h3':
    case '/heading3':
      document.execCommand('formatBlock', false, 'h3');
      break;
    case '/bullet':
    case '/list':
      document.execCommand('insertUnorderedList', false, null);
      break;
    case '/numbered':
    case '/olist':
      document.execCommand('insertOrderedList', false, null);
      break;
    case '/quote':
    case '/blockquote':
      document.execCommand('formatBlock', false, 'blockquote');
      break;
    case '/divider':
    case '/hr':
      document.execCommand('insertHorizontalRule', false, null);
      break;
    case '/code':
      document.execCommand('formatBlock', false, 'pre');
      break;
  }
}

// Test BlockNote editor in the current page
// editor tests removed
/* ====== State & Storage ====== */
const db = {
  contacts: [], proposals: [], invoices: [],
  settings:{ biz:"", email:"", addr:"", currency:"USD", fy:new Date().getFullYear(), theme:(localStorage.getItem('crm_theme')||'light') },
  fx:{ base:"USD", rates:{EUR:0.91, EGP:48.6, SAR:3.75, AED:3.6725, GBP:0.78}, fetched:0 }
};
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const uid = ()=>Math.random().toString(36).slice(2,9);
const esc = s => (s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const fmt = n => {
  try{
    const target=db.settings.currency||'USD';
    const value=convert? convert(Number(n||0), 'USD', target) : Number(n||0);
    return new Intl.NumberFormat(undefined,{style:'currency',currency:target}).format(Number(value||0));
  }catch(e){return Number(n||0).toFixed(2)}
};
const save = ()=> { 
  localStorage.setItem('freelancer_crm_bw', JSON.stringify(db)); 
  onDataChanged(); // Trigger autosave
};
const load = ()=> { const raw = localStorage.getItem('freelancer_crm_bw'); if(raw){ const p=JSON.parse(raw); ['contacts','proposals','invoices'].forEach(k=>db[k]=p[k]||[]); db.settings=Object.assign(db.settings,p.settings||{});} };

/* ====== Theme ====== */
function applyTheme(){ 
  document.documentElement.setAttribute('data-theme', db.settings.theme==='dark'?'dark':'light'); 
  document.body.setAttribute('data-theme', db.settings.theme==='dark'?'dark':'light');
  localStorage.setItem('crm_theme', db.settings.theme); 
  
  // Refresh editor styling when theme changes
  refreshEditorStyling();
}
function refreshEditorStyling() {
  // Force BlockNote editor elements to re-render with new theme
  const editorIds = [];
  editorIds.forEach(editorId => {
    const instance = window.__bn_instances?.[editorId];
    if (instance?.editor) {
      // Trigger a small re-render to apply new theme styles
      setTimeout(() => {
        try {
          instance.editor.focus();
          instance.editor.blur();
        } catch (e) {
          // Ignore errors if editor is not ready
        }
      }, 100);
    }
  });
}
/* ====== Smooth Header Scrolling ====== */
function smoothScrollHeader(direction = 'right') {
  const headerContainer = document.querySelector('.head .flex');
  if (!headerContainer) return;
  
  const scrollAmount = 200;
  const currentScroll = headerContainer.scrollLeft;
  const maxScroll = headerContainer.scrollWidth - headerContainer.clientWidth;
  
  let targetScroll;
  if (direction === 'right') {
    targetScroll = Math.min(currentScroll + scrollAmount, maxScroll);
  } else {
    targetScroll = Math.max(currentScroll - scrollAmount, 0);
  }
  
  headerContainer.scrollTo({
    left: targetScroll,
    behavior: 'smooth'
  });
}

// Add keyboard navigation for header scrolling
document.addEventListener('keydown', (e) => {
  if (e.altKey) {
    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      smoothScrollHeader('left');
    } else if (e.key === 'ArrowRight') {
      e.preventDefault();
      smoothScrollHeader('right');
    }
  }
});

/* ====== Global Search Functions ====== */
function showGlobalSearchResults() {
  const resultsContainer = document.getElementById('globalSearchResults');
  const backdrop = document.getElementById('searchBackdrop');
  
  if (resultsContainer) {
    resultsContainer.style.display = 'block';
    // Ensure it's positioned correctly
    resultsContainer.style.position = 'fixed';
    resultsContainer.style.zIndex = '999999';
  }
  
  if (backdrop) {
    backdrop.style.display = 'block';
    // Ensure backdrop is behind results but above everything else
    backdrop.style.position = 'fixed';
    backdrop.style.zIndex = '999998';
  }
}

function hideGlobalSearchResults() {
  const resultsContainer = document.getElementById('globalSearchResults');
  const backdrop = document.getElementById('searchBackdrop');
  if (resultsContainer) {
    resultsContainer.style.display = 'none';
  }
  if (backdrop) {
    backdrop.style.display = 'none';
  }
}
function performGlobalSearch(query) {
  const resultsContainer = document.getElementById('searchResultsContent');
  if (!resultsContainer) return;
  
  // Show dropdown when search is performed
  showGlobalSearchResults();
  
  if (!query || query.trim().length === 0) {
    // Show recent items when search is empty
    showRecentItems(resultsContainer);
    return;
  }
  
  const searchTerm = query.toLowerCase().trim();
  const results = [];
  
  // Enhanced contact search - search EVERYTHING
  const contactResults = db.contacts.filter(contact => {
    const searchableText = [
      contact.name || '',
      contact.company || '',
      contact.email || '',
      contact.phone || '',
      contact.tags || '',
      contact.notes || '',
      contact.id || ''
    ].join(' ').toLowerCase();
    
    return searchableText.includes(searchTerm);
  }).slice(0, 10);
  
  // Enhanced proposal search - search EVERYTHING
  const proposalResults = db.proposals.filter(proposal => {
    const clientName = nameById(proposal.client) || '';
    const searchableText = [
      proposal.title || '',
      proposal.status || '',
      proposal.date || '',
      proposal.total?.toString() || '',
      proposal.discount?.toString() || '',
      proposal.tax?.toString() || '',
      proposal.id || '',
      clientName,
      // Search in line items
      ...(proposal.lines || []).map(line => 
        [line.d || '', line.q?.toString() || '', line.r?.toString() || ''].join(' ')
      )
    ].join(' ').toLowerCase();
    
    return searchableText.includes(searchTerm);
  }).slice(0, 10);
  
  // Enhanced invoice search - search EVERYTHING
  const invoiceResults = db.invoices.filter(invoice => {
    const clientName = nameById(invoice.client) || '';
    const searchableText = [
      invoice.number || '',
      invoice.status || '',
      invoice.date || '',
      invoice.total?.toString() || '',
      invoice.discount?.toString() || '',
      invoice.tax?.toString() || '',
      invoice.id || '',
      clientName,
      // Search in line items
      ...(invoice.lines || []).map(line => 
        [line.d || '', line.q?.toString() || '', line.r?.toString() || ''].join(' ')
      )
    ].join(' ').toLowerCase();
    
    return searchableText.includes(searchTerm);
  }).slice(0, 10);
  
  // Build results HTML
  let html = '';
  
  if (contactResults.length > 0) {
    html += '<div class="search-section-header">Contacts</div>';
    contactResults.forEach(contact => {
      html += `
        <div class="search-result-item" onclick="openContactModal('${contact.id}'); hideGlobalSearchResults();">
          <div class="search-result-icon contact">
            <i data-lucide="user"></i>
          </div>
          <div class="search-result-content">
            <div class="search-result-title">${esc(contact.name)}</div>
            <div class="search-result-subtitle">${esc(contact.company || '')}</div>
            <div class="search-result-meta">${esc(contact.email)} • ${esc(contact.phone)}</div>
          </div>
        </div>
      `;
    });
  }
  
  if (proposalResults.length > 0) {
    html += '<div class="search-section-header">Proposals</div>';
          proposalResults.forEach(proposal => {
        const proposalDate = proposal.date ? new Date(proposal.date).toLocaleDateString() : '';
        html += `
          <div class="search-result-item" onclick="openProposal('${proposal.id}'); hideGlobalSearchResults();">
            <div class="search-result-icon proposal">
              <i data-lucide="file-text"></i>
            </div>
            <div class="search-result-content">
              <div class="search-result-title">${esc(proposal.title)}</div>
              <div class="search-result-subtitle">${esc(nameById(proposal.client) || '')}</div>
              <div class="search-result-meta">${esc(proposal.status)} • ${fmtCurrency(proposal.total || 0)} • ${proposalDate}</div>
            </div>
          </div>
        `;
      });
  }
  
  if (invoiceResults.length > 0) {
    html += '<div class="search-section-header">Invoices</div>';
          invoiceResults.forEach(invoice => {
        const invoiceDate = invoice.date ? new Date(invoice.date).toLocaleDateString() : '';
        html += `
          <div class="search-result-item" onclick="openInvoice('${invoice.id}'); hideGlobalSearchResults();">
            <div class="search-result-icon invoice">
              <i data-lucide="receipt"></i>
            </div>
            <div class="search-result-content">
              <div class="search-result-title">${esc(invoice.number)}</div>
              <div class="search-result-subtitle">${esc(nameById(invoice.client) || '')}</div>
              <div class="search-result-meta">${esc(invoice.status)} • ${fmtCurrency(invoice.total || 0)} • ${invoiceDate}</div>
            </div>
          </div>
        `;
      });
  }
  
  if (html === '') {
    html = `
      <div class="no-results">
        <i data-lucide="search-x"></i>
        <div>No results found for "${esc(query)}"</div>
        <div style="font-size: 11px; margin-top: 4px;">Try searching for contacts, proposals, or invoices</div>
      </div>
    `;
  }
  
  resultsContainer.innerHTML = html;
  
  // Initialize Lucide icons
  if (window.lucide) {
    lucide.createIcons();
  }
  
  // Debug: Log search results for troubleshooting
  console.log('Search term:', searchTerm);
  console.log('Contact results:', contactResults.length);
  console.log('Proposal results:', proposalResults.length);
  console.log('Invoice results:', invoiceResults.length);
  console.log('All contacts:', db.contacts);
}

// New search functions for Enter key and button click
function handleSearchKeydown(event) {
  if (event.key === 'Enter') {
    performSearch();
  }
}

function performSearch() {
  const searchInput = document.getElementById('globalSearch');
  const query = searchInput ? searchInput.value : '';
  performGlobalSearch(query);
}

// Show recent items when search is empty
function showRecentItems(resultsContainer) {
  let html = '<div class="search-section-header">Recent Items</div>';
  
  // Show recent contacts
  const recentContacts = db.contacts.slice(-3).reverse();
  if (recentContacts.length > 0) {
    html += '<div class="search-section-header">Recent Contacts</div>';
    recentContacts.forEach(contact => {
      html += `
        <div class="search-result-item" onclick="openContactModal('${contact.id}'); hideGlobalSearchResults();">
          <div class="search-result-icon contact">
            <i data-lucide="user"></i>
          </div>
          <div class="search-result-content">
            <div class="search-result-title">${esc(contact.name)}</div>
            <div class="search-result-subtitle">${esc(contact.company || '')}</div>
            <div class="search-result-meta">${esc(contact.email)} • ${esc(contact.phone)}</div>
          </div>
        </div>
      `;
    });
  }
  
  // Show recent proposals
  const recentProposals = db.proposals.slice(-3).reverse();
  if (recentProposals.length > 0) {
    html += '<div class="search-section-header">Recent Proposals</div>';
    recentProposals.forEach(proposal => {
      const proposalDate = proposal.date ? new Date(proposal.date).toLocaleDateString() : '';
      html += `
        <div class="search-result-item" onclick="openProposal('${proposal.id}'); hideGlobalSearchResults();">
          <div class="search-result-icon proposal">
            <i data-lucide="file-text"></i>
          </div>
          <div class="search-result-content">
            <div class="search-result-title">${esc(proposal.title)}</div>
            <div class="search-result-subtitle">${esc(nameById(proposal.client) || '')}</div>
            <div class="search-result-meta">${esc(proposal.status)} • ${fmtCurrency(proposal.total || 0)} • ${proposalDate}</div>
          </div>
        </div>
      `;
    });
  }
  
  // Show recent invoices
  const recentInvoices = db.invoices.slice(-3).reverse();
  if (recentInvoices.length > 0) {
    html += '<div class="search-section-header">Recent Invoices</div>';
    recentInvoices.forEach(invoice => {
      const invoiceDate = invoice.date ? new Date(invoice.date).toLocaleDateString() : '';
      html += `
        <div class="search-result-item" onclick="openInvoice('${invoice.id}'); hideGlobalSearchResults();">
          <div class="search-result-icon invoice">
            <i data-lucide="receipt"></i>
          </div>
          <div class="search-result-content">
            <div class="search-result-title">${esc(invoice.number)}</div>
            <div class="search-result-subtitle">${esc(nameById(invoice.client) || '')}</div>
            <div class="search-result-meta">${esc(invoice.status)} • ${fmtCurrency(invoice.total || 0)} • ${invoiceDate}</div>
          </div>
        </div>
      `;
    });
  }
  
  resultsContainer.innerHTML = html;
  
  // Initialize Lucide icons
  if (window.lucide) {
    lucide.createIcons();
  }
}

// Close search results when clicking outside
document.addEventListener('click', (e) => {
  const searchWrapper = document.querySelector('.global-search-wrapper');
  const searchResults = document.getElementById('globalSearchResults');
  const backdrop = document.getElementById('searchBackdrop');
  
  if (searchWrapper && searchResults && !searchWrapper.contains(e.target) && e.target !== backdrop) {
    hideGlobalSearchResults();
  }
});
$('#themeToggle').onclick = ()=>{ db.settings.theme = (db.settings.theme==='dark'?'light':'dark'); applyTheme(); };

/* ====== Router (nav tabs like "book open") ====== */
function goto(route){
  // Update navigation active state
  $$('.nav button').forEach(b=> b.classList.toggle('active', b.dataset.route===route));
  
  // Hide all pages first
  $$('[data-route]').forEach(v=>{
    v.classList.remove('active');
    v.hidden = true;
  });
  
  // Show and activate the target page
  const targetPage = document.getElementById('route-'+route);
  if(targetPage){
    targetPage.classList.add('active');
    targetPage.hidden = false;
  }

  // Ensure editors are initialized when navigating directly
  // Pure HTML editors are ready
  
  // Show/hide currency and year elements based on route with smooth motion
  const currencyYearElements = document.querySelectorAll('.currency-dropdown, .year-navigator');
  const currencyYearChips = document.querySelectorAll('.chip:has(.currency-dropdown), .chip:has(.year-navigator)');
  const searchContainer = document.querySelector('.search-container');
  
  if(route === 'home') {
    currencyYearChips.forEach(chip => {
      chip.style.display = 'flex';
      setTimeout(() => {
        chip.style.opacity = '1';
        chip.style.transform = 'translateX(0)';
      }, 10);
    });
    // Keep search on the left for home page
    if (searchContainer) {
      searchContainer.classList.remove('centered');
    }
  } else {
    currencyYearChips.forEach(chip => {
      chip.style.opacity = '0';
      chip.style.transform = 'translateX(-20px)';
      setTimeout(() => {
        chip.style.display = 'none';
      }, 300);
    });
    // Center search on other pages
    if (searchContainer) {
      searchContainer.classList.add('centered');
    }
  }
  
  // Load content based on route
  if(route==='home') renderHome();
  if(route==='contacts') renderContacts();
  if(route==='proposals'){ ensureSamples('proposals'); populateClients(); renderProposals(); }
  if(route==='invoices'){ ensureSamples('invoices'); populateClients(); renderInvoices(); }
  if(route==='docs'){ docsLoad(); renderDocsList(); }
  if(route==='doc'){ /* editor will mount in docsOpen */ }
  if(route==='settings') renderSettings();
  
  // Update URL hash
  history.replaceState({},'', '#'+route);
  
  // Scroll to top of the page container
  const pageContainer = document.querySelector('.page-container');
  if(pageContainer) pageContainer.scrollTop = 0;
}
$$('.nav button').forEach(b=> b.addEventListener('click', ()=> goto(b.dataset.route)));

/* ====== Seed / Wipe ====== */
function iso(base,off=0){ const d=new Date(base); d.setDate(d.getDate()+off); return d.toISOString().slice(0,10); }
function seed(){
  const today = new Date();
  db.contacts = [
    {id:uid(), name:'Acme Inc.', company:'Acme Inc.', email:'ops@acme.com', phone:'+1 555 123 9876', tags:'SaaS, Retainer', notes:'CTO: Jane'},
    {id:uid(), name:'Noor Ahmed', company:'Noor Studio', email:'noor@studio.io', phone:'+971 50 111 2222', tags:'Branding', notes:''},
    {id:uid(), name:'Zed Logistics', company:'Zed Logistics', email:'purch@zedlogi.co', phone:'+966 53 777 0000', tags:'One-off', notes:'Procurement: Sami'}
  ];
  const c1=db.contacts[0].id, c2=db.contacts[1].id;
  db.proposals = [
    {id:uid(), title:'Website refresh', client:c1, date:iso(today,-20), status:'Sent',
      edData:{
        top:{blocks:[{type:'header',data:{text:'Overview',level:3}},{type:'paragraph',data:{text:'Redesign homepage, pricing, and blog with modern UI.'}}]},
        bottom:{blocks:[{type:'list',data:{style:'unordered',items:['2 design iterations','Responsive layout','Handover and documentation']}}]}
      },
      lines:[{d:'Design Sprint',q:1,r:2000},{d:'UI Kit',q:1,r:1200}], discount:0, tax:5, total: (2000+1200)*1.05},
    {id:uid(), title:'Brand identity', client:c2, date:iso(today,-10), status:'Accepted',
      edData:{
        top:{blocks:[{type:'paragraph',data:{text:'Full identity system including logo, palette, and typography.'}}]},
        bottom:{blocks:[{type:'quote',data:{text:'Design is intelligence made visible.',caption:'Alina Wheeler'}}]}
      },
      lines:[{d:'Logo',q:1,r:1500},{d:'Guidelines',q:1,r:900}], discount:0, tax:0, total:2400},
    {id:uid(), title:'Product landing page', client:c1, date:iso(today,-5), status:'Draft',
      edData:{
        top:{blocks:[{type:'header',data:{text:'Scope',level:3}},{type:'list',data:{style:'unordered',items:['Hero redesign','Feature grid','FAQ section']}}]},
        bottom:{blocks:[{type:'paragraph',data:{text:'Timeline: 2 weeks from approval.'}}]}
      },
      lines:[{d:'Landing page design',q:1,r:1800},{d:'Illustrations',q:1,r:600}], discount:0, tax:0, total:2400}
  ];
  db.invoices = [
    {id:uid(), number:'INV-2025-001', client:c1, date:iso(today,-9), status:'Paid',
      edData:{
        top:{blocks:[{type:'paragraph',data:{text:'Thank you for your business.'}}]},
        bottom:{blocks:[{type:'paragraph',data:{text:'Paid via bank transfer.'}}]}
      },
      lines:[{d:'Deposit',q:1,r:1600}], discount:0, tax:0, total:1600},
    {id:uid(), number:'INV-2025-002', client:c2, date:iso(today,-2), status:'Unpaid',
      edData:{
        top:{blocks:[{type:'paragraph',data:{text:'Invoice due in 7 days.'}}]},
        bottom:{blocks:[{type:'list',data:{style:'unordered',items:['Late fee may apply','Please include invoice number in reference']}}]}
      },
      lines:[{d:'Logo',q:1,r:1500},{d:'Guides',q:1,r:900}], discount:0, tax:0, total:2400},
    {id:uid(), number:'INV-2025-003', client:c1, date:iso(today,-1), status:'Overdue',
      edData:{
        top:{blocks:[{type:'paragraph',data:{text:'Reminder: payment is past due.'}}]},
        bottom:{blocks:[{type:'quote',data:{text:'Payment terms: Net 7',caption:''}}]}
      },
      lines:[{d:'Maintenance retainer',q:1,r:800}], discount:0, tax:0, total:800}
  ];
  save(); refreshAll();
}
// Ensure demo data exists for a specific area without needing Settings → Load Sample
function ensureSamples(area){
  const today = new Date();
  // Contacts (shared)
  if(!db.contacts.length){
    db.contacts = [
      {id:uid(), name:'Acme Inc.', company:'Acme Inc.', email:'ops@acme.com', phone:'+1 555 123 9876', tags:'SaaS, Retainer', notes:'CTO: Jane'},
      {id:uid(), name:'Noor Ahmed', company:'Noor Studio', email:'noor@studio.io', phone:'+971 50 111 2222', tags:'Branding', notes:''},
      {id:uid(), name:'Zed Logistics', company:'Zed Logistics', email:'purch@zedlogi.co', phone:'+966 53 777 0000', tags:'One-off', notes:'Procurement: Sami'}
    ];
  }
  const c1=db.contacts[0]?.id||uid(), c2=db.contacts[1]?.id||uid();
  // Proposals
  if((area==='proposals' || area==='all') && !db.proposals.length){
    db.proposals = [
      {id:uid(), title:'Website refresh', client:c1, date:iso(today,-20), status:'Sent',
        edData:{ top:{blocks:[{type:'header',data:{text:'Overview',level:3}},{type:'paragraph',data:{text:'Redesign homepage, pricing, and blog with modern UI.'}}]}, bottom:{blocks:[{type:'list',data:{style:'unordered',items:['2 design iterations','Responsive layout','Handover and documentation']}}]} },
        lines:[{d:'Design Sprint',q:1,r:2000},{d:'UI Kit',q:1,r:1200}], discount:0, tax:5, total:(2000+1200)*1.05 },
      {id:uid(), title:'Brand identity', client:c2, date:iso(today,-10), status:'Accepted',
        edData:{ top:{blocks:[{type:'paragraph',data:{text:'Full identity system including logo, palette, and typography.'}}]}, bottom:{blocks:[{type:'quote',data:{text:'Design is intelligence made visible.',caption:'Alina Wheeler'}}]} },
        lines:[{d:'Logo',q:1,r:1500},{d:'Guidelines',q:1,r:900}], discount:0, tax:0, total:2400 },
      {id:uid(), title:'Product landing page', client:c1, date:iso(today,-5), status:'Draft',
        edData:{ top:{blocks:[{type:'header',data:{text:'Scope',level:3}},{type:'list',data:{style:'unordered',items:['Hero redesign','Feature grid','FAQ section']}}]}, bottom:{blocks:[{type:'paragraph',data:{text:'Timeline: 2 weeks from approval.'}}]} },
        lines:[{d:'Landing page design',q:1,r:1800},{d:'Illustrations',q:1,r:600}], discount:0, tax:0, total:2400 }
    ];
  }
  // Invoices
  if((area==='invoices' || area==='all') && !db.invoices.length){
    db.invoices = [
      {id:uid(), number:'INV-2025-001', client:c1, date:iso(today,-9), status:'Paid', edData:{ top:{blocks:[{type:'paragraph',data:{text:'Thank you for your business.'}}]}, bottom:{blocks:[{type:'paragraph',data:{text:'Paid via bank transfer.'}}]} }, lines:[{d:'Deposit',q:1,r:1600}], discount:0, tax:0, total:1600},
      {id:uid(), number:'INV-2025-002', client:c2, date:iso(today,-2), status:'Unpaid', edData:{ top:{blocks:[{type:'paragraph',data:{text:'Invoice due in 7 days.'}}]}, bottom:{blocks:[{type:'list',data:{style:'unordered',items:['Late fee may apply','Please include invoice number in reference']}}]} }, lines:[{d:'Logo',q:1,r:1500},{d:'Guides',q:1,r:900}], discount:0, tax:0, total:2400},
      {id:uid(), number:'INV-2025-003', client:c1, date:iso(today,-1), status:'Overdue', edData:{ top:{blocks:[{type:'paragraph',data:{text:'Reminder: payment is past due.'}}]}, bottom:{blocks:[{type:'quote',data:{text:'Payment terms: Net 7',caption:''}}]} }, lines:[{d:'Maintenance retainer',q:1,r:800}], discount:0, tax:0, total:800}
    ];
  }
  save();
}
function wipe(){ if(confirm('Delete all data?')){ db.contacts=[]; db.proposals=[]; db.invoices=[]; save(); refreshAll(); } }

/* ====== Contacts ====== */
let currentContactId=null;

function openContactModal(id=null){
  const modal = document.getElementById('contactModal');
  const title = document.getElementById('contactModalTitle');
  
  if(id){
    editContact(id);
    title.textContent = 'Edit Contact';
  } else {
    currentContactId = null;
    clearContactForm();
    title.textContent = 'New Contact';
  }
  
  modal.hidden = false;
}

function closeContactModal(){
  document.getElementById('contactModal').hidden = true;
  currentContactId = null;
  clearContactForm();
}

function clearContactForm(){
  ['#c_name','#c_company','#c_email','#c_phone','#c_tags','#c_notes'].forEach(sel=>$(sel).value='');
  $('#contactFormHint').textContent = '';
  currentContactId = null;
}

function renderContacts(){
  const q = ($('#contactSearch').value||'').toLowerCase();
  const list = db.contacts
    .filter(c=> !q || [c.name,c.company,c.email,c.phone,(c.tags||'')].join(' ').toLowerCase().includes(q))
    .sort((a,b)=> a.name.localeCompare(b.name));
  const wrap = $('#contactsList');
  if(!list.length){ wrap.innerHTML = `<div class="card mini">No contacts.</div>`; return; }
  
  const bulkOn = document.body.dataset.cBulk==='on';
  wrap.classList.toggle('bulk-off', !bulkOn);
  
  // Update bulk delete button visibility
  const bulkDeleteBtn = document.getElementById('c_bulk_delete');
  if(bulkDeleteBtn) {
    bulkDeleteBtn.style.display = bulkOn ? 'inline-flex' : 'none';
  }
  
  // Update bulk toggle button text
  const bulkToggleBtn = document.getElementById('c_bulk_toggle');
  if(bulkToggleBtn) {
    bulkToggleBtn.textContent = bulkOn ? 'Cancel' : 'Bulk';
  }
  
  wrap.innerHTML = `
    <div class="rowi" style="font-weight:600; cursor:default">
      <div class="bulk-col"><input type="checkbox" id="c_bulk_all" onclick="toggleAll('c')" ${bulkOn?'':'disabled'}></div>
      <div>Name</div><div>Company</div><div>Email</div><div>Phone</div><div>Tags</div><div class="bulk-actions"></div>
    </div>
    ${list.map(c=>`<div class="rowi" data-id="${c.id}" onclick="openContactModal('${c.id}')" style="cursor:pointer">
      <div class="bulk-col"><input type="checkbox" class="c_bulk" ${bulkOn?'':'disabled'} onclick="event.stopPropagation()"></div>
      <div>${esc(c.name)}</div>
      <div>${esc(c.company||'')}</div>
      <div class="mini">${esc(c.email||'')}</div>
      <div class="mini">${esc(c.phone||'')}</div>
      <div><span class="status">${esc(c.tags||'')}</span></div>
      <div class="flex" style="gap:4px">
        <button class="iconbtn" title="Delete" onclick="delContact('${c.id}'); event.stopPropagation()">
          <i data-lucide="trash-2"></i>
        </button>
      </div>
    </div>`).join('')}`;
  try{ lucide.createIcons(); }catch(e){}
}
function editContact(id){
  const c = db.contacts.find(x=>x.id===id); if(!c) return;
  currentContactId=id;
  $('#c_name').value=c.name||'';
  $('#c_company').value=c.company||'';
  $('#c_email').value=c.email||'';
  $('#c_phone').value=c.phone||'';
  $('#c_tags').value=c.tags||'';
  $('#c_notes').value=c.notes||'';
  $('#contactFormHint').textContent='Editing '+(c.name||'');
}
function viewContact(id){
  const c = db.contacts.find(x=>x.id===id); if(!c) return;
  const props = db.proposals.filter(p=>p.client===id).length;
  const invs  = db.invoices.filter(i=>i.client===id).length;
  alert(`${c.name}\n${c.company||''}\n${c.email||''} / ${c.phone||''}\n\nProposals: ${props} • Invoices: ${invs}`);
}
function delContact(id){
  confirmDelete('This contact will be removed. This cannot be undone.', ()=>{
  db.contacts = db.contacts.filter(c=>c.id!==id);
  db.proposals.forEach(p=>{ if(p.client===id) p.client=null; });
  db.invoices.forEach(i=>{ if(i.client===id) i.client=null; });
  save(); renderContacts(); refreshCounts();
  });
}
$('#saveContact').onclick = ()=>{
  const c = {
    name:$('#c_name').value.trim(), company:$('#c_company').value.trim(),
    email:$('#c_email').value.trim(), phone:$('#c_phone').value.trim(),
    tags:$('#c_tags').value.trim(), notes:$('#c_notes').value.trim()
  };
  if(!c.name){ alert('Name is required.'); return; }
  if(currentContactId){
    const idx=db.contacts.findIndex(x=>x.id===currentContactId);
    db.contacts[idx]=Object.assign({id:currentContactId}, c);
  }else{
    c.id=uid(); db.contacts.push(c);
  }
  currentContactId=null; save(); $('#contactFormHint').textContent='Saved.';
  closeContactModal();
  renderContacts(); populateClients(); refreshCounts();
};
$('#clearContact').onclick = clearContactForm;
function populateClients(){
  const opts = db.contacts.map(c=> `<option value="${c.id}">${esc(c.name)}</option>`).join('');
  const pSelect = $('#p_client');
  const iSelect = $('#i_client');
  
  if(pSelect) pSelect.innerHTML = `<option value="">Select client</option>${opts}`;
  if(iSelect) iSelect.innerHTML = `<option value="">Select client</option>${opts}`;
}

/* ====== Proposals ====== */
let currentProposalId=null;
function addRow(scope){
  const tbody = $('#'+scope+'_table tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td style=\"width:42px; text-align:center\"><input type=\"checkbox\" checked onchange=\"calc('${scope}')\"></td>
    <td>
      <div><input type=\"text\" placeholder=\"Item title\" style=\"margin-bottom:4px; width:100%; height:32px; font-size:13px\"></div>
      <div class=\"editor line-editor\"><div id=\"line_ed_${Date.now()}\"></div></div>
    </td>
    <td style="width:110px"><span class="numwrap"><input style="width:64px" type="number" step="1" min="0" value="1" oninput="calc('${scope}')"><span class="spin"><button onclick="stepInput(this,-1); calc('${scope}')">▾</button><button onclick="stepInput(this,1); calc('${scope}')">▴</button></span></span><button class="qty-eye" title="Show/Hide qty" onclick="toggleQty(this); calc('${scope}')"><i data-lucide="eye-off"></i></button></td>
    <td><span class="numwrap"><input style="width:100px" type="number" step="0.01" min="0" value="0" oninput="calc('${scope}')"><span class="spin"><button onclick="stepInput(this,-1,0.01); calc('${scope}')">▾</button><button onclick="stepInput(this,1,0.01); calc('${scope}')">▴</button></span></span></td>
    <td class="amount mini">0.00</td>
    <td><button class="btn small secondary" onclick="this.closest('tr').remove(); calc('${scope}')">x</button></td>`;
  tbody.appendChild(tr); calc(scope);
}
function getLines(scope){
  const rows = Array.from($('#'+scope+'_table tbody').querySelectorAll('tr'));
  return rows.map(r=>{
    const [on,d,q,rte] = r.querySelectorAll('input');
    const qtyHidden = r.querySelector('.qty-eye i')?.getAttribute('data-lucide')==='eye';
    const qtyVal = qtyHidden ? 1 : Number(q.value||0);
    return { on:on.checked, d:d.value, q:qtyVal, r:Number(rte.value||0), qtyHidden };
  });
}
function toggleQty(btn){
  const icon = btn.querySelector('i');
  const isHidden = icon.getAttribute('data-lucide')==='eye-off';
  icon.setAttribute('data-lucide', isHidden?'eye':'eye-off');
  try{ lucide.createIcons(); }catch(e){}
}
function calc(scope){
  const lines=getLines(scope);
  const rows = Array.from($('#'+scope+'_table tbody').querySelectorAll('tr'));
  rows.forEach((r,i)=> r.querySelector('.amount').textContent = fmt((lines[i].on?1:0) * lines[i].q * lines[i].r) );
  let subtotal = lines.reduce((s,x)=> s + (x.on?1:0)*x.q*x.r, 0);
  const disc = Number($('#'+scope+'_discount').value||0);
  const tax  = Number($('#'+scope+'_tax').value||0);
  subtotal = subtotal * (1 - disc/100);
  const total = subtotal * (1 + tax/100);
  $('#'+scope+'_total').textContent = fmt(total);

  // update breakdown live amounts and enforce 100% for two-row default
  if(scope==='p'){
    updateBreakdown('p');
    // if there are exactly 2 rows and user changes one, auto set the other to 100-x
    const btbody = document.querySelector('#p_breakdown_table tbody');
    if(btbody){
      const rowsB = Array.from(btbody.querySelectorAll('tr'));
      if(rowsB.length===2){
        const pct1 = Number(rowsB[0].querySelector('input[type="number"]').value||0);
        const pct2 = Number(rowsB[1].querySelector('input[type="number"]').value||0);
        // if they don't sum to 100, set second to 100-first
        if(document.activeElement===rowsB[0].querySelector('input[type="number"]')){
          rowsB[1].querySelector('input[type="number"]').value = Math.max(0, Math.min(100, 100-pct1));
        } else if(document.activeElement===rowsB[1].querySelector('input[type="number"]')){
          rowsB[0].querySelector('input[type="number"]').value = Math.max(0, Math.min(100, 100-pct2));
        }
        updateBreakdown('p');
      }
    }
  }
  
  // Update the current record being edited in real-time
  if(scope==='p' && typeof currentProposalId==='string'){
    const p=db.proposals.find(x=>x.id===currentProposalId); 
    if(p){ 
      p.total=total; 
      p.lines=lines; 
      p.discount=disc; 
      p.tax=tax; 
      save(); 
      // Update home page numbers in real-time
      updateHomeNumbers();
      // Update proposal list if on proposals page
      if(document.getElementById('route-proposals').classList.contains('active')){
        renderProposals();
      }
    }
  }
  if(scope==='i' && typeof currentInvoiceId==='string'){
    const inv=db.invoices.find(x=>x.id===currentInvoiceId); 
    if(inv){ 
      inv.total=total; 
      inv.lines=lines; 
      inv.discount=disc; 
      inv.tax=tax; 
      save(); 
      // Update home page numbers in real-time
      updateHomeNumbers();
      // Update invoice list if on invoices page
      if(document.getElementById('route-invoices').classList.contains('active')){
        renderInvoices();
      }
    }
  }
  
  return {lines, discount:disc, tax, total};
}
// Function to update home page numbers in real-time
function updateHomeNumbers(){
  // Only update if we're on the home page
  if(document.getElementById('route-home').classList.contains('active')){
    // Update counts
    $('#countContacts').textContent = db.contacts.length;
    $('#countProposals').textContent = db.proposals.length;
    $('#countInvoices').textContent = db.invoices.length;
    
    // Get current fiscal year
    const fy = Number(db.settings.fy) || new Date().getFullYear();
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth();
    
    // ====== INVOICE FINANCIAL CALCULATIONS ======
    const invoiceStats = calculateInvoiceStats(fy);
    
    // Update revenue numbers
    $('#ytdRevenue').textContent = fmtCurrency(invoiceStats.paidRevenue);
    $('#ytdCount').textContent = `${invoiceStats.paidCount} invoices`;
    
    // Update status counts and amounts for financial dashboard
    $('#paidCount').textContent = invoiceStats.paidCount;
    $('#paidAmount').textContent = fmtCurrency(invoiceStats.paidRevenue);
    $('#pendingCount').textContent = invoiceStats.pendingCount;
    $('#pendingAmount').textContent = fmtCurrency(invoiceStats.pendingRevenue);
    $('#overdueCount').textContent = invoiceStats.overdueCount;
    $('#overdueAmount').textContent = fmtCurrency(invoiceStats.overdueRevenue);
    $('#draftCount').textContent = invoiceStats.draftCount;
    $('#draftAmount').textContent = fmtCurrency(invoiceStats.draftRevenue);
    
    // ====== PROPOSAL FINANCIAL CALCULATIONS ======
    const proposalStats = calculateProposalStats(fy);
    
    // Update proposal amounts and counts for financial dashboard
    $('#proposalValue').textContent = fmtCurrency(proposalStats.totalValue);
    $('#acceptedCount').textContent = proposalStats.acceptedCount;
    $('#acceptedValue').textContent = fmtCurrency(proposalStats.acceptedValue);
    $('#pendingProposalCount').textContent = proposalStats.pendingCount;
    $('#pendingProposalValue').textContent = fmtCurrency(proposalStats.pendingValue);
    $('#draftProposalCount').textContent = proposalStats.draftCount;
    $('#draftProposalValue').textContent = fmtCurrency(proposalStats.draftValue);
    
    // ====== SPARKLINES ======
    if(db.invoices.length > 0){
      // Year-to-date monthly revenue sparkline
      const monthlyData = [];
      for (let month = 0; month < 12; month++) {
        const monthRevenue = db.invoices.filter(inv => 
          inv.status === 'paid' && 
          new Date(inv.date).getFullYear() === fy &&
          new Date(inv.date).getMonth() === month
        ).reduce((sum, inv) => sum + (inv.total || 0), 0);
        monthlyData.push(monthRevenue);
      }
      if($('#ySpark').length) spark('#ySpark', monthlyData);
      
      // Month-to-date daily revenue sparkline
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const dailyData = [];
      for (let day = 1; day <= daysInMonth; day++) {
        const dayRevenue = db.invoices.filter(inv => 
          inv.status === 'paid' && 
          new Date(inv.date).getFullYear() === currentYear &&
          new Date(inv.date).getMonth() === currentMonth &&
          new Date(inv.date).getDate() === day
        ).reduce((sum, inv) => sum + (inv.total || 0), 0);
        dailyData.push(dayRevenue);
      }
      if($('#mSpark').length) spark('#mSpark', dailyData);
    }
    
    // Update earnings pace
    updateEarningsPace();
  }
}

/* ====== COMPREHENSIVE FINANCIAL CALCULATIONS ====== */
function calculateInvoiceStats(fy) {
  const now = new Date();
  const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
  
  const stats = {
    paidRevenue: 0,
    pendingRevenue: 0,
    overdueRevenue: 0,
    draftRevenue: 0,
    paidCount: 0,
    pendingCount: 0,
    overdueCount: 0,
    draftCount: 0,
    totalRevenue: 0,
    totalCount: 0
  };
  
  db.invoices.forEach(inv => {
    const invDate = new Date(inv.date);
    const invYear = invDate.getFullYear();
    const total = inv.total || 0;
    
    // Only count invoices from the specified fiscal year
    if (invYear === fy) {
      stats.totalRevenue += total;
      stats.totalCount++;
      
      switch(inv.status?.toLowerCase()) {
        case 'paid':
          stats.paidRevenue += total;
          stats.paidCount++;
          break;
        case 'sent':
        case 'pending':
        case 'unpaid':
          stats.pendingRevenue += total;
          stats.pendingCount++;
          break;
        case 'overdue':
          stats.overdueRevenue += total;
          stats.overdueCount++;
          break;
        case 'draft':
        default:
          stats.draftRevenue += total;
          stats.draftCount++;
          break;
      }
    }
  });
  
  return stats;
}

function calculateProposalStats(fy) {
  const stats = {
    totalValue: 0,
    acceptedValue: 0,
    pendingValue: 0,
    draftValue: 0,
    acceptedCount: 0,
    pendingCount: 0,
    draftCount: 0,
    totalCount: 0
  };
  
  db.proposals.forEach(prop => {
    const propDate = new Date(prop.date);
    const propYear = propDate.getFullYear();
    const total = prop.total || 0;
    
    // Only count proposals from the specified fiscal year
    if (propYear === fy) {
      stats.totalValue += total;
      stats.totalCount++;
      
      switch(prop.status) {
        case 'accepted':
          stats.acceptedValue += total;
          stats.acceptedCount++;
          break;
        case 'pending':
          stats.pendingValue += total;
          stats.pendingCount++;
          break;
        case 'draft':
        default:
          stats.draftValue += total;
          stats.draftCount++;
          break;
      }
    }
  });
  
  return stats;
}

function getFinancialSummary() {
  const fy = Number(db.settings.fy) || new Date().getFullYear();
  const invoiceStats = calculateInvoiceStats(fy);
  const proposalStats = calculateProposalStats(fy);
  
  return {
    fiscalYear: fy,
    invoices: invoiceStats,
    proposals: proposalStats,
    totalRevenue: invoiceStats.paidRevenue,
    totalPending: invoiceStats.pendingRevenue + proposalStats.pendingValue,
    totalOverdue: invoiceStats.overdueRevenue,
    conversionRate: invoiceStats.totalCount > 0 ? 
      ((invoiceStats.paidCount / invoiceStats.totalCount) * 100).toFixed(1) : 0,
    averageInvoiceValue: invoiceStats.paidCount > 0 ? 
      (invoiceStats.paidRevenue / invoiceStats.paidCount) : 0,
    proposalConversionRate: proposalStats.totalCount > 0 ? 
      ((proposalStats.acceptedCount / proposalStats.totalCount) * 100).toFixed(1) : 0,
    totalPotentialRevenue: invoiceStats.totalRevenue + proposalStats.totalValue,
    cashFlow: invoiceStats.paidRevenue - invoiceStats.overdueRevenue
  };
}

/* ====== REAL-TIME FINANCIAL TRACKING ====== */
function updateEarningsPace() {
  const fy = Number(db.settings.fy) || new Date().getFullYear();
  const now = new Date();
  const startOfYear = new Date(fy, 0, 1);
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  const startOfWeek = new Date(now.getTime() - (now.getDay() * 24 * 60 * 60 * 1000));
  const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const startOfHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours());
  const startOfMinute = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), now.getMinutes());
  
  // Calculate earnings for different periods
  const yearEarnings = db.invoices
    .filter(inv => inv.status === 'paid' && new Date(inv.date) >= startOfYear)
    .reduce((sum, inv) => sum + (inv.total || 0), 0);
    
  const monthEarnings = db.invoices
    .filter(inv => inv.status === 'paid' && new Date(inv.date) >= startOfMonth)
    .reduce((sum, inv) => sum + (inv.total || 0), 0);
    
  const weekEarnings = db.invoices
    .filter(inv => inv.status === 'paid' && new Date(inv.date) >= startOfWeek)
    .reduce((sum, inv) => sum + (inv.total || 0), 0);
    
  const dayEarnings = db.invoices
    .filter(inv => inv.status === 'paid' && new Date(inv.date) >= startOfDay)
    .reduce((sum, inv) => sum + (inv.total || 0), 0);
    
  const hourEarnings = db.invoices
    .filter(inv => inv.status === 'paid' && new Date(inv.date) >= startOfHour)
    .reduce((sum, inv) => sum + (inv.total || 0), 0);
    
  const minEarnings = db.invoices
    .filter(inv => inv.status === 'paid' && new Date(inv.date) >= startOfMinute)
    .reduce((sum, inv) => sum + (inv.total || 0), 0);
  
  // Calculate rates
  const daysInYear = Math.ceil((now - startOfYear) / (1000 * 60 * 60 * 24));
  const daysInMonth = Math.ceil((now - startOfMonth) / (1000 * 60 * 60 * 24));
  const daysInWeek = Math.ceil((now - startOfWeek) / (1000 * 60 * 60 * 24));
  const hoursInDay = Math.ceil((now - startOfDay) / (1000 * 60 * 60));
  const minutesInHour = Math.ceil((now - startOfHour) / (1000 * 60));
  const secondsInMinute = Math.ceil((now - startOfMinute) / 1000);
  
  // Update earnings pace display
  if(document.getElementById('route-home').classList.contains('active')){
    $('#yearEarnings').textContent = fmtCurrency(yearEarnings);
    $('#yearRate').textContent = `$${(yearEarnings / Math.max(daysInYear, 1)).toFixed(2)}/day`;
    
    $('#monthEarnings').textContent = fmtCurrency(monthEarnings);
    $('#monthRate').textContent = `$${(monthEarnings / Math.max(daysInMonth, 1)).toFixed(2)}/day`;
    
    $('#weekEarnings').textContent = fmtCurrency(weekEarnings);
    $('#weekRate').textContent = `$${(weekEarnings / Math.max(daysInWeek, 1)).toFixed(2)}/day`;
    
    $('#dayEarnings').textContent = fmtCurrency(dayEarnings);
    $('#dayRate').textContent = `$${(dayEarnings / Math.max(hoursInDay, 1)).toFixed(2)}/hour`;
    
    $('#hourEarnings').textContent = fmtCurrency(hourEarnings);
    $('#hourRate').textContent = `$${(hourEarnings / Math.max(minutesInHour, 1)).toFixed(2)}/min`;
    
    $('#minEarnings').textContent = fmtCurrency(minEarnings);
    $('#minRate').textContent = `$${(minEarnings / Math.max(secondsInMinute, 1)).toFixed(2)}/sec`;
  }
}

function stepInput(btn, dir, step){
  const input = btn.closest('.numwrap').querySelector('input[type=number]');
  const inc = step || parseFloat(input.step||1) || 1;
  const min = input.min!=='' ? parseFloat(input.min) : -Infinity;
  const max = input.max!=='' ? parseFloat(input.max) : Infinity;
  let val = parseFloat(input.value||0) + dir*inc;
  if(isNaN(val)) val = 0;
  val = Math.min(max, Math.max(min, val));
  input.value = (inc<1) ? val.toFixed(String(inc).split('.')[1]?.length||2) : String(val);
  input.dispatchEvent(new Event('input', {bubbles:true}));
}

function editLabel(id){
  const el=document.getElementById(id); if(!el) return;
  const current = el.textContent||'';
  const input = document.createElement('input');
  input.type='text'; input.value=current; input.style.width='120px'; input.className='mini';
  const commit=()=>{ const v=(input.value||'').trim(); el.textContent = v||current; input.replaceWith(el); };
  input.addEventListener('keydown', e=>{ if(e.key==='Enter') commit(); if(e.key==='Escape'){ input.replaceWith(el); } });
  input.addEventListener('blur', commit);
  el.replaceWith(input); input.focus(); input.select();
}
function renderProposals(){
  const q = ($('#proposalSearch').value||'').toLowerCase();
  const f = $('#proposalFilter').value;
  ensureSamples('proposals');
  const list = db.proposals
    .filter(p=> (!q || (p.title||'').toLowerCase().includes(q) || (nameById(p.client)||'').toLowerCase().includes(q)) && (!f || (p.status===f)))
    .sort((a,b)=> new Date(b.date) - new Date(a.date));
  const wrap = $('#proposalsList');
  if(!list.length){ wrap.innerHTML = `<div class="card mini">No proposals.</div>`; return; }
  wrap.innerHTML = `
    <div class="rowi" style="font-weight:600; cursor:default">
      <div>Title</div><div>Client</div><div>Date</div><div>Status</div><div>Total</div><div></div>
    </div>
    ${list.map(p=>`<div class="rowi" data-id="${p.id}">
      <div onclick="openProposal('${p.id}')" style="cursor:pointer">${esc(p.title||'')}</div>
      <div>${esc(nameById(p.client)||'—')}</div>
      <div class="mini">${esc(p.date||'')}</div>
      <div><span class="status ${p.status?.toLowerCase()||'draft'}" onclick="cycleProposalStatus('${p.id}'); event.stopPropagation()" title="Click to change">${p.status||'Draft'}</span></div>
      <div>${fmt(p.total||0)}</div>
      <div class="flex"><button class="iconbtn" title="Delete" onclick="delProposal('${p.id}'); event.stopPropagation()"><i data-lucide="trash-2"></i></button></div>
    </div>`).join('')}`;
  try{ lucide.createIcons(); }catch(e){}
}
function openProposal(id){ editProposal(id); }
function updateProposalStatus(id, val){ const p=db.proposals.find(x=>x.id===id); if(!p) return; p.status=val; save(); renderProposals(); refreshCounts(); updateHomeNumbers(); }
function cycleProposalStatus(id){ const order=['Draft','Sent','Accepted','Declined']; const p=db.proposals.find(x=>x.id===id); if(!p) return; const i=order.indexOf(p.status||'Draft'); p.status=order[(i+1)%order.length]; save(); renderProposals(); refreshCounts(); updateHomeNumbers(); }
function toggleViewMode(scope){
  const modal=document.getElementById('viewModal');
  const body=document.getElementById('viewBody');
  const title=document.getElementById('viewTitle');
  if(scope==='p'){
    const id=currentProposalId; const p=id?db.proposals.find(x=>x.id===id):null;
    if(!p){ body.innerHTML='<div class="mini">Nothing to view. Save first.</div>'; modal.hidden=false; return; }
    title.textContent='Proposal';
    buildProposalPrint(p);
    body.innerHTML = document.getElementById('proposalPrint').innerHTML;
    modal.hidden=false;
  }
}
document.getElementById('closeView')?.addEventListener('click',()=>{ document.getElementById('viewModal').hidden=true; });
function editProposal(id){
  const p = db.proposals.find(x=>x.id===id); if(!p) return;
  currentProposalId=id;
  goto('proposal');
  $('#p_title').value=p.title||'';
  $('#p_client').value=p.client||'';
  $('#p_date').value=p.date||'';
  // Ensure clients are populated before setting value
  populateClients();
  setTimeout(() => { $('#p_client').value=p.client||''; }, 10);
  // init editors
  // Mount pure HTML editors for proposal
  
  // Initialize proposal description editor
  try {
    mountDocsEditor('proposal_description_editor', p.edData?.top || { blocks: [] });
  } catch (e) {
    console.error('Failed to mount proposal description editor:', e);
  }
  
  // Initialize proposal terms editor
  try {
    mountDocsEditor('proposal_terms_editor', p.edData?.bottom || { blocks: [] });
  } catch (e) {
    console.error('Failed to mount proposal terms editor:', e);
  }
  
  $('#p_discount').value=p.discount||0;
  $('#p_tax').value=p.tax||0;
  const tbody=$('#p_table tbody'); tbody.innerHTML='';
  (p.lines||[]).forEach(()=> addRow('p'));
  const rows=Array.from(tbody.querySelectorAll('tr'));
  (p.lines||[]).forEach((ln,i)=>{ const [d,q,r]=rows[i].querySelectorAll('input'); d.value=ln.d; q.value=ln.q; r.value=ln.r; });
  calc('p'); $('#proposalFormHint').textContent='Editing '+(p.title||'');

  // populate breakdown
  const enabled = !!p.breakdown?.enabled;
  const wrap = document.getElementById('p_breakdown_wrap');
  const en = document.getElementById('p_breakdown_enabled');
  if(en){ en.checked = enabled; }
  if(wrap){ wrap.hidden = !enabled; }
  const btbody = document.querySelector('#p_breakdown_table tbody');
  if(btbody){
    btbody.innerHTML='';
    (p.breakdown?.rows||[]).forEach(row=>{
      addBreakdownRow('p');
      const last = btbody.lastElementChild;
      last.querySelector('input[type="text"]').value = row.name||'';
      last.querySelector('input[type="number"]').value = row.pct||0;
    });
    updateBreakdown('p');
  }
}
function delProposal(id){
  confirmDelete('Delete this proposal?', ()=>{ db.proposals = db.proposals.filter(p=>p.id!==id); save(); renderProposals(); refreshCounts(); });
}
$('#saveProposal').onclick = ()=>{
  const basic = { title:$('#p_title').value.trim(), client:$('#p_client').value||null, date:$('#p_date').value||iso(new Date()) };
  const fin = calc('p');
  Promise.resolve().then(async ()=>{
    // Capture content from both editors
    const edData = { top: { blocks: [] }, bottom: { blocks: [] } };
    
    try {
      // Get content from description editor (top)
      const descEditorEl = document.getElementById('proposal_description_editor');
      if (descEditorEl && descEditorEl.querySelector('.codex-editor')) {
        // Find the EditorJS instance for this editor
        const descEditor = descEditorEl.querySelector('.codex-editor')?.__editorjs;
        if (descEditor) {
          edData.top = await descEditor.save();
        }
      }
      
      // Get content from terms editor (bottom)
      const termsEditorEl = document.getElementById('proposal_terms_editor');
      if (termsEditorEl && termsEditorEl.querySelector('.codex-editor')) {
        // Find the EditorJS instance for this editor
        const termsEditor = termsEditorEl.querySelector('.codex-editor')?.__editorjs;
        if (termsEditor) {
          edData.bottom = await termsEditor.save();
        }
      }
    } catch (e) {
      console.error('Failed to save editor content:', e);
    }
    
    const breakdown = collectBreakdown('p');
    const status = (edData.top.blocks?.length||0) + (edData.bottom.blocks?.length||0) ? 'Sent' : 'Draft';
    const rec = Object.assign({}, basic, fin, {edData, breakdown});
    if(currentProposalId){ const i=db.proposals.findIndex(x=>x.id===currentProposalId); db.proposals[i]=Object.assign({id:currentProposalId}, rec, {status}); }
    else { rec.id=uid(); db.proposals.push(Object.assign(rec,{status})); }
  currentProposalId=null; save(); $('#proposalFormHint').textContent='Saved.';
    $('#p_title').value=''; $('#p_client').value=''; $('#p_discount').value=0; $('#p_tax').value=0; $('#p_table tbody').innerHTML=''; addRow('p'); calc('p');
    const en=document.getElementById('p_breakdown_enabled'); const wrap=document.getElementById('p_breakdown_wrap'); const btbody=document.querySelector('#p_breakdown_table tbody');
    if(en) en.checked=true; if(wrap) wrap.hidden=false; if(btbody){ btbody.innerHTML=''; addBreakdownRow('p'); addBreakdownRow('p'); const nums=btbody.querySelectorAll('tr input[type="number"]'); if(nums[0]&&nums[1]){ nums[0].value=50; nums[1].value=50; } updateBreakdown('p'); }
  renderProposals(); refreshCounts(); renderHome();
  });
};
window.startNewProposal = function(){
  currentProposalId=null; goto('proposal');
  $('#p_title').value=''; $('#p_client').value=''; $('#p_discount').value=0; $('#p_tax').value=0;
  $('#p_table tbody').innerHTML=''; addRow('p'); calc('p'); $('#proposalFormHint').textContent='';
  
  const en=document.getElementById('p_breakdown_enabled'); const wrap=document.getElementById('p_breakdown_wrap'); const btbody=document.querySelector('#p_breakdown_table tbody');
  if(en) en.checked=true; if(wrap) wrap.hidden=false; if(btbody){ btbody.innerHTML=''; addBreakdownRow('p'); addBreakdownRow('p'); const nums=btbody.querySelectorAll('tr input[type="number"]'); if(nums[0]&&nums[1]){ nums[0].value=50; nums[1].value=50; } updateBreakdown('p'); }
  
  // Initialize empty editors for new proposal
  setTimeout(() => {
    try {
      mountDocsEditor('proposal_description_editor', { blocks: [] });
      mountDocsEditor('proposal_terms_editor', { blocks: [] });
    } catch (e) {
      console.error('Failed to mount new proposal editors:', e);
    }
  }, 100);
  
  // Set default date to today
  const today = new Date().toISOString().split('T')[0];
  $('#p_date').value = today;
  // Ensure clients are populated
  populateClients();
};

function printProposal(id){ const p=db.proposals.find(x=>x.id===id); if(!p) return; buildProposalPrint(p); printSection('proposalPrint'); }
function linesTableHTML(lines, disc, tax, total){
  return `<table style="width:100%; border-collapse:collapse">
    <thead><tr><th align="left">Description</th><th align="right">Qty</th><th align="right">Rate</th><th align="right">Amount</th></tr></thead>
    <tbody>${(lines||[]).map(x=>`<tr><td>${esc(x.d||'')}</td><td align="right">${x.q||0}</td><td align="right">${fmt(x.r||0)}</td><td align="right">${fmt((x.q||0)*(x.r||0))}</td></tr>`).join('')}</tbody>
    <tfoot>
      <tr><td colspan="3" align="right">Discount</td><td align="right">${disc||0}%</td></tr>
      <tr><td colspan="3" align="right">Tax</td><td align="right">${tax||0}%</td></tr>
      <tr><td colspan="3" align="right"><strong>Total</strong></td><td align="right"><strong>${fmt(total||0)}</strong></td></tr>
    </tfoot>
  </table>`;
}
function buildProposalPrint(p){
  const c = contactById(p.client);
  const topHTML = '';
  const bottomHTML = '';
  const breakdownHTML = renderBreakdownHTML(p.breakdown, p.total);
  const headerHTML = `
    <div class="doc-header">
      <div class="doc-cell">
        <h4>To ${esc(c?.name||'—')}</h4>
        <div class="doc-list"><div><span class="muted">Email:</span> ${esc(c?.email||'')}</div><div><span class="muted">Phone:</span> ${esc(c?.phone||'')}</div></div>
      </div>
      <div class="doc-cell">
        <h4>From ${esc(db.settings.biz||'Your Studio')}</h4>
        <div class="doc-list"><div><span class="muted">Email:</span> ${esc(db.settings.email||'')}</div><div><span class="muted">Phone:</span> ${esc(db.settings.phone||'')}</div></div>
      </div>
      <div class="doc-cell doc-meta">
        <div class="big">PROPOSAL</div>
        <div class="doc-list"><div><span class="muted">Issue date:</span> ${esc(p.date||'')}</div></div>
      </div>
    </div>`;
  $('#proposalPrint').innerHTML = `
    <div class="card">${headerHTML}
      <hr style="border:0;border-top:1px solid ${getComputedStyle(document.body).getPropertyValue('--line')}; margin:16px 0">
      <div style="margin:12px 0">${topHTML}</div>
      ${linesTableHTML(p.lines, p.discount, p.tax, p.total)}
      <div style="margin:12px 0">${bottomHTML}</div>
      ${breakdownHTML}
    </div>`;
}

/* ====== Invoices ====== */
let currentInvoiceId=null;
function renderInvoices(){
  const q = ($('#invoiceSearch').value||'').toLowerCase();
  const f = $('#invoiceFilter').value;
  const list = db.invoices
    .filter(i=> (!q || (i.number||'').toLowerCase().includes(q) || (nameById(i.client)||'').toLowerCase().includes(q)) && (!f || (f==='Unpaid'?i.status!=='Paid':i.status===f)))
    .sort((a,b)=> new Date(b.date) - new Date(a.date));
  const wrap = $('#invoicesList');
  if(!list.length){ wrap.innerHTML = `<div class="card mini">No invoices.</div>`; return; }
  const bulkOn = document.body.dataset.iBulk==='on';
  wrap.classList.toggle('bulk-off', !bulkOn);
  wrap.innerHTML = `
    <div class="rowi" style="font-weight:600; cursor:default">
      <div class="bulk-col"><input type="checkbox" id="i_bulk_all" onclick="toggleAll('i')" ${bulkOn?'':'disabled'}></div><div>#</div><div>Client</div><div>Date</div><div>Status</div><div>Total</div><div class="bulk-actions"></div>
    </div>
    ${list.map(i=>`<div class="rowi" data-id="${i.id}">
      <div class="bulk-col"><input type="checkbox" class="i_bulk" ${bulkOn?'':'disabled'}></div>
      <div onclick="openInvoice('${i.id}')" style="cursor:pointer">${esc(i.number||'')}</div>
      <div>${esc(nameById(i.client)||'—')}</div>
      <div class="mini">${esc(i.date||'')}</div>
      <div><span class="status ${i.status?.toLowerCase()}" onclick="cycleInvoiceStatus('${i.id}'); event.stopPropagation()" title="Click to change">${i.status||'Unpaid'}</span></div>
      <div>${fmt(i.total||0)}</div>
      <div class="flex"><button class="iconbtn" title="Delete" onclick="delInvoice('${i.id}'); event.stopPropagation()"><i data-lucide="trash-2"></i></button></div>
    </div>`).join('')}`;
  try{ lucide.createIcons(); }catch(e){}
}
function toggleBulk(area){
  const key = area==='p' ? 'pBulk' : area==='i' ? 'iBulk' : 'cBulk';
  const on = document.body.dataset[key]==='on';
  document.body.dataset[key] = on ? 'off' : 'on';
  
  // Update the button text
  const btn = document.getElementById(area+'_bulk_toggle');
  if(btn) btn.textContent = on ? 'Bulk' : 'Cancel';
  
  // Show/hide bulk delete button
  const deleteBtn = document.getElementById(area+'_bulk_delete');
  if(deleteBtn) deleteBtn.style.display = on ? 'none' : 'inline-flex';
  
  // Show/hide checkboxes
  const checkboxes = document.querySelectorAll(area==='p' ? '.p_bulk' : area==='i' ? '.i_bulk' : '.c_bulk');
  checkboxes.forEach(cb => {
    cb.style.display = on ? 'none' : 'inline-block';
    if (on) cb.checked = false; // Uncheck when exiting bulk mode
  });
  
  // Show/hide "Select All" checkbox
  const selectAll = document.getElementById(area+'_bulk_all');
  if(selectAll) {
    selectAll.style.display = on ? 'none' : 'inline-block';
    selectAll.checked = false;
  }
  
  // Re-render the appropriate list
  if(area==='p') renderProposals(); 
  else if(area==='i') renderInvoices(); 
  else if(area==='c') renderContacts();
}
function toggleAll(area){
  const sel = area==='p'?'.p_bulk':area==='i'?'.i_bulk':'.c_bulk';
  const list = area==='p'?$('#proposalsList'):area==='i'?$('#invoicesList'):$('#contactsList');
  const master = document.getElementById(area+'_bulk_all');
  
  if(list && master) {
    list.querySelectorAll(sel).forEach(cb=>{ 
      if(!cb.disabled){ 
        cb.checked = !!master.checked; 
      } 
    });
  }
}
function bulkDelete(area){
  if(!confirm('Delete selected items?')) return;
  if(area==='p'){
    const ids = Array.from($('#proposalsList').querySelectorAll('.rowi')).map(r=>({r,cb:r.querySelector('.p_bulk')})).filter(x=>x.cb && x.cb.checked && !x.cb.disabled).map(x=>x.r.getAttribute('data-id')).filter(Boolean);
    db.proposals = db.proposals.filter(p=> !ids.includes(p.id));
    save(); renderProposals(); refreshCounts();
  } else if(area==='i'){
    const ids = Array.from($('#invoicesList').querySelectorAll('.rowi')).map(r=>({r,cb:r.querySelector('.i_bulk')})).filter(x=>x.cb && x.cb.checked && !x.cb.disabled).map(x=>x.r.getAttribute('data-id')).filter(Boolean);
    db.invoices = db.invoices.filter(i=> !ids.includes(i.id));
    save(); renderInvoices(); refreshCounts(); renderHome();
  } else if(area==='c'){
    const ids = Array.from($('#contactsList').querySelectorAll('.rowi')).map(r=>({r,cb:r.querySelector('.c_bulk')})).filter(x=>x.cb && x.cb.checked && !x.cb.disabled).map(x=>x.r.getAttribute('data-id')).filter(Boolean);
    db.contacts = db.contacts.filter(c=> !ids.includes(c.id));
    // Also remove references from proposals and invoices
    db.proposals.forEach(p=>{ if(p.client && ids.includes(p.client)) p.client=null; });
    db.invoices.forEach(i=>{ if(i.client && ids.includes(i.client)) i.client=null; });
    save(); renderContacts(); refreshCounts();
  }
}
function openInvoice(id){ editInvoice(id); }
function updateInvoiceStatus(id, val){ const inv=db.invoices.find(x=>x.id===id); if(!inv) return; inv.status=val; save(); renderInvoices(); refreshCounts(); updateHomeNumbers(); }
function cycleInvoiceStatus(id){ const order=['Draft','Sent','Paid','Overdue']; const inv=db.invoices.find(x=>x.id===id); if(!inv) return; const i=order.indexOf(inv.status||'Draft'); inv.status=order[(i+1)%order.length]; save(); renderInvoices(); refreshCounts(); updateHomeNumbers(); }
function editInvoice(id){
  const i = db.invoices.find(x=>x.id===id); if(!i) return;
  currentInvoiceId=id;
  goto('invoice');
  $('#i_number').value=i.number||'';
  $('#i_client').value=i.client||'';
  $('#i_date').value=i.date||'';
  $('#i_status').value=i.status||'Draft';
  // Mount pure HTML editors for invoice
  
  $('#i_discount').value=i.discount||0;
  $('#i_tax').value=i.tax||0;
  const tbody=$('#i_table tbody'); tbody.innerHTML='';
  (i.lines||[]).forEach(()=> addRow('i'));
  const rows=Array.from(tbody.querySelectorAll('tr'));
  (i.lines||[]).forEach((ln,idx)=>{ const [d,q,r]=rows[idx].querySelectorAll('input'); d.value=ln.d; q.value=ln.q; r.value=ln.r; });
  calc('i'); $('#invoiceFormHint').textContent='Editing '+(i.number||'');
}
function delInvoice(id){
  confirmDelete('Delete this invoice?', ()=>{ db.invoices = db.invoices.filter(i=>i.id!==id); save(); renderInvoices(); refreshCounts(); renderHome(); });
}
$('#saveInvoice').onclick = ()=>{
  const basic = { number:$('#i_number').value.trim() || ('INV-'+ new Date().getFullYear() + '-' + String(100 + db.invoices.length)),
    client:$('#i_client').value||null, date:$('#i_date').value||iso(new Date()), status:$('#i_status').value||'Draft' };
  const fin = calc('i');
  const top = (async()=>{ try{ return window.__bn_instances?.i_editor_top?.document ?? null; }catch(e){ return null; } })();
  const bottom = (async()=>{ try{ return window.__bn_instances?.i_editor_bottom?.document ?? null; }catch(e){ return null; } })();
  Promise.all([top,bottom]).then(([topData,bottomData])=>{
    const edData={top:topData||{blocks:[]}, bottom:bottomData||{blocks:[]}};
    const rec = Object.assign({}, { number:basic.number, client:basic.client, date:basic.date, status:basic.status }, fin, {edData});
    if(currentInvoiceId){ const idx=db.invoices.findIndex(x=>x.id===currentInvoiceId); db.invoices[idx]=Object.assign({id:currentInvoiceId}, rec); }
  else { rec.id=uid(); db.invoices.push(rec); }
  currentInvoiceId=null; save(); $('#invoiceFormHint').textContent='Saved.';
    $('#i_number').value=''; $('#i_client').value=''; $('#i_discount').value=0; $('#i_tax').value=0; $('#i_table tbody').innerHTML=''; addRow('i'); calc('i');
  renderInvoices(); refreshCounts(); renderHome();
  });
};
$('#newInvoice').onclick = startNewInvoice;
function startNewInvoice(){ currentInvoiceId=null; goto('invoice'); $('#i_number').value=''; $('#i_client').value=''; $('#i_discount').value=0; $('#i_tax').value=0; $('#i_table tbody').innerHTML=''; addRow('i'); calc('i'); $('#invoiceFormHint').textContent=''; try{ mountBlockNoteInto('i_editor_top'); mountBlockNoteInto('i_editor_bottom'); }catch(e){ console.error('Failed to mount new invoice editors:', e); } }
function printInvoice(id){ const i=db.invoices.find(x=>x.id===id); if(!i) return; buildInvoicePrint(i); printSection('invoicePrint'); }
function buildInvoicePrint(i){
  const c = contactById(i.client);
  const topHTML = renderBlocksToHTML(i.edData?.top?.blocks||[]);
  const bottomHTML = renderBlocksToHTML(i.edData?.bottom?.blocks||[]);
  $('#invoicePrint').innerHTML = `
    <div class="card">
      <h2 style="margin:0 0 6px 0">${esc(db.settings.biz||'Your Studio')}</h2>
      <div class="mini">${esc(db.settings.email||'')}</div>
      <div class="mini">${esc(db.settings.addr||'')}</div>
      <hr style="border:0;border-top:1px solid ${getComputedStyle(document.body).getPropertyValue('--line')}; margin:16px 0">
      <h2 style="margin:0 0 6px 0">Invoice ${esc(i.number||'')}</h2>
      <div class="mini">Date: ${esc(i.date)} • Client: ${esc(c?.name||'—')}</div>
      <div style="margin:12px 0">${topHTML}</div>
      ${linesTableHTML(i.lines, i.discount, i.tax, i.total)}
      <div style="margin:12px 0">${bottomHTML}</div>
      <div style="margin-top:20px" class="mini">Generated from Freelancer CRM</div>
    </div>`;
}

/* ====== Home analytics ====== */
function renderHome(){
  // Update all financial calculations and displays
  updateHomeNumbers();
  
  // Render analytics charts
  renderAnalyticsCharts();
  
  // Update sparklines
  renderSparklines();
}
function spark(sel, arr){
  const el = $(sel), w = el.clientWidth||300, h = el.clientHeight||54, p=4;
  if(!arr.length){ el.innerHTML=''; return; }
  const max = Math.max(...arr, 1); const step = (w - p*2) / (arr.length-1||1);
  const pts = arr.map((v,i)=> [p + i*step, h - p - (v/max)*(h-p*2)] );
  const d = pts.map((pt,i)=> (i?'L':'M')+pt[0].toFixed(1)+' '+pt[1].toFixed(1)).join(' ');
  el.innerHTML = `<svg viewBox="0 0 ${w} ${h}" width="${w}" height="${h}"><path d="${d}" fill="none" stroke="currentColor" stroke-opacity=".9" stroke-width="1.8"/></svg>`;
}
function monthlyTotals(year){ const a=new Array(12).fill(0); db.invoices.forEach(i=>{ const d=new Date(i.date); if(d.getFullYear()===year) a[d.getMonth()]+=Number(i.total||0); }); return a; }
function dailyTotals(y,m){ const days=new Date(y,m+1,0).getDate(); const a=new Array(days).fill(0); db.invoices.forEach(i=>{ const d=new Date(i.date); if(d.getFullYear()===y && d.getMonth()===m) a[d.getDate()-1]+=Number(i.total||0); }); return a; }

/* ====== Print helpers ====== */
function printSection(id){ const area=$('#'+id); area.hidden=false; window.print(); setTimeout(()=> area.hidden=true, 300); }
function nameById(id){ return (db.contacts.find(c=>c.id===id)||{}).name; }
function contactById(id){ return db.contacts.find(c=>c.id===id)||null; }

/* ====== Settings & Global ====== */
function renderSettings(){
  $('#set_biz').value=db.settings.biz||'';
  $('#set_email').value=db.settings.email||'';
  $('#set_addr').value=db.settings.addr||'';
  $('#currencyDisplay').textContent=db.settings.currency||'USD';
  $('#fyInput').textContent=db.settings.fy||new Date().getFullYear();
  const curSel=$('#set_currency'); if(curSel){ curSel.value=db.settings.currency||'USD'; }
  renderFxMini(); renderFxMeta(); renderFxManual();
}
$('#saveSettings').onclick = ()=>{
  db.settings.biz=$('#set_biz').value.trim();
  db.settings.email=$('#set_email').value.trim();
  db.settings.addr=$('#set_addr').value.trim();
  db.settings.currency=$('#currencySelect').value;
  db.settings.fy=Number($('#fyInput').textContent)||new Date().getFullYear();
  save(); alert('Saved.'); renderHome();
};


$('#downloadBtn')?.addEventListener('click', ()=>{
  const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='index.html'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
});
// Currency prefs
$('#set_currency')?.addEventListener('change', async ()=>{
  db.settings.currency=$('#set_currency').value; save();
  if(needRates(db.settings.currency)) await fetchRates(db.settings.currency);
  renderHome(); renderProposals(); renderInvoices(); renderFxMini(); renderFxMeta(); renderFxManual();
});
$('#refreshRates')?.addEventListener('click', async ()=>{
  await fetchRates(db.settings.currency||'USD');
  renderFxMini(); renderFxMeta(); renderFxManual();
});
$('#saveManualRates')?.addEventListener('click', ()=>{ saveManualRates(); });

/* ====== BlockNote Editor: mount into containers ====== */
function mountBlockNoteInto(holderId, initialJSON){}

function execBlockNoteCommand(){ }

// Fallback editor function for when BlockNote fails
function execFallbackCommand(editorId, command) {
	const instance = window.__bn_instances?.[editorId];
	if(!instance) return;
	
	const el = document.getElementById(editorId);
	if(!el) return;
	
	switch(command) {
		case 'bold':
			document.execCommand('bold', false, null);
			break;
		case 'italic':
			document.execCommand('italic', false, null);
			break;
		case 'underline':
			document.execCommand('underline', false, null);
			break;
		case 'h1':
			document.execCommand('formatBlock', false, '<h1>');
			break;
		case 'h2':
			document.execCommand('formatBlock', false, '<h2>');
			break;
		case 'h3':
			document.execCommand('formatBlock', false, '<h3>');
			break;
	}
}

// Helper function to execute BlockNote commands
function execBlockNoteCommand(editorId, command) {
	const instance = window.__bn_instances?.[editorId];
	if(!instance?.editor) return;
	
	const editor = instance.editor;
	
	switch(command) {
		case 'bold':
			editor.addStyles({ bold: true });
			break;
		case 'italic':
			editor.addStyles({ italic: true });
			break;
		case 'underline':
			editor.addStyles({ underline: true });
			break;
		case 'strike':
			editor.addStyles({ strike: true });
			break;
		case 'code':
			editor.addStyles({ code: true });
			break;
		case 'h1':
			editor.updateBlock(editor.getTextCursorPosition().block, { type: 'heading', props: { level: 1 } });
			break;
		case 'h2':
			editor.updateBlock(editor.getTextCursorPosition().block, { type: 'heading', props: { level: 2 } });
			break;
		case 'h3':
			editor.updateBlock(editor.getTextCursorPosition().block, { type: 'heading', props: { level: 3 } });
			break;
		case 'bulletList':
			editor.updateBlock(editor.getTextCursorPosition().block, { type: 'bulletListItem' });
			break;
		case 'numberedList':
			editor.updateBlock(editor.getTextCursorPosition().block, { type: 'numberedListItem' });
			break;
		case 'blockquote':
			editor.updateBlock(editor.getTextCursorPosition().block, { type: 'quote' });
			break;
		case 'codeBlock':
			editor.updateBlock(editor.getTextCursorPosition().block, { type: 'codeBlock' });
			break;
		case 'horizontalRule':
			editor.insertBlocks([{ type: 'horizontalRule' }], editor.getTextCursorPosition().block, 'after');
			break;
	}
}

// Helper function for fallback editor (kept for compatibility)
function execCommand(command, value = null) {
  // This function is kept for compatibility but BlockNote handles formatting
  console.log('execCommand called:', command, value);
}

// History helpers
function historyStep(scope, dir){
  // Find the appropriate editor instance
  let editorId = '';
  if (scope === 'p') {
    editorId = document.activeElement?.closest('.blocknote-editor')?.id || 'p_editor_top';
  } else if (scope === 'i') {
    editorId = document.activeElement?.closest('.blocknote-editor')?.id || 'i_editor_top';
  }
  
  const instance = window.__bn_instances?.[editorId];
  if (!instance?.editor) return;
  
  try {
    if (dir === 'undo') {
      instance.editor.undo();
    } else if (dir === 'redo') {
      instance.editor.redo();
    }
  } catch(e) { 
    console.warn('history step failed', e); 
  }
}
function openHistory(){
  const modal=document.getElementById('historyModal');
  const list=document.getElementById('historyList');
  
  // Find active editor
  let activeEditor = null;
  const editorIds = [];
  for (const id of editorIds) {
    if (window.__bn_instances?.[id]?.editor) {
      activeEditor = window.__bn_instances[id];
      break;
    }
  }
  
  if(!activeEditor){ 
    modal.hidden=false; 
    list.innerHTML='<div class="mini">No editor active.</div>'; 
    return; 
  }
  
  activeEditor.save().then(data=>{
    list.innerHTML = `<pre style="white-space:pre-wrap">${esc(JSON.stringify(data,null,2))}</pre>`;
    modal.hidden=false;
  }).catch(()=>{ 
    list.innerHTML='<div class="mini">Unable to read current content.</div>'; 
    modal.hidden=false; 
  });
}

// Global history controls operate on whichever editor is active; otherwise no-op
function activeEditor(){ 
  const editorIds = ['p_editor_top', 'p_editor_bottom', 'i_editor_top', 'i_editor_bottom'];
  for (const id of editorIds) {
    if (window.__bn_instances?.[id]?.editor) {
      return window.__bn_instances[id];
    }
  }
  return null;
}

function renderBlocksToHTML(blocks){
  return (blocks||[]).map(b=>{
    if(b.type==='paragraph'){ 
      const text = b.content?.[0]?.text || b.text || '';
      return `<p>${text}</p>`; 
    }
    if(b.type==='heading'){ 
      const level = Math.max(1, Math.min(6, b.props?.level || 2));
      const text = b.content?.[0]?.text || b.text || '';
      return `<h${level}>${text}</h${level}>`; 
    }
    if(b.type==='bulletListItem' || b.type==='numberedListItem'){
      const tag = b.type === 'numberedListItem' ? 'ol' : 'ul';
      const text = b.content?.[0]?.text || b.text || '';
      return `<${tag}><li>${text}</li></${tag}>`;
    }
    if(b.type==='quote'){
      const text = b.content?.[0]?.text || b.text || '';
      return `<blockquote>${text}</blockquote>`;
    }
    if(b.type==='horizontalRule'){ return `<hr>`; }
    if(b.type==='codeBlock'){
      const text = b.content?.[0]?.text || b.text || '';
      return `<pre><code>${text}</code></pre>`;
    }
    if(b.type==='image' && b.props?.url){ 
      const caption = b.props?.caption ? `<div class="mini">${b.props.caption}</div>` : '';
      return `<figure><img src="${b.props.url}" style="max-width:100%">${caption}</figure>`; 
    }
    return '';
  }).join('');
}

// Removed editor width toggle to keep a single consistent editor width

// Breakdown helpers
function toggleBreakdown(scope){
  const enabled = document.getElementById(scope+'_breakdown_enabled').checked;
  document.getElementById(scope+'_breakdown_wrap').hidden = !enabled;
  if(enabled){ if(!db[scope==='p'?'proposals':'invoices']) return; }
  calc(scope);
}
function addBreakdownRow(scope){
  const tbody = document.querySelector('#'+scope+'_breakdown_table tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td><input type="text" placeholder="Milestone"></td><td><input type="number" min="0" max="100" step="1" value="0" oninput="updateBreakdown('${scope}')"></td><td class="mini amount">0.00</td><td><button class="btn small secondary" onclick="this.closest('tr').remove(); updateBreakdown('${scope}')">x</button></td>`;
  tbody.appendChild(tr);
  updateBreakdown(scope);
}
function updateBreakdown(scope){
  const enabledEl = document.getElementById(scope+'_breakdown_enabled');
  if(!enabledEl || !enabledEl.checked){ return; }
  const tbody = document.querySelector('#'+scope+'_breakdown_table tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const total = Number(document.getElementById(scope+'_total').textContent.replace(/[^0-9.\-]/g,''))||0;
  // auto-balance: if one row edited, adjust others to keep 100%
  let activeIndex = rows.findIndex(r=> r.contains(document.activeElement));
  let sumPct=0;
  const values = rows.map(r=> Number(r.querySelector('input[type="number"]').value||0));
  if(activeIndex>=0 && rows.length>=2){
    let otherTotal = values.reduce((s,v,i)=> i===activeIndex?s:s+v, 0);
    const rest = Math.max(0, 100 - values[activeIndex]);
    const factor = otherTotal>0 ? (rest/otherTotal) : (rows.length-1>0? rest/(rows.length-1):0);
    rows.forEach((r,i)=>{ if(i!==activeIndex){ const inp=r.querySelector('input[type="number"]'); inp.value = Math.max(0, Math.min(100, Number((values[i]*factor).toFixed(2)))); }});
  }
  // recompute with possibly adjusted values
  rows.forEach((r,i)=>{
    const pct = Number(r.querySelector('input[type="number"]').value||0);
    sumPct += pct;
    const amt = Math.round((total * pct/100) * 100)/100;
    r.querySelector('.amount').textContent = fmt(amt);
  });
  document.getElementById(scope+'_breakdown_sum').textContent = `${sumPct}%`;
  document.getElementById(scope+'_breakdown_total_amount').textContent = fmt(total);
  const hint = (sumPct!==100) ? `Sum should be 100% (now ${sumPct}%)` : 'Perfect 100%';
  document.getElementById(scope+'_breakdown_hint').textContent = hint;
}
function collectBreakdown(scope){
  const enabled = document.getElementById(scope+'_breakdown_enabled')?.checked||false;
  if(!enabled){ return { enabled:false, rows:[] }; }
  const rows = Array.from(document.querySelectorAll('#'+scope+'_breakdown_table tbody tr')).map(r=>{
    const name = r.querySelector('input[type="text"]').value.trim();
    const pct = Number(r.querySelector('input[type="number"]').value||0);
    return { name, pct };
  });
  return { enabled:true, rows };
}
function renderBreakdownHTML(breakdown, total){
  if(!breakdown?.enabled || !(breakdown.rows||[]).length){ return ''; }
  const rows = breakdown.rows.map(r=>{
    const amt = Math.round((Number(total||0) * (Number(r.pct)||0)/100) * 100)/100;
    return `<tr><td>${esc(r.name||'')}</td><td align="right">${r.pct||0}%</td><td align="right">${fmt(amt)}</td></tr>`;
  }).join('');
  return `<div style="margin:12px 0"><h3 style="margin:0 0 6px 0">Breakdown</h3>
    <table style="width:100%; border-collapse:collapse">
      <thead><tr><th align="left">Part</th><th align="right">Percent</th><th align="right">Amount</th></tr></thead>
      <tbody>${rows}</tbody>
    </table></div>`;
}

/* ====== Global search filters current tables ====== */
$('#globalSearch').addEventListener('input', e=>{
  const q = (e.target.value||'').toLowerCase();
  ['contactsList','proposalsList','invoicesList','recentProposals','recentInvoices'].forEach(id=>{
    const el = document.getElementById(id); if(!el) return;
    el.querySelectorAll('tr, .rowi').forEach(row=>{
      const text = row.innerText?.toLowerCase() || '';
      row.style.display = text.includes(q) ? '' : 'none';
    });
  });
});

/* ====== FX helpers ====== */
async function fetchRates(base){
  try{
    const url=`https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}`;
    const res=await fetch(url);
    if(!res.ok) throw new Error('rate http');
    const data=await res.json();
    if(data && data.rates){ db.fx.base=base; db.fx.rates=data.rates; db.fx.fetched=Date.now(); save(); renderFxMini(); renderFxMeta(); renderFxManual(); }
  }catch(e){ console.warn('FX fetch failed', e); }
}
function needRates(base){ const day=1000*60*60*12; return db.fx.base!==base || !db.fx.fetched || (Date.now()-db.fx.fetched)>day; }
function convert(amount, from, to){
  const n=Number(amount||0);
  if(from===to) return n;
  const rates=db.fx.rates||{};
  if(db.fx.base===from){ return n * (rates[to]||1); }
  if(db.fx.base===to){ return n / (rates[from]||1); }
  const viaBase = n / (rates[from]||1) * (rates[to]||1);
  return viaBase||n;
}
function fmtCurrency(amount, targetCur){
  try{ return new Intl.NumberFormat(undefined,{style:'currency',currency:targetCur||db.settings.currency||'USD'}).format(Number(amount||0)); }
  catch(e){ return Number(amount||0).toFixed(2); }
}
function renderFxMini(){
  const box = document.getElementById('fxRates'); if(!box) return;
  const want=['USD','EUR','EGP','SAR','AED','GBP'];
  const cur=db.settings.currency||'USD';
  const rates=db.fx.rates||{};
  const items=want.filter(c=>c!==cur).map(c=>`${c}: ${(rates[c]||1).toFixed(3)}`).join(' | ');
  box.textContent = items ? `1 ${cur} → ${items}` : 'Rates unavailable.';
}
function renderFxMeta(){
  const el=document.getElementById('fxMeta'); if(!el) return;
  if(!db.fx.fetched){ el.textContent=''; return; }
  const d=new Date(db.fx.fetched);
  el.textContent = `Last updated: ${d.toLocaleString()} (base ${db.fx.base})`;
}
function renderFxManual(){
  const wrap=document.getElementById('fxManual'); if(!wrap) return;
  const cur=db.settings.currency||'USD';
  const list=['USD','EUR','EGP','SAR','AED','GBP'].filter(c=>c!==cur);
  const rates=db.fx.rates||{};
  wrap.innerHTML = `<div class="row">${list.map(c=>`<div class="col-6"><label>${c} per 1 ${cur}<input type="number" step="0.0001" min="0" id="rate_${c}" value="${(rates[c]||1).toFixed(4)}"/></label></div>`).join('')}</div>`;
}
function saveManualRates(){
  const cur=db.settings.currency||'USD';
  db.fx.base=cur; db.fx.rates=db.fx.rates||{};
  ['USD','EUR','EGP','SAR','AED','GBP'].forEach(c=>{
    if(c===cur) return;
    const el=document.getElementById('rate_'+c); if(!el) return;
    const v=parseFloat(el.value); if(!isNaN(v) && v>0){ db.fx.rates[c]=v; }
  });
  db.fx.fetched=Date.now(); save(); renderFxMini(); renderFxMeta();
}

/* ====== Init ====== */
// Initialize storage system first
initStorage().then(() => {
  applyTheme();
  
  // Initialize bulk states
  document.body.dataset.cBulk = 'off';
  document.body.dataset.pBulk = 'off';
  document.body.dataset.iBulk = 'off';
  
(async ()=>{ if(needRates(db.settings.currency)) await fetchRates(db.settings.currency); renderFxMini(); renderFxMeta(); renderFxManual(); })();
  
  refreshAll();
}).catch(e => {
  console.error('Storage initialization failed:', e);
  // Fallback to old system
  load(); 
  applyTheme();
  
  // Initialize bulk states
  document.body.dataset.cBulk = 'off';
  document.body.dataset.pBulk = 'off';
  document.body.dataset.iBulk = 'off';
  
  (async ()=>{ if(needRates(db.settings.currency)) await fetchRates(db.settings.currency); renderFxMini(); renderFxMeta(); renderFxManual(); })();
  
if(!db.contacts.length && !db.invoices.length && !db.proposals.length){ seed(); } // sample on first run
  refreshAll();
});

function refreshCounts(){ 
  $('#countContacts').textContent=db.contacts.length; 
  $('#countProposals').textContent=db.proposals.length; 
  $('#countInvoices').textContent=db.invoices.length; 
  // Also update home page numbers if on home page
  updateHomeNumbers();
}
function refreshAll(){
  renderSettings(); populateClients();
  // ensure at least one row in tables on load
  if(!$('#p_table tbody').children.length){ addRow('p'); calc('p'); }
  if(!$('#i_table tbody').children.length){ addRow('i'); calc('i'); }
  renderContacts(); renderProposals(); renderInvoices(); renderHome();
  const r = (location.hash||'#home').slice(1); goto(r);
}

/* ====== Invoices/Proposals print builders reused ====== */
function buildInvoicePrint(i){ /* already defined above */ }
function buildProposalPrint(p){ /* already defined above */ }

// Sidebar drag-to-resize and collapse
(function(){
  let isDragging=false, startX=0, startW=0; const side=$('.side'); const resizer=$('#sideResizer');
  const setWidth=w=>{ document.documentElement.style.setProperty('--side', Math.max(64, Math.min(200, w)) + 'px'); side.classList.toggle('collapsed', w<=84); };
  resizer?.addEventListener('mousedown', e=>{ isDragging=true; startX=e.clientX; startW=(side.getBoundingClientRect().width||200); document.body.style.userSelect='none'; document.body.style.cursor='ew-resize'; });
  window.addEventListener('mousemove', e=>{ if(!isDragging) return; const dx=e.clientX-startX; setWidth(startW+dx); });
  window.addEventListener('mouseup', ()=>{ if(!isDragging) return; isDragging=false; document.body.style.userSelect=''; document.body.style.cursor=''; });
  // Double click to toggle collapsed
  resizer?.addEventListener('dblclick', ()=>{ const w=side.getBoundingClientRect().width; setWidth(w>84?74:200); });
})();

// Conversion helpers stub (real versions below). This avoids reference errors during initial parse.
function convert(amount, from, to){ return amount; }

function updateBulkSelection(area) {
  const checkboxes = document.querySelectorAll(`.bulk-checkbox`);
  const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
  const bulkDeleteBtn = document.getElementById(`${area}_bulk_delete`);
  
  if (bulkDeleteBtn) {
    bulkDeleteBtn.style.display = selectedCount > 0 ? 'inline-block' : 'none';
  }
}



// Year picker functionality
$('#fyInput').onclick = () => {
  const dropdown = document.getElementById('yearDropdown');
  const isVisible = dropdown.style.display === 'block';
  
  // Close any other open dropdowns
  document.querySelectorAll('.year-dropdown').forEach(dd => dd.style.display = 'none');
  
  if (!isVisible) {
    dropdown.style.display = 'block';
    // Add click outside listener
    setTimeout(() => {
      document.addEventListener('click', closeYearDropdown);
    }, 0);
  }
};

function closeYearDropdown(e) {
  if (!e.target.closest('.year-picker')) {
    document.querySelectorAll('.year-dropdown').forEach(dd => dd.style.display = 'none');
    document.removeEventListener('click', closeYearDropdown);
  }
}

function selectYear(year) {
  $('#fyInput').value = year;
  db.settings.fy = year;
  save();
  renderHome();
  
  // Close dropdown with animation
  const dropdown = document.getElementById('yearDropdown');
  dropdown.style.opacity = '0';
  dropdown.style.transform = 'translateY(-10px)';
  setTimeout(() => {
    dropdown.style.display = 'none';
    dropdown.style.opacity = '1';
    dropdown.style.transform = 'translateY(0)';
  }, 200);
  
  document.removeEventListener('click', closeYearDropdown);
}

// Initialize year input with current value
document.addEventListener('DOMContentLoaded', () => {
  $('#fyInput').value = db.settings.fy || new Date().getFullYear();
});

// Render analytics charts
function renderAnalyticsCharts() {
  renderRevenueChart();
  renderSuccessChart();
  renderClientChart();
  renderStatusChart();
}

function renderRevenueChart() {
  const canvas = document.getElementById('revenueChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const fy = Number(db.settings.fy) || new Date().getFullYear();
  
  // Get monthly revenue data
  const monthlyData = [];
  for (let month = 0; month < 12; month++) {
    const monthRevenue = db.invoices.filter(inv => 
      inv.status === 'paid' && 
      new Date(inv.date).getFullYear() === fy &&
      new Date(inv.date).getMonth() === month
    ).reduce((sum, inv) => sum + (inv.total || 0), 0);
    monthlyData.push(monthRevenue);
  }
  
  // Simple bar chart
  const maxRevenue = Math.max(...monthlyData, 1);
  const barWidth = canvas.width / 12;
  const barHeight = canvas.height - 40;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#10b981';
  
  monthlyData.forEach((revenue, index) => {
    const height = (revenue / maxRevenue) * barHeight;
    const x = index * barWidth + 10;
    const y = canvas.height - height - 20;
    
    ctx.fillRect(x, y, barWidth - 20, height);
  });
  
  // Add labels
  ctx.fillStyle = '#6b7280';
  ctx.font = '10px sans-serif';
  ctx.textAlign = 'center';
  monthlyData.forEach((revenue, index) => {
    const x = index * barWidth + barWidth / 2;
    ctx.fillText(fmtCurrency(revenue), x, canvas.height - 5);
  });
}
function renderSuccessChart() {
  const canvas = document.getElementById('successChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  // Calculate proposal success rates
  const total = db.proposals.length;
  const accepted = db.proposals.filter(p => p.status === 'accepted').length;
  const declined = db.proposals.filter(p => p.status === 'declined').length;
  const pending = total - accepted - declined;
  
  if (total === 0) return;
  
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const radius = Math.min(centerX, centerY) - 30;
  
  // Draw pie chart
  let currentAngle = 0;
  
  // Accepted (green)
  if (accepted > 0) {
    const sliceAngle = (accepted / total) * 2 * Math.PI;
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
    ctx.closePath();
    ctx.fillStyle = '#10b981';
    ctx.fill();
    currentAngle += sliceAngle;
  }
  
  // Declined (red)
  if (declined > 0) {
    const sliceAngle = (declined / total) * 2 * Math.PI;
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
    ctx.closePath();
    ctx.fillStyle = '#ef4444';
    ctx.fill();
    currentAngle += sliceAngle;
  }
  
  // Pending (gray)
  if (pending > 0) {
    const sliceAngle = (pending / total) * 2 * Math.PI;
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
    ctx.closePath();
    ctx.fillStyle = '#6b7280';
    ctx.fill();
  }
  
  // Add legend
  ctx.fillStyle = '#374151';
  ctx.font = '12px sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText(`Accepted: ${accepted} (${Math.round(accepted/total*100)}%)`, 20, 30);
  ctx.fillText(`Declined: ${declined} (${Math.round(declined/total*100)}%)`, 20, 50);
  ctx.fillText(`Pending: ${pending} (${Math.round(pending/total*100)}%)`, 20, 70);
}
function renderClientChart() {
  const canvas = document.getElementById('clientChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  // Get client revenue data
  const clientRevenue = {};
  db.invoices.filter(inv => inv.status === 'paid').forEach(inv => {
    const clientName = nameById(inv.client) || 'Unknown';
    clientRevenue[clientName] = (clientRevenue[clientName] || 0) + (inv.total || 0);
  });
  
  const topClients = Object.entries(clientRevenue)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 5);
  
  if (topClients.length === 0) return;
  
  const maxRevenue = Math.max(...topClients.map(([,revenue]) => revenue));
  const barHeight = canvas.height - 60;
  const barWidth = (canvas.width - 40) / topClients.length;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  topClients.forEach(([client, revenue], index) => {
    const height = (revenue / maxRevenue) * barHeight;
    const x = 20 + index * barWidth;
    const y = canvas.height - height - 40;
    
    ctx.fillStyle = '#3b82f6';
    ctx.fillRect(x, y, barWidth - 10, height);
    
    // Add labels
    ctx.fillStyle = '#374151';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(fmtCurrency(revenue), x + barWidth/2 - 5, y - 10);
    
    // Rotate text for client names
    ctx.save();
    ctx.translate(x + barWidth/2 - 5, canvas.height - 20);
    ctx.rotate(-Math.PI/4);
    ctx.fillText(clientName.length > 8 ? clientName.substring(0,8) + '...' : clientName, 0, 0);
    ctx.restore();
  });
}
function renderStatusChart() {
  const canvas = document.getElementById('statusChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  // Calculate invoice status distribution
  const statusCounts = {};
  db.invoices.forEach(inv => {
    const status = inv.status || 'unpaid';
    statusCounts[status] = (statusCounts[status] || 0) + 1;
  });
  
  const statuses = Object.keys(statusCounts);
  if (statuses.length === 0) return;
  
  const total = db.invoices.length;
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const radius = Math.min(centerX, centerY) - 40;
  
  // Draw donut chart
  let currentAngle = 0;
  const colors = ['#10b981', '#f59e0b', '#ef4444', '#6b7280', '#3b82f6'];
  
  statuses.forEach((status, index) => {
    const count = statusCounts[status];
    const sliceAngle = (count / total) * 2 * Math.PI;
    
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
    ctx.arc(centerX, centerY, radius * 0.6, currentAngle + sliceAngle, currentAngle, true);
    ctx.closePath();
    ctx.fillStyle = colors[index % colors.length];
    ctx.fill();
    
    currentAngle += sliceAngle;
  });
  
  // Add center text
  ctx.fillStyle = '#374151';
  ctx.font = '14px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(`${total}`, centerX, centerY - 5);
  ctx.font = '10px sans-serif';
  ctx.fillText('Total', centerX, centerY + 10);
  
  // Add legend
  ctx.font = '10px sans-serif';
  ctx.textAlign = 'left';
  statuses.forEach((status, index) => {
    const count = statusCounts[status];
    const percentage = Math.round(count/total*100);
    ctx.fillStyle = colors[index % colors.length];
    ctx.fillText(`${status}: ${count} (${percentage}%)`, 20, 30 + index * 20);
  });
}

// Update sparklines
function renderSparklines() {
  const fy = Number(db.settings.fy) || new Date().getFullYear();
  spark('#ySpark', monthlyTotals(fy));
  spark('#mSpark', dailyTotals(new Date().getFullYear(), new Date().getMonth()));
}

// Helper functions for sparklines
function monthlyTotals(year) {
  const monthly = new Array(12).fill(0);
  db.invoices.filter(inv => 
    inv.status === 'paid' && 
    new Date(inv.date).getFullYear() === year
  ).forEach(inv => {
    const month = new Date(inv.date).getMonth();
    monthly[month] += inv.total || 0;
  });
  return monthly;
}

function dailyTotals(year, month) {
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const daily = new Array(daysInMonth).fill(0);
  db.invoices.filter(inv => 
    inv.status === 'paid' && 
    new Date(inv.date).getFullYear() === year &&
    new Date(inv.date).getMonth() === month
  ).forEach(inv => {
    const day = new Date(inv.date).getDate() - 1;
    daily[day] += inv.total || 0;
  });
  return daily;
}

function toggleYearDropdown() {
  const dropdown = document.getElementById('yearDropdown');
  const isVisible = dropdown.style.display === 'block';
  
  // Close any other open dropdowns
  document.querySelectorAll('.year-dropdown').forEach(dd => dd.style.display = 'none');
  
  if (!isVisible) {
    // Generate years dynamically before showing
    generateYearOptions();
    dropdown.style.display = 'block';
    // Add click outside listener
    setTimeout(() => {
      document.addEventListener('click', closeYearDropdown);
    }, 0);
  }
}

function changeYear(direction) {
  const currentYear = Number(db.settings.fy) || new Date().getFullYear();
  const newYear = currentYear + direction;
  
  // Limit years between 2015 and current year + 5
  const minYear = 2015;
  const maxYear = new Date().getFullYear() + 5;
  
  if (newYear >= minYear && newYear <= maxYear) {
    db.settings.fy = newYear;
    save();
    
    // Update the display
    const yearDisplay = document.getElementById('fyInput');
    if (yearDisplay) {
      yearDisplay.textContent = newYear;
    }
    
    // Refresh home page
    renderHome();
  }
}

/* ====== Currency Dropdown Functions ====== */
function toggleCurrencyDropdown() {
  const dropdown = document.getElementById('currencyMenu');
  const toggle = document.getElementById('currencyToggle');
  const isVisible = dropdown.style.display === 'block';
  
  // Close any other open dropdowns
  document.querySelectorAll('.currency-menu').forEach(menu => menu.style.display = 'none');
  document.querySelectorAll('.currency-dropdown').forEach(dd => dd.classList.remove('open'));
  
  if (!isVisible) {
    dropdown.style.display = 'block';
    toggle.closest('.currency-dropdown').classList.add('open');
    
    // Add click outside listener
    setTimeout(() => {
      document.addEventListener('click', closeCurrencyDropdown);
    }, 0);
  }
}

function closeCurrencyDropdown() {
  document.querySelectorAll('.currency-menu').forEach(menu => menu.style.display = 'none');
  document.querySelectorAll('.currency-dropdown').forEach(dd => dd.classList.remove('open'));
  document.removeEventListener('click', closeCurrencyDropdown);
}

function selectCurrency(currency) {
  db.settings.currency = currency;
  save();
  
  // Update display
  document.getElementById('currencyDisplay').textContent = currency;
  
  // Close dropdown
  closeCurrencyDropdown();
  
  // Refresh pages
  renderHome();
  renderProposals();
  renderInvoices();
}

function confirmDelete(message, onConfirm){
  const modal=document.createElement('div');
  modal.style.position='fixed'; modal.style.inset='0'; modal.style.background='rgba(0,0,0,.25)'; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.zIndex='9999';
  modal.innerHTML=`<div class="card" style="max-width:360px; width:100%">
    <div class="flex justify-between"><h3>Are you sure?</h3></div>
    <div class="mini" style="margin:8px 0 16px 0">${message}</div>
    <div class="flex" style="justify-content:flex-end; gap:8px">
      <button class="btn small secondary" id="cd_cancel">Cancel</button>
      <button class="btn small danger" id="cd_ok">Delete</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
  modal.querySelector('#cd_cancel').onclick=()=> modal.remove();
  modal.querySelector('#cd_ok').onclick=()=>{ modal.remove(); onConfirm&&onConfirm(); };
}

function delContact(id){
  confirmDelete('This contact will be removed. This cannot be undone.', ()=>{
    db.contacts = db.contacts.filter(c=>c.id!==id);
    db.proposals.forEach(p=>{ if(p.client===id) p.client=null; });
    db.invoices.forEach(i=>{ if(i.client===id) i.client=null; });
    save(); renderContacts(); refreshCounts();
  });
}

function delProposal(id){
  confirmDelete('Delete this proposal?', ()=>{ db.proposals = db.proposals.filter(p=>p.id!==id); save(); renderProposals(); refreshCounts(); });
}

function delInvoice(id){
  confirmDelete('Delete this invoice?', ()=>{ db.invoices = db.invoices.filter(i=>i.id!==id); save(); renderInvoices(); refreshCounts(); renderHome(); });
}





// Ensure invoices list uses lucide and recreate icons
function renderInvoices(){
  const q = ($('#invoiceSearch').value||'').toLowerCase();
  const f = $('#invoiceFilter').value;
  const list = db.invoices
    .filter(i=> (!q || (i.number||'').toLowerCase().includes(q) || (nameById(i.client)||'').toLowerCase().includes(q)) && (!f || (f==='Unpaid'?i.status!=='Paid':i.status===f)))
    .sort((a,b)=> new Date(b.date) - new Date(a.date));
  const wrap = $('#invoicesList');
  if(!list.length){ wrap.innerHTML = `<div class="card mini">No invoices.</div>`; return; }
  const bulkOn = document.body.dataset.iBulk==='on';
  wrap.classList.toggle('bulk-off', !bulkOn);
  wrap.innerHTML = `
    <div class="rowi" style="font-weight:600; cursor:default">
      <div class="bulk-col"><input type="checkbox" id="i_bulk_all" onclick="toggleAll('i')" ${bulkOn?'':'disabled'}></div><div>#</div><div>Client</div><div>Date</div><div>Status</div><div>Total</div><div class="bulk-actions"></div>
    </div>
    ${list.map(i=>`<div class="rowi" data-id="${i.id}">
      <div class="bulk-col"><input type="checkbox" class="i_bulk" ${bulkOn?'':'disabled'}></div>
      <div onclick="openInvoice('${i.id}')" style="cursor:pointer">${esc(i.number||'')}</div>
      <div>${esc(nameById(i.client)||'—')}</div>
      <div class="mini">${esc(i.date||'')}</div>
      <div><span class="status ${i.status?.toLowerCase()}" onclick="cycleInvoiceStatus('${i.id}'); event.stopPropagation()" title="Click to change">${i.status||'Unpaid'}</span></div>
      <div>${fmt(i.total||0)}</div>
      <div class="flex"><button class="iconbtn" title="Delete" onclick="delInvoice('${i.id}'); event.stopPropagation()"><i data-lucide="trash-2"></i></button></div>
    </div>`).join('')}`;
  try{ lucide.createIcons(); }catch(e){}
}

// Strengthen contact modal open/close display
function openContactModal(id=null){
  const modal = document.getElementById('contactModal');
  const title = document.getElementById('contactModalTitle');
  if(id){ editContact(id); title.textContent='Edit Contact'; }
  else { currentContactId=null; clearContactForm(); title.textContent='New Contact'; }
  modal.hidden=false; modal.style.display='flex';
}
function closeContactModal(){ const m=document.getElementById('contactModal'); m.hidden=true; m.style.display='none'; currentContactId=null; clearContactForm(); }

// Build year options dynamically including 2025 and custom add
function buildYearOptions(){
  const nowY=new Date().getFullYear();
  const start=nowY; const end=2015;
  const dd=document.getElementById('yearDropdown'); if(!dd) return;
  dd.innerHTML = Array.from({length:start-end+1},(_,i)=>start-i)
    .map(y=>`<div class="year-option" onclick="selectYear(${start-i})">${start-i}</div>`).join('') +
    `<div class="year-option" onclick="addCustomYear()">+ Add year</div>`;
}
function addCustomYear(){ const y=Number(prompt('Enter year (e.g., 2026):')); if(!y||isNaN(y)) return; selectYear(y); buildYearOptions(); }

document.addEventListener('DOMContentLoaded', ()=>{ 
  try{ buildYearOptions(); }catch(e){}
  
  // Pure HTML editor is ready
});

// Remove any remaining recent cards section if present on load
document.addEventListener('DOMContentLoaded', ()=>{
  const recentTitle = Array.from(document.querySelectorAll('h3')).find(h=>/Recent Proposals/i.test(h.textContent));
  if(recentTitle){ const section=recentTitle.closest('.tab-section'); if(section) section.remove(); }
});
// ====== LOCAL-FIRST PERSISTENCE SYSTEM ======
// LZString compression library (minified subset)
const LZString = (function() {
  const f = String.fromCharCode;
  const keyStrBase64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
  const keyStrUriSafe = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$";
  const baseReverseDic = {};
  
  function getBaseValue(alphabet, character) {
    if (!baseReverseDic[alphabet]) {
      baseReverseDic[alphabet] = {};
      for (let i = 0; i < alphabet.length; i++) {
        baseReverseDic[alphabet][alphabet.charAt(i)] = i;
      }
    }
    return baseReverseDic[alphabet][character];
  }
  
  function _compress(uncompressed, bitsPerChar, getCharFromInt) {
    if (uncompressed == null) return "";
    let i, value, context_dictionary = {}, context_dictionaryToCreate = {}, context_c = "", context_w = "", context_enlargeIn = 2, context_dictSize = 3, context_numBits = 2, context_data = [], context_data_val = 0, context_data_position = 0, ii;
    
    for (ii = 0; ii < uncompressed.length; ii += 1) {
      context_c = uncompressed.charAt(ii);
      if (!Object.prototype.hasOwnProperty.call(context_dictionary, context_c)) {
        context_dictionary[context_c] = context_dictSize++;
        context_dictionaryToCreate[context_c] = true;
      }
      context_w = context_w + context_c;
      for (i = 0; i < context_dictionaryToCreate.length; i++) {
        if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_dictionaryToCreate[i])) {
          if (context_dictionaryToCreate[i].charCodeAt(0) < 256) {
            for (let j = 0; j < context_numBits; j++) {
              context_data_val = (context_data_val << 1);
              if (context_data_position == bitsPerChar - 1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else {
                context_data_position++;
              }
            }
            value = context_dictionaryToCreate[i].charCodeAt(0);
            for (let j = 0; j < 8; j++) {
              context_data_val = (context_data_val << 1) | (value & 1);
              if (context_data_position == bitsPerChar - 1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else {
                context_data_position++;
              }
              value = value >> 1;
            }
          } else {
            value = 1;
            for (let j = 0; j < context_numBits; j++) {
              context_data_val = (context_data_val << 1) | value;
              if (context_data_position == bitsPerChar - 1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else {
                context_data_position++;
              }
              value = 0;
            }
            value = context_dictionaryToCreate[i].charCodeAt(0);
            for (let j = 0; j < 16; j++) {
              context_data_val = (context_data_val << 1) | (value & 1);
              if (context_data_position == bitsPerChar - 1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else {
                context_data_position++;
              }
              value = value >> 1;
            }
          }
        }
      }
      delete context_dictionaryToCreate[context_dictionaryToCreate[i]];
      if (context_dictSize >= context_enlargeIn) {
        context_numBits++;
        context_enlargeIn *= 2;
      }
    }
    context_w = context_w + context_c;
    for (i = 0; i < context_dictionaryToCreate.length; i++) {
      if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_dictionaryToCreate[i])) {
        if (context_dictionaryToCreate[i].charCodeAt(0) < 256) {
          for (let j = 0; j < context_numBits; j++) {
            context_data_val = (context_data_val << 1);
            if (context_data_position == bitsPerChar - 1) {
              context_data_position = 0;
              context_data.push(getCharFromInt(context_data_val));
              context_data_val = 0;
            } else {
              context_data_position++;
            }
          }
          value = context_dictionaryToCreate[i].charCodeAt(0);
          for (let j = 0; j < 8; j++) {
            context_data_val = (context_data_val << 1) | (value & 1);
            if (context_data_position == bitsPerChar - 1) {
              context_data_position = 0;
              context_data.push(getCharFromInt(context_data_val));
              context_data_val = 0;
            } else {
              context_data_position++;
            }
            value = value >> 1;
          }
        } else {
          value = 1;
          for (let j = 0; j < context_numBits; j++) {
            context_data_val = (context_data_val << 1) | value;
            if (context_data_position == bitsPerChar - 1) {
              context_data_position = 0;
              context_data.push(getCharFromInt(context_data_val));
              context_data_val = 0;
            } else {
              context_data_position++;
            }
            value = 0;
          }
          value = context_dictionaryToCreate[i].charCodeAt(0);
          for (let j = 0; j < 16; j++) {
            context_data_val = (context_data_val << 1) | (value & 1);
            if (context_data_position == bitsPerChar - 1) {
              context_data_position = 0;
              context_data.push(getCharFromInt(context_data_val));
              context_data_val = 0;
            } else {
              context_data_position++;
            }
            value = value >> 1;
          }
        }
      }
    }
    delete context_dictionaryToCreate[context_dictionaryToCreate[i]];
    if (context_dictSize >= context_enlargeIn) {
      context_numBits++;
      context_enlargeIn *= 2;
    }
    value = 2;
    for (let j = 0; j < context_numBits; j++) {
      context_data_val = (context_data_val << 1) | (value & 1);
      if (context_data_position == bitsPerChar - 1) {
        context_data_position = 0;
        context_data.push(getCharFromInt(context_data_val));
        context_data_val = 0;
      } else {
        context_data_position++;
      }
      value = value >> 1;
    }
    while (true) {
      context_data_val = (context_data_val << 1);
      if (context_data_position == bitsPerChar - 1) {
        context_data.push(getCharFromInt(context_data_val));
        break;
      } else context_data_position++;
    }
    return context_data.join('');
  }
  
  function _decompress(length, resetValue, getNextValue) {
  const dictionary = [], next = [], enlargeIn = 4, dictSize = 4, numBits = 3, entry = "", result = [], c = "", data_val = resetValue, data_position = resetValue, index = 1, w = String.fromCharCode(getNextValue(0)), errorCount = 0;
    
    for (let i = 0; i < 3; i += 1) {
      dictionary[i] = i;
    }
    
    let bits = 0, maxpower = Math.pow(2, 2), power = 1;
    while (power != maxpower) {
      data_val += getNextValue(data_position) * power;
      data_position += 1;
      if (data_position == length) {
        data_position = 0;
      }
      power *= 2;
    }
    c = data_val & 3;
    data_val >>= 2;
    bits += 2;
    if (c == 0) {
      bits = 0;
      maxpower = Math.pow(2, 8);
      power = 1;
      while (power != maxpower) {
        data_val += getNextValue(data_position) * power;
        data_position += 1;
        if (data_position == length) {
          data_position = 0;
        }
        power *= 2;
      }
      c = data_val & 15;
      data_val >>= 4;
      bits += 4;
    } else if (c == 1) {
      bits = 0;
      maxpower = Math.pow(2, 16);
      power = 1;
      while (power != maxpower) {
        data_val += getNextValue(data_position) * power;
        data_position += 1;
        if (data_position == length) {
          data_position = 0;
        }
        power *= 2;
      }
      c = data_val & 65535;
      data_val >>= 16;
      bits += 16;
    } else if (c == 2) {
      return "";
    }
    
    dictionary[3] = String.fromCharCode(c);
    w = String.fromCharCode(c);
    result.push(w);
    
    while (true) {
      if (index > 3) {
        const newLength = dictionary.length;
        for (let i = 0; i < newLength; i++) {
          dictionary[newLength + i] = dictionary[i];
        }
      }
      
      if (index == dictionary.length) {
        dictionary[dictionary.length] = w;
      } else {
        dictionary[index] = w;
      }
      
      c = data_val & (Math.pow(2, numBits) - 1);
      data_val >>= numBits;
      bits += numBits;
      
      if (c == 0) {
        bits = 0;
        maxpower = Math.pow(2, 8);
        power = 1;
        while (power != maxpower) {
          data_val += getNextValue(data_position) * power;
          data_position += 1;
          if (data_position == length) {
            data_position = 0;
          }
          power *= 2;
        }
        dictionary[dictSize] = String.fromCharCode(data_val & 255);
        data_val >>= 8;
        bits += 8;
      } else if (c == 1) {
        bits = 0;
        maxpower = Math.pow(2, 16);
        power = 1;
        while (power != maxpower) {
          data_val += getNextValue(data_position) * power;
          data_position += 1;
          if (data_position == length) {
            data_position = 0;
          }
          power *= 2;
        }
        dictionary[dictSize] = String.fromCharCode(data_val & 65535);
        data_val >>= 16;
        bits += 16;
      } else if (c == 2) {
        return result.join('');
      }
      
      entry = dictionary[dictSize];
      dictSize++;
      
      if (dictSize >= enlargeIn) {
        numBits++;
        enlargeIn *= 2;
      }
      
      result.push(entry);
      w = entry;
      index++;
    }
  }
  
  return {
    compressToUTF16: function(input) {
      if (input == null) return "";
      return _compress(input, 15, function(a) {
        return f(a + 32);
      }) + " ";
    },
    decompressFromUTF16: function(compressed) {
      if (compressed == null) return "";
      if (compressed == "") return null;
      return _decompress(compressed.length, 16384, function(index) {
        return compressed.charCodeAt(index) - 32;
      });
    }
  };
})();

// Compression helpers
function compress(obj) {
  return LZString.compressToUTF16(JSON.stringify(obj));
}

function decompress(str) {
  try {
    return JSON.parse(LZString.decompressFromUTF16(str));
  } catch (e) {
    console.error('Decompression failed:', e);
    return null;
  }
}

// Hash helper using SubtleCrypto or fallback
async function hashData(data) {
  const str = JSON.stringify(data);
  try {
    if (window.crypto && window.crypto.subtle) {
      const encoder = new TextEncoder();
      const dataBuffer = encoder.encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
  } catch (e) {
    console.warn('SubtleCrypto failed, using simple hash:', e);
  }
  
  // Simple fallback hash
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32-bit integer
  }
  return Math.abs(hash).toString(16);
}

// Storage Adapter Interface
class StorageAdapter {
  async saveCurrent(doc) { throw new Error('Not implemented'); }
  async loadCurrent() { throw new Error('Not implemented'); }
  async pushVersion(doc) { throw new Error('Not implemented'); }
  async listVersions() { throw new Error('Not implemented'); }
  async loadVersion(id) { throw new Error('Not implemented'); }
  async clearAll() { throw new Error('Not implemented'); }
}
// IndexedDB Adapter (preferred)
class LocalAdapterIndexedDB extends StorageAdapter {
  constructor() {
    super();
    this.dbName = 'CRMStorage';
    this.dbVersion = 1;
    this.currentKey = 'current';
    this.versionsKey = 'versions';
  }

  async getDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.dbVersion);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => resolve(request.result);
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        
        // Current document store
        if (!db.objectStoreNames.contains('documents')) {
          const docStore = db.createObjectStore('documents', { keyPath: 'key' });
        }
        
        // Versions store
        if (!db.objectStoreNames.contains('versions')) {
          const versionStore = db.createObjectStore('versions', { keyPath: 'id' });
          versionStore.createIndex('timestamp', 'timestamp', { unique: false });
        }
      };
    });
  }

  async saveCurrent(doc) {
    const db = await this.getDB();
    const tx = db.transaction(['documents'], 'readwrite');
    const store = tx.objectStore('documents');
    await store.put({ key: this.currentKey, ...doc });
    return tx.complete;
  }

  async loadCurrent() {
    const db = await this.getDB();
    const tx = db.transaction(['documents'], 'readonly');
    const store = tx.objectStore('documents');
    const result = await store.get(this.currentKey);
    return result || null;
  }

  async pushVersion(doc) {
    try {
      console.log('IndexedDB: Pushing version...');
      const db = await this.getDB();
      const tx = db.transaction(['versions'], 'readwrite');
      const store = tx.objectStore('versions');
      
      const version = {
        id: Date.now().toString(),
        timestamp: new Date().toISOString(),
        size: compress(doc.payload).length,
        ...doc
      };
      
      console.log('IndexedDB: Adding version:', version.id);
      await store.add(version);
      
      // Cap history to 100 entries
      const allVersions = await this.listVersions();
      if (allVersions.length > 100) {
        const toDelete = allVersions.slice(100);
        for (const v of toDelete) {
          await store.delete(v.id);
        }
      }
      
      await tx.complete;
      console.log('IndexedDB: Version pushed successfully');
      return { id: version.id, at: version.timestamp, size: version.size };
    } catch (e) {
      console.error('IndexedDB pushVersion failed:', e);
      throw e;
    }
  }

  async listVersions() {
    try {
      console.log('IndexedDB: Listing versions...');
      const db = await this.getDB();
      const tx = db.transaction(['versions'], 'readonly');
      const store = tx.objectStore('versions');
      const index = store.index('timestamp');
      const versions = await index.getAll();
      const sorted = versions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      console.log('IndexedDB: Found', sorted.length, 'versions');
      return sorted;
    } catch (e) {
      console.error('IndexedDB listVersions failed:', e);
      throw e;
    }
  }

  async loadVersion(id) {
    const db = await this.getDB();
    const tx = db.transaction(['versions'], 'readonly');
    const store = tx.objectStore('versions');
    const result = await store.get(id);
    return result || null;
  }

  async clearAll() {
    const db = await this.getDB();
    const tx = db.transaction(['documents', 'versions'], 'readwrite');
    await tx.objectStore('documents').clear();
    await tx.objectStore('versions').clear();
    return tx.complete;
  }
}

// LocalStorage Adapter (fallback)
class LocalAdapterLocalStorage extends StorageAdapter {
  constructor() {
    super();
    this.prefix = 'crm_storage_';
    this.currentKey = this.prefix + 'current';
    this.versionsKey = this.prefix + 'versions';
  }

  async saveCurrent(doc) {
    localStorage.setItem(this.currentKey, JSON.stringify(doc));
  }

  async loadCurrent() {
    const data = localStorage.getItem(this.currentKey);
    return data ? JSON.parse(data) : null;
  }

  async pushVersion(doc) {
    const versions = this.getVersions();
    const version = {
      id: Date.now().toString(),
      timestamp: new Date().toISOString(),
      size: compress(doc.payload).length,
      ...doc
    };
    
    versions.unshift(version);
    
    // Cap history to 100 entries
    if (versions.length > 100) {
      versions.splice(100);
    }
    
    localStorage.setItem(this.versionsKey, JSON.stringify(versions));
    return { id: version.id, at: version.timestamp, size: version.size };
  }

  async listVersions() {
    return this.getVersions();
  }

  async loadVersion(id) {
    const versions = this.getVersions();
    return versions.find(v => v.id === id) || null;
  }

  async clearAll() {
    localStorage.removeItem(this.currentKey);
    localStorage.removeItem(this.versionsKey);
  }

  getVersions() {
    const data = localStorage.getItem(this.versionsKey);
    return data ? JSON.parse(data) : [];
  }
}

// Storage manager with adapter selection
class StorageManager {
  constructor() {
    this.adapter = null;
    this.lastHash = null;
    this.autosaveTimer = null;
    this.debounceTimer = null;
    this.autosaveEnabled = true;
  }

  async init() {
    // Try IndexedDB first, fallback to LocalStorage
    try {
      console.log('Initializing IndexedDB adapter...');
      this.adapter = new LocalAdapterIndexedDB();
      await this.adapter.getDB(); // Test connection
      console.log('✅ Using IndexedDB storage');
    } catch (e) {
      console.warn('❌ IndexedDB failed, falling back to LocalStorage:', e);
      this.adapter = new LocalAdapterLocalStorage();
      console.log('✅ Using LocalStorage adapter');
    }
  }

  async saveCurrent(doc) {
    if (!this.adapter) return;
    await this.adapter.saveCurrent(doc);
  }

  async loadCurrent() {
    if (!this.adapter) return null;
    return await this.adapter.loadCurrent();
  }

  async pushVersion(doc) {
    if (!this.adapter) return null;
    return await this.adapter.pushVersion(doc);
  }

  async listVersions() {
    if (!this.adapter) return [];
    return await this.adapter.listVersions();
  }

  async loadVersion(id) {
    if (!this.adapter) return null;
    return await this.adapter.loadVersion(id);
  }

  async clearAll() {
    if (!this.adapter) return;
    await this.adapter.clearAll();
  }

  // Autosave system
  scheduleAutosave() {
    if (!this.autosaveEnabled) return;
    
    if (this.debounceTimer) {
      clearTimeout(this.debounceTimer);
    }
    this.debounceTimer = setTimeout(() => {
      this.performAutosave();
    }, 600);
  }

  async performAutosave() {
    try {
      const data = await exportData();
      const hash = await hashData(data);
      
      if (hash !== this.lastHash) {
        const doc = {
          version: 1,
          updatedAt: new Date().toISOString(),
          hash: hash,
          payload: data
        };
        
        await this.saveCurrent(doc);
        // Also push to version history
        await this.pushVersion(doc);
        this.lastHash = hash;
        console.log('Autosaved and versioned at', new Date().toLocaleTimeString());
      }
    } catch (e) {
      console.error('Autosave failed:', e);
    }
  }

  startAutosaveInterval() {
    if (this.autosaveTimer) {
      clearInterval(this.autosaveTimer);
    }
    if (this.autosaveEnabled) {
      this.autosaveTimer = setInterval(() => {
        this.performAutosave();
      }, 17000); // 17 seconds
    }
  }

  stopAutosaveInterval() {
    if (this.autosaveTimer) {
      clearInterval(this.autosaveTimer);
      this.autosaveTimer = null;
    }
  }
}
// Global storage manager instance
let storageManager = null;
// Data export/import functions
async function exportData() {
  // Save editor data first
  const editorData = {};
  if (window.pEditorTop && window.pEditorTop.save) {
    editorData.proposalTop = await window.pEditorTop.save();
  }
  if (window.pEditorBottom && window.pEditorBottom.save) {
    editorData.proposalBottom = await window.pEditorBottom.save();
  }
  if (window.iEditorTop && window.iEditorTop.save) {
    editorData.invoiceTop = await window.iEditorTop.save();
  }
  if (window.iEditorBottom && window.iEditorBottom.save) {
    editorData.invoiceBottom = await window.iEditorBottom.save();
  }

  return {
    settings: db.settings,
    contacts: db.contacts,
    proposals: db.proposals,
    invoices: db.invoices,
    editors: editorData,
    currentProposalId: currentProposalId,
    currentInvoiceId: currentInvoiceId,
    currentContactId: currentContactId
  };
}

async function importData(data) {
  if (!data) return false;
  
  try {
    // Import basic data
    if (data.settings) db.settings = data.settings;
    if (data.contacts) db.contacts = data.contacts;
    if (data.proposals) db.proposals = data.proposals;
    if (data.invoices) db.invoices = data.invoices;
    
    // Import editor data
    if (data.editors) {
      if (data.editors.proposalTop && window.pEditorTop) {
        await window.pEditorTop.render(data.editors.proposalTop);
      }
      if (data.editors.proposalBottom && window.pEditorBottom) {
        await window.pEditorBottom.render(data.editors.proposalBottom);
      }
      if (data.editors.invoiceTop && window.iEditorTop) {
        await window.iEditorTop.render(data.editors.invoiceTop);
      }
      if (data.editors.invoiceBottom && window.iEditorBottom) {
        await window.iEditorBottom.render(data.editors.invoiceBottom);
      }
    }
    
    // Import current IDs
    if (data.currentProposalId) currentProposalId = data.currentProposalId;
    if (data.currentInvoiceId) currentInvoiceId = data.currentInvoiceId;
    if (data.currentContactId) currentContactId = data.currentContactId;
    
    // Re-render everything
    renderHome();
    renderContacts();
    renderProposals();
    renderInvoices();
    refreshCounts();
    updateHomeNumbers();
    applyTheme();
    
    return true;
  } catch (e) {
    console.error('Import failed:', e);
    return false;
  }
}

// Call this whenever data changes
function onDataChanged() {
  storageManager.scheduleAutosave();
}

// Initialize storage on page load
async function initStorage() {
  // Create the storage manager instance
  storageManager = new StorageManager();
  await storageManager.init();
  
  // Load autosave preference
  const autosaveEnabled = localStorage.getItem('crm_autosave_enabled');
  if (autosaveEnabled !== null) {
    storageManager.autosaveEnabled = autosaveEnabled === 'true';
  }
  
  // Load existing data or seed defaults
  const saved = await storageManager.loadCurrent();
  if (saved && saved.payload) {
    await importData(saved.payload);
    storageManager.lastHash = saved.hash;
  } else {
    // Seed with default data
    seed();
    await storageManager.performAutosave();
  }
  
  // Start autosave interval (respects the toggle)
  storageManager.startAutosaveInterval();
  
  // Setup beforeunload save
  window.addEventListener('beforeunload', () => {
    if (storageManager) {
      storageManager.performAutosave();
    }
  });
}

// History Panel Functions
let currentPreviewVersion = null;

async function openHistoryPanel() {
  console.log('Opening history panel...');
  const modal = document.getElementById('historyModal');
  if (!modal) {
    console.error('History modal not found!');
    return;
  }
  
  modal.style.display = 'flex';
  console.log('Modal display set to flex');
  
  // Set the autosave toggle state
  const autosaveToggle = document.getElementById('autosaveToggle');
  if (autosaveToggle && storageManager) {
    autosaveToggle.checked = storageManager.autosaveEnabled;
  }
  
  await loadHistoryList();
  console.log('History panel opened successfully');
}

function closeHistoryPanel() {
  const modal = document.getElementById('historyModal');
  modal.style.display = 'none';
}

async function loadHistoryList() {
  const list = document.getElementById('historyList');
  list.innerHTML = '<div class="loading">Loading history...</div>';
  
  try {
    console.log('=== Loading History List ===');
    
    // Check if storage manager exists
    if (!storageManager) {
      console.error('Storage manager is null!');
      list.innerHTML = '<div class="loading">Storage not initialized</div>';
      return;
    }
    
    console.log('1. Storage manager exists, calling listVersions...');
    const versions = await storageManager.listVersions();
    console.log('2. Versions received:', versions);
    
    if (!versions) {
      console.log('3. Versions is null/undefined');
      list.innerHTML = '<div class="loading">No versions data</div>';
      return;
    }
    
    if (versions.length === 0) {
      console.log('3. No versions found');
      list.innerHTML = '<div class="loading">No saved versions yet</div>';
      return;
    }
    
    console.log('3. Processing', versions.length, 'versions');
    list.innerHTML = versions.map(version => {
      const time = new Date(version.timestamp).toLocaleString();
      const size = Math.round(version.size / 1024 * 100) / 100; // KB
      
      return `
        <div class="history-item" onclick="previewVersion('${version.id}')">
          <div class="history-info">
            <div class="history-time">${time}</div>
            <div class="history-size">${size} KB</div>
          </div>
          <div class="history-actions">
            <button class="btn small" onclick="event.stopPropagation(); restoreVersion('${version.id}')">
              <i data-lucide="rotate-ccw"></i> Restore
            </button>
          </div>
        </div>
      `;
    }).join('');
    
    lucide.createIcons();
    console.log('4. History list updated successfully with', versions.length, 'versions');
  } catch (e) {
    console.error('Failed to load history:', e);
    list.innerHTML = '<div class="loading">Failed to load history: ' + e.message + '</div>';
  }
}

async function previewVersion(id) {
  currentPreviewVersion = id;
  const modal = document.getElementById('previewModal');
  const content = document.getElementById('previewContent');
  
  modal.style.display = 'flex';
  content.innerHTML = '<div class="loading">Loading preview...</div>';
  
  try {
    const version = await storageManager.loadVersion(id);
    if (!version || !version.payload) {
      content.innerHTML = '<div class="loading">Failed to load version</div>';
      return;
    }
    
    const data = version.payload;
    const time = new Date(version.timestamp).toLocaleString();
    
    content.innerHTML = `
      <div class="version-summary">
        <div class="summary-item">
          <div class="summary-label">Saved At</div>
          <div class="summary-value">${time}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Contacts</div>
          <div class="summary-value">${data.contacts?.length || 0}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Proposals</div>
          <div class="summary-value">${data.proposals?.length || 0}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Invoices</div>
          <div class="summary-value">${data.invoices?.length || 0}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Currency</div>
          <div class="summary-value">${data.settings?.currency || 'USD'}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Theme</div>
          <div class="summary-value">${data.settings?.theme || 'light'}</div>
        </div>
      </div>
    `;
    
    lucide.createIcons();
  } catch (e) {
    console.error('Failed to preview version:', e);
    content.innerHTML = '<div class="loading">Failed to load preview</div>';
  }
}

function closePreviewModal() {
  const modal = document.getElementById('previewModal');
  modal.style.display = 'none';
  currentPreviewVersion = null;
}

async function restoreVersion(id = null) {
  const versionId = id || currentPreviewVersion;
  if (!versionId) return;
  
  if (!confirm('Are you sure you want to restore this version? Current changes will be lost.')) {
    return;
  }
  
  try {
    const version = await storageManager.loadVersion(versionId);
    if (!version || !version.payload) {
      alert('Failed to load version');
      return;
    }
    
    await importData(version.payload);
    
    // Create a new snapshot after restore
    await storageManager.performAutosave();
    
    closePreviewModal();
    closeHistoryPanel();
    
    alert('Version restored successfully!');
  } catch (e) {
    console.error('Failed to restore version:', e);
    alert('Failed to restore version');
  }
}

async function createCheckpoint() {
  try {
    console.log('=== Creating Checkpoint ===');
    
    // Check if storage manager is initialized
    if (!storageManager) {
      console.error('Storage manager not initialized!');
      alert('Storage system not ready. Please refresh the page.');
      return;
    }
    
    if (!storageManager.adapter) {
      console.error('Storage adapter not initialized!');
      alert('Storage adapter not ready. Please refresh the page.');
      return;
    }
    
    console.log('1. Exporting data...');
    const data = await exportData();
    console.log('Data exported:', data);
    
    console.log('2. Creating hash...');
    const hash = await hashData(data);
    console.log('Hash created:', hash);
    
    const doc = {
      version: 1,
      updatedAt: new Date().toISOString(),
      hash: hash,
      payload: data
    };
    
    console.log('3. Document prepared:', doc);
    
    console.log('4. Pushing to version history...');
    const versionMeta = await storageManager.pushVersion(doc);
    console.log('Version pushed:', versionMeta);
    
    console.log('5. Saving current data...');
    await storageManager.saveCurrent(doc);
    storageManager.lastHash = hash;
    
    console.log('6. Reloading history list...');
    await loadHistoryList();
    
    console.log('=== Checkpoint created successfully! ===');
  } catch (e) {
    console.error('Failed to create checkpoint:', e);
    alert('Failed to create checkpoint: ' + e.message);
  }
}

async function clearAllHistory() {
  if (!confirm('Are you sure you want to clear all version history? This cannot be undone.')) {
    return;
  }
  
  try {
    await storageManager.clearAll();
    await loadHistoryList();
    alert('History cleared successfully!');
  } catch (e) {
    console.error('Failed to clear history:', e);
    alert('Failed to clear history');
  }
}
function toggleAutosave(enabled) {
  if (!storageManager) {
    console.error('Storage manager not available for toggle');
    return;
  }
  
  storageManager.autosaveEnabled = enabled;
  
  if (enabled) {
    storageManager.startAutosaveInterval();
    console.log('Autosave enabled');
  } else {
    storageManager.stopAutosaveInterval();
    console.log('Autosave disabled');
  }
  
  // Save the preference
  if (db.settings) {
    db.settings.autosaveEnabled = enabled;
    localStorage.setItem('crm_autosave_enabled', enabled.toString());
  }
}

// Test function to check storage status
function testStorage() {
  console.log('=== Testing Storage ===');
  console.log('Storage manager:', storageManager);
  if (storageManager) {
    console.log('Storage adapter:', storageManager.adapter);
    console.log('Autosave enabled:', storageManager.autosaveEnabled);
  }
  
  // Test if we can access localStorage
  try {
    localStorage.setItem('test', 'test');
    localStorage.removeItem('test');
    console.log('✅ localStorage works');
  } catch (e) {
    console.error('❌ localStorage failed:', e);
  }
  
  // Test if we can access IndexedDB
  if (window.indexedDB) {
    console.log('✅ IndexedDB available');
  } else {
    console.log('❌ IndexedDB not available');
  }
}
</script>
</body>
</html>
